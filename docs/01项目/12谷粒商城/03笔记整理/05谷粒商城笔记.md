## 谷粒商城的环境搭建(一)

谷粒商城是尚硅谷推出的全栈视频，没有相应的课件，整好自己动手整理一下，然后上传到码云上，架构图如下：

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIxNTQzNjA1NS0xODQ2NDY4OS5wbmc)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIxNTUyMDg2NC0yMDA5MTAwNzg3LnBuZw)

准备了一台服务器，放在家里，通过ksa可以进行远程访问，配置如下：

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIxNTY0Mjc1Ny0yNzE4NTU4MzcucG5n)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIxNTY1NDQ4My0yMDUzNTkwNTYucG5n)

 现在做的工作是把k8s和kubesphere部署好了，这个到后面再写，Win10可以放nexus等等。

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIyNDA1ODA2NS0yMzY0ODg5ODAucG5n)

现在服务器上安装docker，192.168.1.117,在配置阿里云镜像加速

官网可以查看：https://docs.docker.com/engine/install/centos/

**08、环境-linux安装docker**

```
[root@topcheer harbor]# yum remove docker                   docker-client                   docker-client-latest                   docker-common                   docker-latest                   docker-latest-logrotate                   docker-logrotate                   docker-selinux                   docker-engine-selinux                   docker-engine
已加载插件：fastestmirror, langpacks
参数 docker-client-latest 没有匹配
参数 docker-latest 没有匹配
参数 docker-latest-logrotate 没有匹配
参数 docker-logrotate 没有匹配
参数 docker-engine 没有匹配
正在解决依赖关系
--> 正在检查事务
---> 软件包 container-selinux.noarch.2.2.107-3.el7 将被 删除
---> 软件包 docker.x86_64.2.1.13.1-103.git7f2769b.el7.centos 将被 删除
---> 软件包 docker-client.x86_64.2.1.13.1-103.git7f2769b.el7.centos 将被 删除
---> 软件包 docker-common.x86_64.2.1.13.1-103.git7f2769b.el7.centos 将被 删除
--> 解决依赖关系完成

依赖关系解决

=====================================================================================================================================================
 Package                             架构                     版本                                                   源                         大小
=====================================================================================================================================================
正在删除:
 container-selinux                   noarch                   2:2.107-3.el7                                          @extras                    40 k
 docker                              x86_64                   2:1.13.1-103.git7f2769b.el7.centos                     @extras                    65 M
 docker-client                       x86_64                   2:1.13.1-103.git7f2769b.el7.centos                     @extras                    13 M
 docker-common                       x86_64                   2:1.13.1-103.git7f2769b.el7.centos                     @extras                   4.4 k

事务概要
=====================================================================================================================================================
移除  4 软件包

安装大小：77 M
是否继续？[y/N]：y
Downloading packages:
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  正在删除    : 2:docker-1.13.1-103.git7f2769b.el7.centos.x86_64                                                                                 1/4
警告：/etc/sysconfig/docker-storage 已另存为 /etc/sysconfig/docker-storage.rpmsave
  正在删除    : 2:docker-client-1.13.1-103.git7f2769b.el7.centos.x86_64                                                                          2/4
  正在删除    : 2:docker-common-1.13.1-103.git7f2769b.el7.centos.x86_64                                                                          3/4
  正在删除    : 2:container-selinux-2.107-3.el7.noarch                                                                                           4/4
  验证中      : 2:docker-common-1.13.1-103.git7f2769b.el7.centos.x86_64                                                                          1/4
  验证中      : 2:docker-1.13.1-103.git7f2769b.el7.centos.x86_64                                                                                 2/4
  验证中      : 2:container-selinux-2.107-3.el7.noarch                                                                                           3/4
  验证中      : 2:docker-client-1.13.1-103.git7f2769b.el7.centos.x86_64                                                                          4/4

删除:
  container-selinux.noarch 2:2.107-3.el7                                    docker.x86_64 2:1.13.1-103.git7f2769b.el7.centos
  docker-client.x86_64 2:1.13.1-103.git7f2769b.el7.centos                   docker-common.x86_64 2:1.13.1-103.git7f2769b.el7.centos

完毕！
[root@topcheer harbor]# yum install -y yum-utils
已加载插件：fastestmirror, langpacks
Loading mirror speeds from cached hostfile
 * base: mirrors.tuna.tsinghua.edu.cn
 * extras: mirrors.tuna.tsinghua.edu.cn
 * updates: mirrors.tuna.tsinghua.edu.cn
正在解决依赖关系
--> 正在检查事务
---> 软件包 yum-utils.noarch.0.1.1.31-50.el7 将被 升级
---> 软件包 yum-utils.noarch.0.1.1.31-52.el7 将被 更新
--> 解决依赖关系完成

依赖关系解决

[root@topcheer harbor]# yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
已加载插件：fastestmirror, langpacks
adding repo from: https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
grabbing file https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo to /etc/yum.repos.d/docker-ce.repo
repo saved to /etc/yum.repos.d/docker-ce.repo
[root@topcheer harbor]# yum list docker-ce --showduplicates|sort -r
已加载插件：fastestmirror, langpacks
可安装的软件包
 * updates: mirrors.tuna.tsinghua.edu.cn
Loading mirror speeds from cached hostfile
 * extras: mirrors.tuna.tsinghua.edu.cn
docker-ce.x86_64            3:19.03.4-3.el7                     docker-ce-stable
docker-ce.x86_64            3:19.03.3-3.el7                     docker-ce-stable
docker-ce.x86_64            3:19.03.2-3.el7                     docker-ce-stable
.....


[root@topcheer harbor]# yum install docker-ce-17.06.2.ce-1.el7.centos
已加载插件：fastestmirror, langpacks
Loading mirror speeds from cached hostfile
 * base: mirrors.tuna.tsinghua.edu.cn
 * extras: mirrors.tuna.tsinghua.edu.cn
 * updates: mirrors.tuna.tsinghua.edu.cn
正在解决依赖关系
--> 正在检查事务
---> 软件包 docker-ce.x86_64.0.17.06.2.ce-1.el7.centos 将被 安装
--> 正在处理依赖关系 container-selinux >= 2.9，它被软件包 docker-ce-17.06.2.ce-1.el7.centos.x86_64 需要
--> 正在检查事务
---> 软件包 container-selinux.noarch.2.2.107-3.el7 将被 安装
--> 解决依赖关系完成　　
```

在配置阿里云加速，此处为以前的笔记

**09、环境-配置docker阿里云镜像加速**

```
[root@topcheer ~]# systemctl start docker
[root@topcheer ~]# mkdir -p /etc/docker
[root@topcheer ~]# vim  /etc/docker/daemon.json   #配置阿里云镜像加速
[root@topcheer ~]# systemctl daemon-reload  #加载配置文件
[root@topcheer ~]# systemctl restart docker  #重启
[root@topcheer ~]#
```

**10、环境-docker安装mysql**　

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIyMjYzOTExNi0xOTY2OTQyNDA4LnBuZw)

 查看配置文件

```
[root@localhost mysql]# cd conf/
[root@localhost conf]# ll
total 4
-rw-r--r--. 1 root root 281 May 24 09:19 my.cnf
[root@localhost conf]# cat my.cnf
[client]
default-character-set=utf8

[mysql]
default-character-set=utf8

[mysqld]
init_connect='set collation_connection=utf8_unicode_ci'
init_connect='SET NAMES utf8'
character-set-server=utf8
collation-server=utf8_unicode_ci
skip-character-set-client-handshake
skip-name-resolve
[root@localhost conf]#
[root@localhost ~]# docker images
REPOSITORY                             TAG                 IMAGE ID            CREATED             SIZE
mysql                                  5.7                 a4fdfd462add        3 days ago          448MB
quay.io/openebs/provisioner-localpv    1.5.0               73d1ddefdddb        5 months ago        62.2MB
quay.io/openebs/admission-server       1.5.0               1bd4847011cc        5 months ago        194MB
quay.io/openebs/snapshot-provisioner   1.5.0               1900bbdb7100        5 months ago        76.2MB
[root@localhost ~]# docker run -p 3306:3306 --name mysql --privileged=true -v /mydata/mysql/conf:/etc/mysql/conf.d -v /mydata/mysql/logs:/logs -v /mydata/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root -d a4fdfd462add
4dd3eda0035b755dc6a2b0b241733c5b454442ae0f19929f1494611397dd6969
[root@localhost ~]# docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                               NAMES
4dd3eda0035b        a4fdfd462add        "docker-entrypoint.s…"   7 seconds ago       Up 5 seconds        0.0.0.0:3306->3306/tcp, 33060/tcp   mysql
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIyMjc0NDM3MC04MjkyMzYyNDAucG5n)

 ***\*11、环境-docker安装redis\****

```
[root@localhost conf]# docker pull redis
Using default tag: latest
latest: Pulling from library/redis
afb6ec6fdc1c: Already exists
608641ee4c3f: Pull complete
668ab9e1f4bc: Pull complete
ea9ab8bf5f73: Pull complete
137e0d1a14d9: Pull complete
b2c5e1be4a59: Pull complete
Digest: sha256:89051d5ec46a89d4a708467af38eaaf4029450c4b1b9835ffd413cf70625b22e
Status: Downloaded newer image for redis:latest
docker.io/library/redis:latest
[root@localhost conf]# mkdir -p /mydata/redis/conf
[root@localhost conf]# touch /mydata/redis/conf/redis.conf
[root@localhost conf]# docker run -p 6379:6379 --privileged=true -v /mydata/redis/data:/data -v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf  -d redis redis-server /etc/redis/redis.conf
961ab799c1fef33a0e5cf3e7d9f52a68c843092c3520c9d2534ff17639a1efd0
[root@localhost conf]# docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                               NAMES
961ab799c1fe        redis               "docker-entrypoint.s…"   6 seconds ago       Up 4 seconds        0.0.0.0:6379->6379/tcp              focused_kirch
4dd3eda0035b        a4fdfd462add
[root@localhost conf]# docker exec -it focused_kirch redis-cli
127.0.0.1:6379> set aa bb
OK
127.0.0.1:6379> get aa
"bb"
127.0.0.1:6379> exit
[root@localhost conf]# docker restart focused_kirch
focused_kirch
[root@localhost conf]# docker exec -it focused_kirch redis-cli
127.0.0.1:6379> get aa
"bb"
127.0.0.1:6379> exit
[root@localhost conf]# ll
total 4
-rw-r--r--. 1 root root 15 May 24 09:34 redis.conf
[root@localhost conf]# cat redis.conf
appendonly yes
[root@localhost conf]#
```

***\*12、环境-开发工具&环境安装配置\****　　

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIyMzM1MTg3NC0yMDYwNTY1Njg2LnBuZw)

 配置

```
<profile>
		<id>jdk1.8</id>
		<activation>
			<activeByDefault>true</activeByDefault>
			<jdk>1.8</jdk>
		</activation>
		<properties>
			<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
			<maven.compiler.source>1.8</maven.compiler.source>
			<maven.compiler.target>1.8</maven.compiler.target>
			<maven.compiler.compilerVersion>1.8</maven.compiler.compilerVersion>
		</properties>
	</profile>
<mirror>
		<id>alimaven</id>
		<name>aliyun maven</name>
		<url>http://maven.aliyun.com/nexus/content/groups/public/</url>
		<mirrorOf>central</mirrorOf>  
	</mirror>    
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIyMzY0OTEzMS0xNDM4MzQ1NjMucG5n)

 VSCODE安装插件

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIyMzcxMjc5MC0xMDcwMDgyODk0LnBuZw)

## 谷粒商城的环境搭建(二)

**13、环境-配置git-ssh**

```
asus@WGR-PC MINGW64 ~/Desktop
$ git config --global user.name "dalianpai"

asus@WGR-PC MINGW64 ~/Desktop
$ git config --global user.email "332574835@qq.com"

asus@WGR-PC MINGW64 ~/Desktop
$ ssh-keygen -t rsa -C   "332574835@qq.com"
Generating public/private rsa key pair.
Enter file in which to save the key (/c/Users/asus/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /c/Users/asus/.ssh/id_rsa.
Your public key has been saved in /c/Users/asus/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:kutkyCtkB6fNbWIByTZMoHxllnzI4G7wUvNPiIGemdg 332574835@qq.com
The key's randomart image is:
+---[RSA 2048]----+
|.=.o++o          |
|o X += .         |
|.= O  .          |
|o.@ B ..         |
|.*E@ =o.S        |
|  *.*.=o         |
| o ooo+.         |
|  .  =           |
|   .. .          |
+----[SHA256]-----+

asus@WGR-PC MINGW64 ~/Desktop
$ cat ~/.ssh/id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCoHYvQVmRagnW0XX/9qL65dJt1GDA9cmdtDiTWC/1ayuuRU378ASZQpI8sBWq+vxokjp9Ej8LTiOc65CYoiYf0xZU7nnWhcpuyNBgoXKm3wpFSD8L1fljtOBhX1qtRZlqbgsSDELfVrqcg/3eB/9RtH6RL37NRkVmd0wjbwgcIn7OAT9eo+pBBxmvlLTNMwwAviNqUgc606jtlwkUIEIDqEVfSw7RudpcjcOMoFFbItcuQY4HMNW9PIA70WkXj1c72TYarbO9q57G19s+nBKvBmpq7ykS/l2cE6QL0Ts6EvQogdtOKolvCZhZgw3kKEw/iwsFxwucNQAX7j2WN4xMn 332574835@qq.com

asus@WGR-PC MINGW64 ~/Desktop
$ ssh -T git@gitee.com
The authenticity of host 'gitee.com (212.64.62.174)' can't be established.
ECDSA key fingerprint is SHA256:FQGC9Kn/eye1W8icdBgrQp+KkGYoFgbVr17bmjey0Wc.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'gitee.com,212.64.62.174' (ECDSA) to the list of known hosts.
Hi dalianpai! You've successfully authenticated, but GITEE.COM does not provide shell access.
```

　![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIzMDUxNjAxNy0xMzc3MjQ5NTg1LnBuZw)

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIzMTEzNTQ3MS0xNjQ2NzA1NDkyLnBuZw)

 Idea导入项目

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNDIzMTQ0NTg1NS0xMDY0NzAxNzkucG5n)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTE0MTE0OTIwMi0xMzIwNTI3NjU4LnBuZw)

 忽略不必要的文件

```
**/mvnw
**/mvnw.cmd

**/.mvn
**/target
.idea

**/.gitignore　　
```

 然后提交到码云上

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTE0MTQzMDU4NC00NjI0NzQ2ODUucG5n)

 

 

 **15、环境-数据库初始化**

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTE0MTczNTMzOS0xODgzMDg5NDc1LnBuZw)

 安装博客，可以看https://www.cnblogs.com/dalianpai/p/12956462.html

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTE0MTc0NzU2NC0xNzI0MjAzMjU2LnBuZw)

 设置mysql和redis自启动

```
[root@localhost ~]# docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                               NAMES
961ab799c1fe        redis               "docker-entrypoint.s…"   16 hours ago        Up 16 hours         0.0.0.0:6379->6379/tcp              focused_kirch
4dd3eda0035b        a4fdfd462add        "docker-entrypoint.s…"   17 hours ago        Up 17 hours         0.0.0.0:3306->3306/tcp, 33060/tcp   mysql
[root@localhost ~]# docker update focused_kirch  --restart=always
focused_kirch
[root@localhost ~]# docker update mysql  --restart=always
mysql
[root@localhost ~]#
```

## 谷粒商城的快速开发(三)

 ***\*16、快速开发-人人开源搭建后台管理系统\****

安装node换镜像

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTE1NTYzMjEwNS0xNzQ2OTc3NzM3LnBuZw)

 加入Idea，然后启动

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTE1NTgzMTc5OS0zNDQzMTY3MDgucG5n)

 从Git上拉取代码

```
asus@WGR-PC MINGW64 ~/Desktop
$ git clone https://gitee.com/renrenio/renren-fast.git
Cloning into 'renren-fast'...
remote: Enumerating objects: 1764, done.
remote: Counting objects: 100% (1764/1764), done.
remote: Compressing objects: 100% (881/881), done.
remote: Total 1764 (delta 853), reused 1553 (delta 724), pack-reused 0
Receiving objects: 100% (1764/1764), 2.80 MiB | 396.00 KiB/s, done.
Resolving deltas: 100% (853/853), done.

asus@WGR-PC MINGW64 ~/Desktop
$ git clone https://gitee.com/renrenio/renren-fast-vue.git
Cloning into 'renren-fast-vue'...
remote: Enumerating objects: 2169, done.
remote: Counting objects: 100% (2169/2169), done.
remote: Compressing objects: 100% (1019/1019), done.
remote: Total 2169 (delta 1113), reused 2045 (delta 1036), pack-reused 0
Receiving objects: 100% (2169/2169), 9.28 MiB | 954.00 KiB/s, done.
Resolving deltas: 100% (1113/1113), done.

asus@WGR-PC MINGW64 ~/Desktop
$ git clone https://gitee.com/renrenio/renren-generator.git
Cloning into 'renren-generator'...
remote: Enumerating objects: 437, done.
remote: Counting objects: 100% (437/437), done.
remote: Compressing objects: 100% (286/286), done.
remote: Total 437 (delta 156), reused 361 (delta 117), pack-reused 0
Receiving objects: 100% (437/437), 1.05 MiB | 352.00 KiB/s, done.
Resolving deltas: 100% (156/156), done.

asus@WGR-PC MINGW64 ~/Desktop
```

　用VsCode打开前端项目，安装模块　

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTE1MzY1NDQxMS0xMzYzMzgxODU4LnBuZw)

 期间启动报错，需要执行

```
npm uninstall node-sass
npm i node-sass --sass_binary_site=https://npm.taobao.org/mirrors/node-sass/
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTE2MjgyMDEzMy0xMzQ1NzI0NDEyLnBuZw)

 

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTE2MzAwNDAwNy0xMzUxMTk1NzAwLnBuZw)

 Idea启动后端项目，并修改数据库的链接信息

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTE2MzIzOTM1My03OTY0NzEzODYucG5n)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTE2MzMxODc1Ni0yODA4OTM0NjMucG5n)

 **17、快速开发-逆向工程搭建&使用**

拉取代码，修改数据配置信息，然后打开localhost

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTE2NDQ0NDQwMC0xNTM5OTExMTU2LnBuZw)

然后把代码放到模块下面

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTIyNTA0NTgzOS0yMTE0NTUxMzYyLnBuZw)

 然后把通用的抽取出来，建立一个新的maven模块

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNTIyNTIwNDIzMi0zNjcxNjM4NDkucG5n)

 主要是用R来返回数据，看完这个结构以后感觉没有我们项目中的结构好用，等项目跑起来，在根据自己的想法优化一下。

## 谷粒商城的快速开发(四)

**18、快速开发-配置&测试微服务基本CRUD功能**

**19、快速开发-逆向生成所有微服务基本CRUD代码**

 根据之前的博客，把代码抽取，然后把各个模块都建立一下，看了一下代码，感觉配置都很简单，后面再改，先按照教程的来。

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjEwNDE0OTIwOS05MTIzMDM5MTkucG5n)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjEwNDE1NDA3NS01OTc1MDI3NzEucG5n)

 下面就那这个模块做个实列：

```
spring:
  datasource:
    username: root
    password: root
    url: jdbc:mysql://192.168.1.117:3306/gulimall_pms
    driver-class-name: com.mysql.jdbc.Driver

##mybatisplus配置
mybatis-plus:
  #扫描xml文件
  mapper-locations: classpath:/mapper/**/*.xml
  #实体扫描，多个package用逗号或者分号分隔
  typeAliasesPackage: com.dalianpai.gulimall.product.entity
  global-config:
    id-type: 0
    #字段策略 0:"忽略判断",1:"非 NULL 判断"),2:"非空判断"
    field-strategy: 2
    #驼峰下划线转换
    db-column-underline: true
    #刷新mapper 调试神器
    refresh-mapper: true
    #数据库大写下划线转换
    #capital-mode: true
    #序列接口实现类配置
    #key-generator: com.baomidou.springboot.xxx
    db-config:
      logic-delete-value: 0
      logic-not-delete-value: 1
    #  key-generator:
    # db-config:
    #  key-generator:可能
    #db-config:     这个配置已经过时了
    #db-type: oracle
    #自定义SQL注入器 3.1.1版本以后不要加入
    #sql-injector: com.baomidou.mybatisplus.mapper.LogicSqlInjector
  configuration:
    #开启二级缓存
    cache-enabled: false
    jdbc-type-for-null: null　　
```

 测试类：

```
@SpringBootTest
class GulimallProductApplicationTests {

    @Autowired
    BrandService brandService;


    @Autowired
    CategoryService categoryService;

    @Test
    void contextLoads() {
        List<BrandEntity> list = brandService.list(new QueryWrapper<BrandEntity>().eq("brand_id", 1L));
        list.forEach(System.out::println);
    }

}
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjEwNDk0MTQ4OC0xMTkxNTQyODYzLnBuZw)

 但是没有显示sql，先配置一下。

```
spring:
  datasource:
    username: root
    password: root
    # url: jdbc:mysql://192.168.1.117:3306/gulimall_pms
    #driver-class-name: com.mysql.jdbc.Driver
    driver-class-name: com.p6spy.engine.spy.P6SpyDriver
    url: jdbc:p6spy:mysql://192.168.1.117:3306/gulimall_pms　　
```

在common里面引入p6spy

在product下面加入配置文件spy.properties　　

```
#3.2.1以上使用
#modulelist=com.baomidou.mybatisplus.extension.p6spy.MybatisPlusLogFactory,com.p6spy.engine.outage.P6OutageFactory
#3.2.1以下使用或者不配置
modulelist=com.p6spy.engine.logging.P6LogFactory,com.p6spy.engine.outage.P6OutageFactory
# 自定义日志打印
#logMessageFormat=com.baomidou.mybatisplus.extension.p6spy.P6SpyLogger
logMessageFormat=com.p6spy.engine.spy.appender.CustomLineFormat
customLogMessageFormat=%(executionTime)ms | %(sqlSingleLine)
#日志输出到控制台
#appender=com.baomidou.mybatisplus.extension.p6spy.StdoutLogger
# 使用日志系统记录 sql
appender=com.p6spy.engine.spy.appender.Slf4JLogger
# 设置 p6spy driver 代理
deregisterdrivers=true
# 取消JDBC URL前缀
useprefix=true
# 配置记录 Log 例外,可去掉的结果集有error,info,batch,debug,statement,commit,rollback,result,resultset.
excludecategories=info,debug,result,commit,resultset
# 日期格式
dateformat=yyyy-MM-dd HH:mm:ss
# 实际驱动可多个
#driverlist=org.h2.Driver
# 是否开启慢SQL记录
outagedetection=true
# 慢SQL记录标准 2 秒
outagedetectioninterval=2
2020-05-26 11:15:53.111  INFO 4308 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...
2020-05-26 11:15:56.455  INFO 4308 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2020-05-26 11:15:56.531  INFO 4308 --- [           main] p6spy                                    : 38ms | SELECT  brand_id,name,logo,show_status,sort,descript,first_letter  FROM pms_brand     WHERE (brand_id = 1)
BrandEntity(brandId=1, name=null, logo=e'e, descript=e, showStatus=null, firstLetter=null, sort=null)

2020-05-26 11:15:56.581  INFO 4308 --- [extShutdownHook] o.s.s.concurrent.ThreadPoolTaskExecutor  : Shutting down ExecutorService 'applicationTaskExecutor'
2020-05-26 11:15:56.586  INFO 4308 --- [extShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown initiated...
2020-05-26 11:15:57.026  INFO 4308 --- [extShutdownHook] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Shutdown completed.
```

## 谷粒商城Nacos配置(五)

**20、分布式组件-SpringCloud Alibaba简介**

它的介绍和安装参考之前写的博客:https://www.cnblogs.com/dalianpai/p/12764527.html

***\*21、分布式组件-SpringCloud Alibaba-Nacos注册中心\****

充当组成中心的可以参考这篇博客：https://www.cnblogs.com/dalianpai/p/12764527.html

注册的效果如下：

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjEyNTIzNjI0OC0xNTI4NDUyODIyLnBuZw)

***\*22、分布式组件-SpringCloud-OpenFeign测试远程调用\****

在coupon模块下面建一个测试方法

***\*![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjE0MDIzNDE2MC0xMTg4NzQ1OTYwLnBuZw)\****

 在product模块下面

```
/**
 * @author WGR
 * @create 2020/5/26 -- 13:32
 */
@FeignClient("gulimall-coupon")
public interface CouponFeignService {

    @RequestMapping("/coupon/coupon/member/list")
    public R membercoupons();
}
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjE0MDM0OTk1Ny0yMDgzOTU2Nzc5LnBuZw)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjE0MDQyNjAwNy04MzExNDcxMTMucG5n)

 进行调用和测试。

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjE0MDUxOTYyMC0xMzU4Mzc5MTc1LnBuZw)

## 谷粒商城Nacos配置(六)

**23、分布式组件-SpringCloud Alibaba-Nacos配置中心-简单示例**

**24、分布式组件-SpringCloud Alibaba-Nacos配置中心-命名空间与配置分组**

**25、分布式组件-SpringCloud Alibaba-Nacos配置中心-加载多配置集**

Nacos当配置中心可以查看之前写的博客：https://www.cnblogs.com/dalianpai/p/12772152.html

建立3个命名空间

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjE0NTIzOTk2Ny04Nzk4MDY3MTkucG5n)

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjE0NTMyMjgwNS0xNTQzMDI2MjQ5LnBuZw)

 然后创建bootstarp.yml

```
spring:
  application:
    name: gulimall-coupon
  cloud:
    nacos:
      config:
        file-extension: properties
        server-addr: 192.168.1.118:8848
        namespace: da7e2ec1-7b75-460d-b557-f762590890ec
        group: dev
        ext-config:
          - data-id: mybatisplus.yml
            group: dev
            refresh: true
          - data-id: datasource.yml
            group: dev
            refresh: true
          - data-id: other.yml
            group: dev
            refresh: true　　
```

在创建一个测试的properties

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjE1MjkyMDQ3MS01NzkyNDkxNDIucG5n)

 

 

 添加测试方法

```
@RefreshScope
@RestController
@RequestMapping("coupon/coupon")
public class CouponController {
    @Autowired
    private CouponService couponService;

    @Value("${user.name}")
    private String name;

    @RequestMapping("/test")
    public R test(){
        return R.ok().put("name",name);
    }　　
```

加载信息

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjE1MzAxNDg4Ny05NzYzODY3MjUucG5n)

 进行接口测试

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjE1MzA0MjkxMy0xNzcyMjQwNjI2LnBuZw)

## 谷粒商城网关服务建立(七)

**26、分布式组件-SpringCloud-Gateway网关核心概念&原理**

**27、分布式组件-SpringCloud-Gateway-创建&测试API网关**

视频中这2节讲的比较浅，就是简单的介绍了一下，具体在后面用，之前也写过博客：https://www.cnblogs.com/dalianpai/p/12288456.html

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjIwNDUwNjgyNi03NTI5ODEyODkucG5n)

 排除数据源自动配置

```
@EnableDiscoveryClient
@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})
public class GulimallGatewayApplication {

    public static void main(String[] args) {
        SpringApplication.run(GulimallGatewayApplication.class, args);
    }

}　　
```

配置文件

```
spring:
  application:
    name: gulimall-gateway
  cloud:
    nacos:
      config:
        server-addr: 192.168.1.118:8848
        namespace: 9293a967-9ee0-412f-90f3-009de1e10426
        group: dev
        file-extension: yaml
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNjIwNTUwMDM4Mi04ODY4ODk3OTgucG5n)

##  谷粒商城商品服务API(八)

***\*29-44跳过，不会前端\****

```
F:\谷粒商城前端\vue-demo>vue init webpack vue-demo
'vue' 不是内部或外部命令，也不是可运行的程序
或批处理文件。

F:\谷粒商城前端\vue-demo>npm install -g @vue/cli-init
npm WARN deprecated vue-cli@2.9.6: This package has been deprecated in favour of @vue/cli
npm WARN deprecated coffee-script@1.12.7: CoffeeScript on NPM has moved to "coffeescript" (no hyphen)
+ @vue/cli-init@4.4.1
updated 2 packages in 16.692s

F:\谷粒商城前端\vue-demo>vue init webpack vue-demo
'vue' 不是内部或外部命令，也不是可运行的程序
或批处理文件。

F:\谷粒商城前端\vue-demo>npm install -g vue
+ vue@2.6.11
added 1 package from 1 contributor in 0.737s

F:\谷粒商城前端\vue-demo>vue init webpack vue-demo
'vue' 不是内部或外部命令，也不是可运行的程序
或批处理文件。

F:\谷粒商城前端\vue-demo>npm config list
; cli configs
metrics-registry = "https://registry.npm.taobao.org/"
scope = ""
user-agent = "npm/6.9.0 node/v10.16.0 win32 x64"

; userconfig C:\Users\asus\.npmrc
registry = "https://registry.npm.taobao.org/"

; builtin config undefined
prefix = "C:\\Users\\asus\\AppData\\Roaming\\npm"

; node bin location = D:\node\node.exe
; cwd = F:\谷粒商城前端\vue-demo
; HOME = C:\Users\asus
; "npm config ls -l" to show all defaults.


F:\谷粒商城前端\vue-demo>vue
'vue' 不是内部或外部命令，也不是可运行的程序
或批处理文件。

F:\谷粒商城前端\vue-demo>npm install -g vue
+ vue@2.6.11
updated 1 package in 0.673s

F:\谷粒商城前端\vue-demo>npm install -g  @vue/cli
npm WARN deprecated chokidar@2.1.8: Chokidar 2 will break on node v14+. Upgrade to chokidar 3 with 15x less dependencies.
C:\Users\asus\AppData\Roaming\npm\vue -> C:\Users\asus\AppData\Roaming\npm\node_modules\@vue\cli\bin\vue.js

> core-js@3.6.5 postinstall C:\Users\asus\AppData\Roaming\npm\node_modules\@vue\cli\node_modules\core-js
> node -e "try{require('./postinstall')}catch(e){}"

Thank you for using core-js ( https://github.com/zloirock/core-js ) for polyfilling JavaScript standard library!

The project needs your help! Please consider supporting of core-js on Open Collective or Patreon:
> https://opencollective.com/core-js
> https://www.patreon.com/zloirock

Also, the author of core-js ( https://github.com/zloirock ) is looking for a good job -)


> @apollo/protobufjs@1.0.4 postinstall C:\Users\asus\AppData\Roaming\npm\node_modules\@vue\cli\node_modules\@apollo\protobufjs
> node scripts/postinstall


> nodemon@1.19.4 postinstall C:\Users\asus\AppData\Roaming\npm\node_modules\@vue\cli\node_modules\nodemon
> node bin/postinstall || exit 0

Love nodemon? You can now support the project via the open collective:
 > https://opencollective.com/nodemon/donate


> ejs@2.7.4 postinstall C:\Users\asus\AppData\Roaming\npm\node_modules\@vue\cli\node_modules\ejs
> node ./postinstall.js

Thank you for installing EJS: built with the Jake JavaScript build tool (https://jakejs.com/)

npm WARN jscodeshift@0.9.0 requires a peer of @babel/preset-env@^7.1.6 but none is installed. You must install peer dependencies yourself.
npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@1.2.13 (node_modules\@vue\cli\node_modules\fsevents):
npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@1.2.13: wanted {"os":"darwin","arch":"any"} (current: {"os":"win32","arch":"x64"})

+ @vue/cli@4.4.1
added 1099 packages from 662 contributors in 84.531s

F:\谷粒商城前端\vue-demo>npm config list
; cli configs
metrics-registry = "https://registry.npm.taobao.org/"
scope = ""
user-agent = "npm/6.9.0 node/v10.16.0 win32 x64"

; userconfig C:\Users\asus\.npmrc
registry = "https://registry.npm.taobao.org/"

; builtin config undefined
prefix = "C:\\Users\\asus\\AppData\\Roaming\\npm"

; node bin location = D:\node\node.exe
; cwd = F:\谷粒商城前端\vue-demo
; HOME = C:\Users\asus
; "npm config ls -l" to show all defaults.


F:\谷粒商城前端\vue-demo>vue init webpack vue-demo

? Project name vue-demo
? Project description vue-demo
? Author
? Vue build standalone
? Install vue-router? Yes
? Use ESLint to lint your code? No
? Set up unit tests No
? Setup e2e tests with Nightwatch? No
? Should we run `npm install` for you after the project has been created? (recommended) npm

   vue-cli · Generated "vue-demo".


# Installing project dependencies ...
# ========================

npm WARN deprecated extract-text-webpack-plugin@3.0.2: Deprecated. Please use https://github.com/webpack-contrib/mini-css-extract-plugin
npm WARN deprecated browserslist@2.11.3: Browserslist 2 could fail on reading Browserslist >3.0 config used in other tools.
npm WARN deprecated bfj-node4@5.3.1: Switch to the `bfj` package for fixes and new features!
npm WARN deprecated chokidar@2.1.8: Chokidar 2 will break on node v14+. Upgrade to chokidar 3 with 15x less dependencies.
npm WARN deprecated core-js@2.6.11: core-js@<3 is no longer maintained and not recommended for usage due to the number of issues. Please, upgrade your dependencies to the actual version of core-js@3.
npm WARN deprecated browserslist@1.7.7: Browserslist 2 could fail on reading Browserslist >3.0 config used in other tools.

> core-js@2.6.11 postinstall F:\谷粒商城前端\vue-demo\vue-demo\node_modules\core-js
> node -e "try{require('./postinstall')}catch(e){}"

Thank you for using core-js ( https://github.com/zloirock/core-js ) for polyfilling JavaScript standard library!

The project needs your help! Please consider supporting of core-js on Open Collective or Patreon:
> https://opencollective.com/core-js
> https://www.patreon.com/zloirock

Also, the author of core-js ( https://github.com/zloirock ) is looking for a good job -)


> ejs@2.7.4 postinstall F:\谷粒商城前端\vue-demo\vue-demo\node_modules\ejs
> node ./postinstall.js

Thank you for installing EJS: built with the Jake JavaScript build tool (https://jakejs.com/)


> uglifyjs-webpack-plugin@0.4.6 postinstall F:\谷粒商城前端\vue-demo\vue-demo\node_modules\webpack\node_modules\uglifyjs-webpack-plugin
> node lib/post_install.js

npm notice created a lockfile as package-lock.json. You should commit this file.
npm WARN ajv-keywords@3.4.1 requires a peer of ajv@^6.9.1 but none is installed. You must install peer dependencies yourself.
npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@1.2.13 (node_modules\webpack-dev-server\node_modules\fsevents):
npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@1.2.13: wanted {"os":"darwin","arch":"any"} (current: {"os":"win32","arch":"x64"})
npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@1.2.13 (node_modules\watchpack-chokidar2\node_modules\fsevents):
npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@1.2.13: wanted {"os":"darwin","arch":"any"} (current: {"os":"win32","arch":"x64"})
npm WARN optional SKIPPING OPTIONAL DEPENDENCY: fsevents@2.1.3 (node_modules\fsevents):
npm WARN notsup SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@2.1.3: wanted {"os":"darwin","arch":"any"} (current: {"os":"win32","arch":"x64"})

added 1279 packages from 672 contributors in 115.446s

# Project initialization finished!
# ========================

To get started:

  cd vue-demo
  npm run dev

Documentation can be found at https://vuejs-templates.github.io/webpack



F:\谷粒商城前端\vue-demo>
```

***\*45-51三类分类的操作\****　

吸引人的有几点

1.父子节点的查找，一般都是sql进行递归，视频中是用方法查的，但是有部分代码相似

```
 @Override
    public List<CategoryEntity> listWithTree() {
        // 查出全部数据
        List<CategoryEntity> entities = categoryDao.selectList(null);
        //2、组装成父子的树形结构
        List<CategoryEntity> level1Menus = entities.stream().filter(categoryEntity ->
                categoryEntity.getParentCid() == 0
        ).map((menu)->{
            menu.setChildren(getChildrens(menu,entities));
            return menu;
        }).sorted(Comparator.comparing(CategoryEntity::getSort)).collect(Collectors.toList());
        return level1Menus;

    }

    /**
     * 说明：把主节点带进来，查到他的子节点的同时，再查出子节点的下面节点
     * @param root
     * @param all
     * @return
     */
    public List<CategoryEntity> getChildrens(CategoryEntity root,List<CategoryEntity> all){
        List<CategoryEntity> children = all.stream().filter(categoryEntity -> categoryEntity.getParentCid() == root.getCatId())
                .map(categoryEntity -> {
                    categoryEntity.setChildren(getChildrens(categoryEntity, all));
                    return categoryEntity;
                }).sorted(Comparator.comparing(CategoryEntity::getSort))
                .collect(Collectors.toList());
        return children;

    }
```

2.就是网关的配置，我之前博客也写过

```
spring:
  cloud:
    gateway:
      routes:
      - id: product
        uri: lb://gulimall-product
        predicates:
          - Path=/api/product/**
        filters:
          - RewritePath=/api/(?<segment>.*), /$\{segment}
      - id: admin_route
        uri: lb://renren-fast
        predicates:
          - Path=/api/**
        filters:
          - RewritePath=/api/(?<segment>.*), /renren-fast/$\{segment}
```

3.就是路由转发以后，会有跨域问题，我也写过转发过博客

https://www.cnblogs.com/dalianpai/p/12584811.html

https://www.cnblogs.com/dalianpai/p/12584789.html　　

https://www.cnblogs.com/dalianpai/p/12584960.html　　

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNzIxNDQzNDYzNy01MzEyNjI0NjcucG5n)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNzIyMDg0ODAwMS0yNzYxOTE4MDIucG5n)

```
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.reactive.CorsWebFilter;
import org.springframework.web.cors.reactive.UrlBasedCorsConfigurationSource;

/**
 * @author WGR
 * @create 2020/5/27 -- 21:54
 */
@Configuration
public class GulimallCorsConfiguration {

    @Bean
    public CorsWebFilter corsWebFilter(){
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();

        CorsConfiguration corsConfiguration = new CorsConfiguration();
        //1、配置跨域
        corsConfiguration.addAllowedHeader("*");
        corsConfiguration.addAllowedMethod("*");
        corsConfiguration.addAllowedOrigin("*");
        corsConfiguration.setAllowCredentials(true);
        source.registerCorsConfiguration("/**",corsConfiguration);
        return new CorsWebFilter(source);
    }
}　　
```

 mybatisplus的逻辑删除也比较简单，底层就是update方法，sql打印如下

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDUvMTgyOTc4NS0yMDIwMDUyNzIyNTc1OTEzMy0xMzE4MjY4MTM3LnBuZw)

## 谷粒商城品牌管理(九)

 ***\*61-64可以查看下面2篇博客\****

https://www.cnblogs.com/dalianpai/p/12984290.html

https://www.cnblogs.com/dalianpai/p/12984850.html

**65-66 JSR303校验和统一异常处理**

 JSR303得到了很好的学习的机会，统一异常处理的码值是通过枚举来实现的，也有一定的可取之处。

在common项目下引入jar包

```
    <dependency>
            <groupId>javax.validation</groupId>
            <artifactId>validation-api</artifactId>
            <version>2.0.1.Final</version>
        </dependency>

        <dependency>
            <groupId>org.hibernate.validator</groupId>
            <artifactId>hibernate-validator</artifactId>
            <version>6.1.2.Final</version>
        </dependency>
```

Bo类

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwMTIwMzQyNzg2NC05NTg3NzIxMDEucG5n)

 

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwMTIwMzUwMjI2NC0yMDI2ODk3NTA2LnBuZw)

 

 统一异常处理

```
/**
 * @author WGR
 * @create 2020/6/1 -- 19:49
 */
@Slf4j
@RestControllerAdvice("com.dalianpai.gulimall.product.controller")
public class GulimallExceptionControllerAdvice {

     @ExceptionHandler(value = MethodArgumentNotValidException.class)
     public R handleVaildException(MethodArgumentNotValidException e){
         log.info("数据校验出现问题{},异常类型:{}",e.getMessage(),e.getClass());

         BindingResult bindingResult = e.getBindingResult();
         Map<String, String> map = new HashMap<>();
         bindingResult.getFieldErrors().forEach((fieldError) ->{
             map.put(fieldError.getField(),fieldError.getDefaultMessage());
         } );
         return R.error(BizCodeEnume.VAILD_EXCEPTION.getCode(),BizCodeEnume.VAILD_EXCEPTION.getMessage()).put("data",map);
     }


    @ExceptionHandler(value = Throwable.class)
    public R handleException(Throwable throwable){
        log.error("错误：",throwable);
        return R.error(BizCodeEnume.UNKNOW_EXCEPTION.getCode(),BizCodeEnume.UNKNOW_EXCEPTION.getMessage());
    }
}　　
```

枚举类：

```
/**
 * @author WGR
 * @create 2020/6/1 -- 20:10
 */
public enum BizCodeEnume {

    UNKNOW_EXCEPTION(10000,"系统未知异常"),
    VAILD_EXCEPTION(10001,"参数格式校验失败");

    private int code;
    private String message;

    BizCodeEnume(int code, String message) {
        this.code = code;
        this.message = message;
    }

    public int getCode() {
        return code;
    }

    public String getMessage() {
        return message;
    }
}
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwMTIwMzk0NTIwMS01NDYyNDI3MzIucG5n)

## 谷粒商城品牌管理校验(十)

**68、商品服务-API-品牌管理-JSR303分组校验**

### JSR 303 分组校验

（1）为什么使用 分组校验？
　　通过上面的过程，可以了解到单个方法的校验规则。
　　如果出现多个方法，都需要校验 Bean，且校验规则不同的时候，怎么办呢？
　　分组校验就可以去解决该问题，每个分组指定不同的校验规则，不同的方法执行不同的分组，就可以得到不同的校验结果。

（2）基本认识
　　JSR 303 的每个注解都默认具备三个属性：
　　　　message 用来定义数据校验失败后的提示消息，默认读取配置文件的内容。
　　　　　　全局搜索 ValidationMessages.properties，可以看到默认的信息。

　　　　groups 用来定义分组，其是一个 class 数组，可以指定多个分组。

```
String message() default "{javax.validation.constraints.NotNull.message}";

Class<?>[] groups() default { };

Class<? extends Payload>[] payload() default { };
```

（3）使用分组步骤：
Step1：
　　定义一个空接口，用于指定分组，内部不需要任何实现。

Step2：
　　指定 注解时，通过 groups 指定分组。用于指定在某个分组条件下，才去执行校验规则。

Step3：
　　在相关的业务方法上，通过 @Validated 注解指定分组，去指定校验。
注：
　　使用分组校验后，Bean 注解上若不指定分组，则不会执行校验规则。

（4）使用：
Step1：
　　创建分组接口。
　　创建两个分组接口 AddGroup、UpdateGroup。
其中：
　　AddGroup 用于指定 添加数据 时的校验规则（比如：id、name 均不为 null）。
　　UpdateGroup 用于指定 修改数据 时的校验规则（比如：name 不允许为 null）。

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwMTIxMjI0ODUxNS0xOTM2MDUwNDEwLnBuZw)

Step2：
　　给 Bean 添加注解，并指定分组信息。

```
/**
 * 品牌
 * 
 * @author dalianpai
 * @email dalianpai@163.com
 * @date 2020-05-25 16:55:42
 */
@Data
@TableName("pms_brand")
public class BrandEntity implements Serializable {
	private static final long serialVersionUID = 1L;

	/**
	 * 品牌id
	 */
	@NotNull(message = "修改必须指定品牌id",groups = {UpdateGroup.class})
	@Null(message = "新增不能指定id",groups = {AddGroup.class})
	@TableId
	private Long brandId;
	/**
	 * 品牌名
	 */
	@NotBlank(message = "品牌名必须提交",groups = {AddGroup.class,UpdateGroup.class})
	private String name;
	/**
	 * 品牌logo地址
	 */
	@NotBlank(groups = {AddGroup.class})
	@URL(message = "logo必须是一个合法的url地址",groups={AddGroup.class,UpdateGroup.class})
	private String logo;
	/**
	 * 介绍
	 */
	private String descript;
	/**
	 * 显示状态[0-不显示；1-显示]
	 */
//	@Pattern()
	@NotNull(groups = {AddGroup.class, UpdateStatusGroup.class})
	private Integer showStatus;
	/**
	 * 检索首字母
	 */
	@NotEmpty(groups={AddGroup.class})
	@Pattern(regexp="^[a-zA-Z]$",message = "检索首字母必须是一个字母",groups={AddGroup.class, UpdateGroup.class})
	private String firstLetter;
	/**
	 * 排序
	 */
	@NotNull(groups={AddGroup.class})
	@Min(value = 0,message = "排序必须大于等于0",groups={AddGroup.class,UpdateGroup.class})
	private Integer sort;

}
```

Step3：
　　在业务方法上，通过 @Validated 注解指定分组，去指定校验。
如下例，定义两个方法，Post 请求会触发 createEmp 方法，Put 请求会触发 UpdateEmp 方法。

```
 /**
   * 保存
   */
  @RequestMapping("/save")
  public R save(@Validated({AddGroup.class}) @RequestBody BrandEntity brand){
     brandService.save(brand);
      return R.ok();
  }

  /**
   * 修改
   */
  @RequestMapping("/update")
  public R update(@Validated(UpdateGroup.class) @RequestBody BrandEntity brand){
brandService.updateById(brand);

      return R.ok();
  }
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwMTIxMjQxMzA3MC0xMjE3Njg1OTAyLnBuZw)

Step4：
　　使用 Postman 测试

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwMTIxMjg1NDMzNC00NzE3OTMwMDYucG5n)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwMTIxMjg0MDY0MS0xOTA0NDc5MTQ4LnBuZw)

## 谷粒商城品牌管理校验(十一)

**69、商品服务-API-品牌管理-JSR303自定义校验注解**

### JSR 303 自定义校验注解

（1）为什么使用自定义校验注解？
　　上面的注解满足不了业务需求时，可以自定义校验注解，自定义校验规则。

（2）步骤：
Step1：
　　需要自定义一个校验注解。
　　可以创建一个 ValidationMessages.properties 用于保存默认的 message 信息。

Step2：
　　需要自定义一个校验器，即自定义校验规则。
　　实现 ConstraintValidator 接口，并重写相关方法。
注：
　　initialize 方法用于初始化，可以获取 自定义的属性的值。
　　isValid 方法用于校验，可以获取到实际的值，然后与自定义的属性值进行比较。

Step3：
　　将校验注解 与 校验器 关联起来。
　　@Constraint(validatedBy = {TestValidConstraintValidator.class})

（3）使用：
　　如下例，自定义一个校验规则，判断数据长度是否合法。
　　默认为 String 属性，当 String 为 Null 或者 长度大于 5 时，校验不通过。
　　可以自定义 长度。
Step1：
　　自定义一个校验注解，@ListValue，用于判断是否指定的值。

```
/**
 * @author WGR
 * @create 2020/6/1 -- 21:34
 */
@Documented
@Constraint(validatedBy = { ListValueConstraintValidator.class })
@Target({ METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER, TYPE_USE })
@Retention(RUNTIME)
public @interface ListValue {
    String message() default "{com.dalianpai.common.valid.ListValue.message}";

    Class<?>[] groups() default { };

    Class<? extends Payload>[] payload() default { };

    int[] vals() default { };
}
```

配置文件内容：

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwMTIxNDAwOTQwNS0xMTU1NzE0MzA2LnBuZw)

Step2：
　　自定义一个校验器ListValueConstraintValidator， 用于检测值是否合法。

```
/**
 * @author WGR
 * @create 2020/6/1 -- 21:35
 */
public class ListValueConstraintValidator implements ConstraintValidator<ListValue,Integer> {

    private Set<Integer> set = new HashSet<>();
    //初始化方法
    @Override
    public void initialize(ListValue constraintAnnotation) {

        int[] vals = constraintAnnotation.vals();
        for (int val : vals) {
            set.add(val);
        }

    }

    //判断是否校验成功

    /**
     *
     * @param value 需要校验的值
     * @param context
     * @return
     */
    @Override
    public boolean isValid(Integer value, ConstraintValidatorContext context) {

        return set.contains(value);
    }
}
```

Step3：
　　使用注解。

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwMTIxNDIyOTI4NS0xNTE0NDgzNDc4LnBuZw)

使用 Postman 测试。
![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwMTIxNDM0NDAxMS0yMDAyOTYyMjQxLnBuZw)

## 谷粒商城建立多租户(十二)

**353、kubesphere-进阶-建立多租户系统**

我按照视频建好了5个角色，视频中也是参考官网的，所以就直接官网复制过来，加深点印象

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwNDIzMDM0MTUwOS02NDIyODEyMTAucG5n)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwNDIzMDgzMzYxOS04NjM0NTk3NzAucG5n)

 

 

目前，平台的资源一共有三个层级，包括 集群 (Cluster)、 企业空间 (Workspace)、 项目 (Project) 和 DevOps Project (DevOps 工程)，层级关系如下图所示，即一个集群中可以创建多个企业空间，而每个企业空间，可以创建多个项目和 DevOps工程，而集群、企业空间、项目和 DevOps工程中，默认有多个不同的内置角色。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNjAwNDgxMy5wbmc)

### 集群管理员

#### 第一步：创建角色和账号

平台中的 cluster-admin 角色可以为其他用户创建账号并分配平台角色，平台内置了集群层级的以下三个常用的角色，同时支持自定义新的角色。

| 内置角色           | 描述                                                         |
| :----------------- | :----------------------------------------------------------- |
| cluster-admin      | 集群管理员，可以管理集群中所有的资源。                       |
| workspaces-manager | 集群中企业空间管理员，仅可创建、删除企业空间，维护企业空间中的成员列表。 |
| cluster-regular    | 集群中的普通用户，在被邀请加入企业空间之前没有任何资源操作权限。 |

本示例首先新建一个角色 (users-manager)，为该角色授予账号管理和角色管理的权限，然后新建一个账号并给这个账号授予 users-manager 角色。

| 账号名       | 集群角色      | 职责                 |
| :----------- | :------------ | :------------------- |
| user-manager | users-manager | 管理集群的账户和角色 |

通过下图您可以更清楚地了解本示例的逻辑： ![img](img/aHR0cHM6Ly9oZWxsby13b3JsZC0yMDE4MTIxOS5wZWszYi5xaW5nc3Rvci5jb20vS1MyLjEvJUU1JUE0JTlBJUU3JUE3JTlGJUU2JTg4JUI3JUU3JUFFJUExJUU3JTkwJTg2JUU1JUJGJUFCJUU5JTgwJTlGJUU1JTg1JUE1JUU5JTk3JUE4LnBuZw)

1.1. 点击控制台左上角 平台管理 → 平台角色，可以看到当前的角色列表，点击 创建，创建一个角色用于管理所有账户和角色。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE0NDMxNC5wbmc)

1.2. 填写角色的基本信息和权限设置。

- 名称：起一个简洁明了的名称，便于用户浏览和搜索，如 `users-manager`
- 描述信息：简单介绍该角色的职责，如 `管理账户和角色`

1.3. 权限设置中，勾选账户管理和角色管理的所有权限，点击 创建，自定义的用户管理员的角色创建成功。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE0NDQ0MS5wbmc)

1.4. 点击控制台左上角 平台管理 → 账户管理，可以看到当前集群中所有用户的列表，点击 创建 按钮。

1.5. 填写新用户的基本信息，如用户名设置为 `user-manager`，角色选择 `users-manager`，其它信息可自定义，点击 确定。

> 说明：上述步骤仅简单地说明创建流程，关于账号管理与角色权限管理的详细说明，请参考 [角色权限概览](https://kubesphere.com.cn/docs/zh-CN/multi-tenant/role-overview) 和 [账号管理](https://kubesphere.com.cn/docs/zh-CN/platform-management/account-management)。

1.6. 然后用 user-manager 账户登录来创建下表中的四个账号，`ws-manager`将用于创建一个企业空间，并指定其中一个用户名为 `ws-admin`作为企业空间管理员。切换 `user-manager`账号登录后在 账号管理 下，新建四个账号，创建步骤同上，参考如下信息创建。

| 用户名          | 集群角色           | 职责                                                         |
| :-------------- | :----------------- | :----------------------------------------------------------- |
| ws-manager      | workspaces-manager | 创建和管理企业空间                                           |
| ws-admin        | cluster-regular    | 管理企业空间下所有的资源 (本示例用于邀请新成员加入企业空间)  |
| project-admin   | cluster-regular    | 创建和管理项目、DevOps 工程，邀请新成员加入                  |
| project-regular | cluster-regular    | 将被 project-admin 邀请加入项目和 DevOps 工程， 用于创建项目和工程下的工作负载、Pipeline 等资源 |

1.7. 查看新建的四个账号信息。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE0NTk0OC5wbmc)

### 企业空间管理员

#### 第二步：创建企业空间

企业空间 (workspace) 是 KubeSphere 实现多租户模式的基础，是用户管理项目、DevOps 工程和企业成员的基本单位。

2.1. 切换为 `ws-manager`登录 KubeSphere，ws-manager 有权限查看和管理平台的所有企业空间。

点击左上角的 `平台管理`→ `企业空间`，可见新安装的环境只有一个系统默认的企业空间 system-workspace，用于运行 KubeSphere 平台相关组件和服务，禁止删除该企业空间。

在企业空间列表点击 创建；

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE1MDU1NS5wbmc)

2.2. 参考如下提示填写企业空间的基本信息，然后点击 确定。企业空间的创建者同时默认为该企业空间的管理员 (workspace-admin)，拥有企业空间的最高管理权限。

- 企业空间名称：请尽量保持企业名称简短，便于用户浏览和搜索，本示例是 `demo-workspace`
- 企业空间管理员：可从当前的集群成员中指定，这里指定上一步创建的 `ws-admin`用户为管理员，相当于同时邀请了 `ws-admin`用户进入该企业空间
- 描述信息：简单介绍该企业空间

![填写基本信息](img/aHR0cHM6Ly9rdWJlc3BoZXJlLmNvbS5jbi9kb2NzL2RlbW8td29ya3NwYWNlLnBuZw)

> 说明：企业空间管理的详细说明请参考 [企业空间管理](https://kubesphere.com.cn/docs/zh-CN/platform-management/workspace-management)。

2.3. 企业空间 `demo-workspace`创建完成后，切换为 `ws-admin`登录 KubeSphere，点击左侧「进入企业空间」进入企业空间详情页。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MDUxMjE4MDQzMy5wbmc)

`ws-admin`可以从集群成员中邀请新成员加入当前企业空间，然后创建项目和 DevOps 工程。在左侧菜单栏选择 `企业空间管理`→ `成员管理`，点击 `邀请成员`。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE1MTQyNy5wbmc)

2.4. 这一步需要邀请在 步骤 1.6. 创建的两个用户 `project-admin`和 `project-regular`进入企业空间，且分别授予 `workspace-regular`和 `workspace-viewer`的角色，此时该企业空间一共有如下三个用户：

| 账号名          | 企业空间角色      | 职责                                                         |
| :-------------- | :---------------- | :----------------------------------------------------------- |
| ws-admin        | workspace-admin   | 管理企业空间下所有的资源 (本示例用于邀请新成员加入企业空间)  |
| project-admin   | workspace-regular | 创建和管理项目、DevOps 工程，邀请新成员加入                  |
| project-regular | workspace-viewer  | 将被 project-admin 邀请加入项目和 DevOps 工程， 用于创建工作负载、流水线等业务资源 |

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE1MTEyMC5wbmc)

### 项目和 DevOps 工程管理员

#### 第三步：创建项目

创建工作负载、服务和 CI/CD 流水线等资源之前，需要预先创建项目和 DevOps 工程。

3.1. 上一步将用户项目管理员 `project-admin`邀请进入企业空间后，可切换为 `project-admin`账号登录 KubeSphere，默认进入 demo-workspace 企业空间下，点击 创建，选择 创建资源型项目。

![创建项目](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MDQyODExMzU0OC5wbmc)

3.2. 填写项目的基本信息和高级设置，完成后点击 下一步。

基本信息

- 名称：为项目起一个简洁明了的名称，便于用户浏览和搜索，比如 `demo-project`
- 别名：帮助您更好的区分资源，并支持中文名称，比如 `示例项目`
- 描述信息：简单介绍该项目

高级设置

3.3. 此处将默认的最大 CPU 和内存分别设置 `1 Core`和 `1000 Mi`，后续的示例都可以在这个示例项目中完成，在项目使用过程中可根据实际情况再次编辑资源默认请求。

完成高级设置后，点击 创建。

> 说明：高级设置是在当前项目中配置容器默认的 CPU 和内存的请求与限额，相当于是给项目创建了一个 Kubernetes 的 LimitRange 对象，在项目中创建工作负载后填写容器组模板时，若不填写容器 CPU 和内存的请求与限额，则容器会被分配在高级设置的默认 CPU 和内存请求与限额值。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE1NDM0My5wbmc)

> 提示：项目管理和设置的详细说明，请参考用户指南下的项目设置系列文档。

##### 邀请成员

3.4. 示例项目 demo-project 创建成功后，点击进入示例项目。在 步骤 2.4. 已邀请用户 `project-regular`加入了当前企业空间 `demo-workspace`，下一步则需要邀请 project-regular 用户进入该企业空间下的项目 demo-project。点击项目列表中的 demo-project 进入该项目。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE1NDY0NC5wbmc)

3.5. 在项目的左侧菜单栏选择 项目设置 → 项目成员，点击 邀请成员。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE1NDcyMi5wbmc)

3.6. 在弹窗中的 `project-regular`点击 `"+"`，在项目的内置角色中选择 `operator`角色。因此，后续在项目中创建和管理资源，都可以由 `project-regular`用户登录后进行操作。

##### 设置外网访问

在创建应用路由之前，需要先启用外网访问入口，即网关。这一步是创建对应的应用路由控制器，负责接收项目外部进入的流量，并将请求转发到对应的后端服务。

3.7. 请使用项目管理员 `project-admin`设置外网访问，选择 「项目设置」 → 「外网访问」，点击 「设置网关」。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE1NDkyNi5wbmc)

3.8. 在弹窗中，默认 NodePort 即可，然后点击 「保存」。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MDUwNzIyMjMyMS5wbmc)

> 提示：若希望开启 LoadBalancer 类型暴露集群内部服务，则需要安装云厂商支持 LoadBalancer 插件，例如 [QingCloud 负载均衡器插件](https://kubesphere.com.cn/docs/zh-CN/installation/qingcloud-lb)；若 KubeSphere 部署在阿里云或其它云平台，则需要手动安装其支持的 LB 插件；若 KubeSphere 部署在物理机环境，可安装配置 [Porter - 面向物理环境的 K8s LB 插件](https://github.com/kubesphere/porter)。

3.9. 当前可以看到网关地址、http/https 端口号都已经开启。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE1NTUyNy5wbmc)

#### 第四步：创建 DevOps 工程（可选）

> 说明：DevOps 功能组件作为可选安装项，提供 CI/CD 流水线、B2i/S2i 等丰富的企业级功能，若还未安装可参考 [自定义组件安装（安装后）](https://kubesphere.com.cn/docs/zh-CN/installation/components) 开启 DevOps 组件安装，然后参考以下步骤。

4.1. 继续使用 `project-admin`用户创建 DevOps 工程。点击 工作台，在当前企业空间下，点击 创建，在弹窗中选择 创建一个 DevOps 工程。DevOps 工程的创建者 `project-admin`将默认为该工程的 Owner，拥有 DevOps 工程的最高权限。

![创建 DevOps 工程](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MDQyODEzMTUxOC5wbmc)

4.2. 输入 DevOps 工程的名称和描述信息，比如名称为 `demo-devops`。点击 创建，注意创建一个 DevOps 有一个初始化环境的过程需要几秒钟。

> 说明：DevOps 工程管理的详细说明请参考 [管理 DevOps 工程](https://kubesphere.com.cn/docs/zh-CN/devops/devops-project)。

4.3. 点击 DevOps 工程列表中的 `demo-devops`进入该工程的详情页。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE2MDkwNS5wbmc)

4.4. 同上，这一步需要在 `demo-devops`工程中邀请用户 `project-regular`，并设置角色为 `maintainer`，用于对工程内的 Pipeline、凭证等创建和配置等操作。菜单栏选择 工程管理 → 工程成员，然后点击 邀请成员，为用户 `project-regular`设置角色为 `maintainer`。后续在 DevOps 工程中创建 Pipeline 和凭证等资源，都可以由 `project-regular`用户登录后进行操作。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE2MDk0OS5wbmc)

至此，本文档为您演示了如何在多租户的基础上，使用账户管理和角色管理的功能，以示例的方式介绍了常用内置角色的用法，以及创建项目和 DevOps 工程。

## 谷粒商城Wordpress (十二)

**354、kubesphere-进阶-创建WordPress应用-密钥 -356、kubesphere-进阶-创建WordPress应用-外网访问**

 本地我也安装好了，直接把官网copy一下，写的很详细

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwNTAwMDgyODM5MC02MzUzOTMyOTUucG5n)

 

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwNTAwMDg0MTk2NS00MDk3Njg1OTAucG5n)

 

 

 

### WordPress 简介

WordPress 是使用 PHP 开发的博客平台，用户可以在支持 PHP 和 MySQL 数据库的环境中架设属于自己的网站。本文以创建一个 [Wordpress 应用](https://kubesphere.com.cn/docs/zh-CN/quick-start/wordpress-deployment/www.wordpress.com/‎) 为例，以创建 KubeSphere 应用的形式将 Wordpress 的组件（MySQL 和 Wordpress）创建后发布至 Kubernetes 中，并在集群外访问 Wordpress 服务。

一个完整的 Wordpress 应用会包括以下 Kubernetes 对象，其中 MySQL 作为后端数据库，Wordpress 本身作为前端提供浏览器访问。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIwMDQ0NC5wbmc)

前提条件

已创建了企业空间、项目和普通用户 `project-regular`账号（该已账号已被邀请至示例项目），并开启了外网访问，请参考 [多租户管理快速入门](https://kubesphere.com.cn/docs/zh-CN/quick-start/admin-quick-start)。

预估时间

约 10 分钟。

示例视频

 

### 创建密钥

MySQL 的环境变量 `MYSQL_ROOT_PASSWORD`即 root 用户的密码属于敏感信息，不适合以明文的方式表现在步骤中，因此以创建密钥的方式来代替该环境变量。创建的密钥将在创建 MySQL 的容器组设置时作为环境变量写入。

### 创建 MySQL 密钥

1. 以项目普通用户 `project-regular`登录 KubeSphere，在当前项目下左侧菜单栏的 配置中心 选择 密钥，点击 创建。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIwMjg0OC5wbmc)

1. 填写密钥的基本信息，完成后点击 下一步。

- 名称：作为 MySQL 容器中环境变量的名称，可自定义，例如 `mysql-secret`
- 别名：别名可以由任意字符组成，帮助您更好的区分资源，例如 `MySQL 密钥`
- 描述信息：简单介绍该密钥，如 `MySQL 初始密码`

1. 密钥设置页，填写如下信息，完成后点击 创建。

- 类型：选择 `默认`(Opaque)
- Data：Data 键值对填写 `MYSQL_ROOT_PASSWORD`和 `123456`

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIwMzA0NC5wbmc)

### 创建 WordPress 密钥

同上，创建一个 WordPress 密钥，Data 键值对填写 `WORDPRESS_DB_PASSWORD`和 `123456`。此时两个密钥都创建完成。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIwMzMyNS5wbmc)

### 创建存储卷

1. 在当前项目下左侧菜单栏的 `存储卷`，点击 `创建`，基本信息如下。

- 名称：wordpress-pvc
- 别名：Wordpress 持久化存储卷
- 描述信息：Wordpress PVC

1. 完成后点击 `下一步`，存储类型默认 local，访问模式和存储卷容量也可以使用默认值，点击 `下一步`，直接创建即可。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIxMjIzMi5wbmc)

### 创建应用

### 添加 MySQL 组件

1. 在左侧菜单栏选择 应用负载 → 应用，然后点击 部署新应用。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIwMzY0MS5wbmc)

1. 基本信息中，参考如下填写，完成后在右侧点击 添加组件。

- 应用名称：必填，起一个简洁明了的名称，便于用户浏览和搜索，例如填写 `wordpress`
- 描述信息：简单介绍该工作负载，方便用户进一步了解

MySQL 组件信息

1. 参考如下提示完成 MySQL 组件信息：

- 名称： mysql
- 组件版本：v1
- 别名：MySQL 数据库
- 负载类型：选择 `有状态服务`

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE3MzIyOC5wbmc)

1. 点击 添加容器镜像，镜像填写 `mysql:5.6`（应指定镜像版本号)，然后按回车键或点击 DockerHub，点击 `使用默认端口`。

> 提示: 注意，在高级设置中确保内存限制 ≥ 1000 Mi,否则可能 MySQL 会因内存 Limit 不够而无法启动。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE3MzE1OC5wbmc)

1. 下滑至环境变量，在此勾选 `环境变量`，然后选择 `引用配置文件或密钥`，名称填写为 `MYSQL_ROOT_PASSWORD`，下拉框中选择密钥为 `mysql-secret`和 `MYSQL_ROOT_PASSWORD`。

完成后点击右下角 `√`。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE3MzcxOC5wbmc)

1. 点击 `添加存储卷模板`，为 MySQL 创建一个 PVC 实现数据持久化。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIwNTk1NC5wbmc)

参考下图填写存储卷信息。

- 存储卷名称：必填，起一个简洁明了的名称，便于用户浏览和搜索，此处填写 `mysql-pvc`
- 存储类型：选择集群已有的存储类型，如 `Local`
- 容量和访问模式：容量默认 `10 Gi`，访问模式默认 `ReadWriteOnce (单个节点读写)`
- 挂载路径：存储卷在容器内的挂载路径，选择 `读写`，路径填写 `/var/lib/mysql`

完成后点击 `√`。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE3NDAxMC5wbmc)

### 添加 WordPress 组件

1. 参考如下提示完成 WordPress 组件信息：

- 名称： wordpress
- 组件版本：v1
- 别名：Wordpress前端
- 负载类型：默认 `无状态服务`

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIxMDczMC5wbmc)

1. 点击 添加容器镜像，镜像填写 `wordpress:4.8-apache`（应指定镜像版本号)，然后按回车键或点击 DockerHub，点击 `使用默认端口`。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE3NDIxNS5wbmc)

1. 下滑至环境变量，在此勾选 `环境变量`，这里需要添加两个环境变量：

- 点击 引用配置文件或密钥，名称填写 `WORDPRESS_DB_PASSWORD`，选择在第一步创建的配置 (Secret) `wordpress-secret`和 `WORDPRESS_DB_PASSWORD`。
- 点击 添加环境变量，名称填写 `WORDPRESS_DB_HOST`，值填写 `mysql`，对应的是上一步创建 MySQL 服务的名称，否则无法连接 MySQL 数据库。

完成后点击 `√`。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE3NDU1NS5wbmc)

1. 点击 `添加存储卷`，选择已有存储卷 `wordpress-pvc`，访问模式改为 `读写`，容器挂载路径 `/var/www/html`。完成后点击 `√`。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzE3NDcwOS5wbmc)

1. 检查 WordPress 组件信息无误后，再次点击 `√`，此时 MySQL 和 WordPress 组件信息都已添加完成，点击 `创建`。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIxMjg1MS5wbmc)

### 查看应用资源

1. 在 `工作负载`下查看 部署 和 有状态副本集 的状态，当它们都显示为 `运行中`，说明 WordPress 应用创建成功。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIxMzIxMy5wbmc)

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIxMzE1MC5wbmc)

1. 访问 Wordpress 服务前，查看 wordpress 服务，将外网访问设置为 `NodePort`。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIxMzQyNi5wbmc)

1. 点击 `更多操作`→ `编辑外网访问`，选择 `NodePort`，然后该服务将在每个节点打开一个节点端口，通过 `点击访问`即可在浏览器访问 WordPress。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIxMzgyNi5wbmc)

> 提示：此时也可以通过工具箱的 web kubctl 查看当前项目中 Wordpress 应用正在运行的所有资源。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIyMDI0Ni5wbmc)

### 访问 Wordpress

以上访问将通过 `http://{$节点 IP}:{$节点端口 NodePort}`访问 WordPress 博客网站。

![img](img/aHR0cHM6Ly9wZWszYi5xaW5nc3Rvci5jb20va3ViZXNwaGVyZS1kb2NzL3BuZy8yMDE5MTAyNzIxMzgyNi5wbmc)

至此，您已经熟悉了如何通过创建一个 KubeSphere 应用的方式，通过快速添加多个组件来完成一个应用的构建，最终发布至 Kubernetes。这种创建应用的形式非常适合微服务的构建，只需要将各个组件容器化以后，即可通过这种方式快速创建一个完整的微服务应用并发布 Kubernetes。

## 谷粒商城创建mysql主从(十三)

**361-363 创建mysql主从**

**STEP 1 启动主从**

```
[root@database ~]#  docker run -p 3307:3306 --name mysql-master -v /mydata/mysql/master/conf:/etc/mysql  -v /mydata/mysql/master/logs:/var/log/mysql  -v /mydata/mysql/master/data:/var/lib/mysql  -e MYSQL_ROOT_PASSWORD=root -d mysql:5.7
6a7d36b510b618d8d7c4d408051004153f95644dc4ab09fdcc9d1e1b19d97c5e
[root@database ~]# docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                               NAMES
6a7d36b510b6        mysql:5.7           "docker-entrypoint.s…"   4 seconds ago       Up 3 seconds        33060/tcp, 0.0.0.0:3307->3306/tcp   mysql-master
961ab799c1fe        redis               "docker-entrypoint.s…"   12 days ago         Up 11 days          0.0.0.0:6379->6379/tcp              focused_kirch
4dd3eda0035b        a4fdfd462add        "docker-entrypoint.s…"   12 days ago         Up 11 days          0.0.0.0:3306->3306/tcp, 33060/tcp   mysql
[root@database ~]#  docker run -p 3317:3306 --name mysql-slave01 -v /mydata/mysql/slave/conf:/etc/mysql  -v /mydata/mysql/slave/logs:/var/log/mysql  -v /mydata/mysql/slave/data:/var/lib/mysql  -e MYSQL_ROOT_PASSWORD=root -d mysql:5.7
991c33239f50e49a0a99ecee5cf9d58b561635dbf688cf6d4359fbdfb4ac9456
[root@database ~]# docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                               NAMES
991c33239f50        mysql:5.7           "docker-entrypoint.s…"   14 seconds ago       Up 13 seconds       33060/tcp, 0.0.0.0:3317->3306/tcp   mysql-slave01
6a7d36b510b6        mysql:5.7           "docker-entrypoint.s…"   About a minute ago   Up About a minute   33060/tcp, 0.0.0.0:3307->3306/tcp   mysql-master
961ab799c1fe        redis               "docker-entrypoint.s…"   12 days ago          Up 11 days          0.0.0.0:6379->6379/tcp              focused_kirch
4dd3eda0035b        a4fdfd462add        "docker-entrypoint.s…"   12 days ago          Up 11 days          0.0.0.0:3306->3306/tcp, 33060/tcp   mysql
[
```

**STEP 2 修改配置文件**

```
[root@database ~]# cat /mydata/mysql/master/conf/my.cnf
[client]
default-character-set=utf8

[mysql]
default-character-set=utf8


[mysqld]
init_connect='set collation_connection=utf8_unicode_ci'
init_connect='SET NAMES utf8'
character-set-server=utf8
collation-server=utf8_unicode_ci
skip-character-set-client-handshake
skip-name-resolve

server_id=1
log-bin=mysql-bin
read-only=0
binlog-do-db=gulimall_ums
binlog-do-db=gulimall_pms
binlog-do-db=gulimall_oms
binlog-do-db=gulimall_sms
binlog-do-db=gulimall_wms
binlog-do-db=gulimall-admin

replicate-ignore-db=mysql
replicate-ignore-db=sys
replicate-ignore-db=information_schema
replicate-ignore-db=performance_schema
[root@database ~]# cat /mydata/mysql/slave/conf/my.cnf
[client]
default-character-set=utf8

[mysql]
default-character-set=utf8


[mysqld]
init_connect='set collation_connection=utf8_unicode_ci'
init_connect='SET NAMES utf8'
character-set-server=utf8
collation-server=utf8_unicode_ci
skip-character-set-client-handshake
skip-name-resolve


server_id=2
log-bin=mysql-bin
read-only=1
binlog-do-db=gulimall_ums
binlog-do-db=gulimall_pms
binlog-do-db=gulimall_oms
binlog-do-db=gulimall_sms
binlog-do-db=gulimall_wms
binlog-do-db=gulimall-admin

replicate-ignore-db=mysql
replicate-ignore-db=sys
replicate-ignore-db=information_schema
replicate-ignore-db=performance_schema
[root@database ~]#
```

**STEP3 主服务器授权**

```
mysql> grant all privileges on *.* to 'root'@'%' identified by 'root' with grant option
    -> ;
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> flush privileges;
Query OK, 0 rows affected (0.00 sec)

mysql> grant replication slave on *.* to 'backup'@'%' identified by '123456';
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> show master status\G;
*************************** 1. row ***************************
             File: mysql-bin.000001
         Position: 889
     Binlog_Do_DB: gulimall_ums,gulimall_pms,gulimall_oms,gulimall_sms,gulimall_wms,gulimall-admin
 Binlog_Ignore_DB:
Executed_Gtid_Set:
1 row in set (0.00 sec)

ERROR:
No query specified

mysql> show master status
    -> ;
+------------------+----------+---------------------------------------------------------------------------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB                                                                    | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+---------------------------------------------------------------------------------+------------------+-------------------+
| mysql-bin.000001 |      889 | gulimall_ums,gulimall_pms,gulimall_oms,gulimall_sms,gulimall_wms,gulimall-admin |                  |                   |
+------------------+----------+---------------------------------------------------------------------------------+------------------+-------------------+
1 row in set (0.00 sec)

mysql> exit
Bye
root@6a7d36b510b6:/# read escape sequence
[root@database ~]#
```

**STEP 4 从服务器开启同步**

```
change master to master_host='192.168.1.117',master_user='backup', master_password='123456',master_log_file='mysql-bin.000001',master_log_pos=0,master_port=3307;
start slave;
show slave status;
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwNTIzMDI1MTI5NS04NjEzNTMyODgucG5n)

## 谷粒商城读写分离(十四)



### 1. 规则配置

编辑`%SHARDING_PROXY_HOME%\conf\config-xxx.yaml`。

分表分库

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwNzIyNDA0MzM3Ny0zOTk1NTg4NjAucG5n)

 读写分离

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwNzIyNDE0MzM4Ny0xOTcxNTAwODQ3LnBuZw)

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwNzIyNDE1ODc4MC02NjExMjI1NDcucG5n)

编辑`%SHARDING_PROXY_HOME%\conf\server.yaml`。

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwNzIyMzkzNTc0Ny05MjQ0MTg1NDUucG5n)

### 2. 引入依赖

如果后端连接PostgreSQL数据库，不需要引入额外依赖。

如果后端连接MySQL数据库，需要下载MySQL Connector/J， 解压缩后，将mysql-connector-java-5.1.47.jar拷贝到${sharding-proxy}\lib目录。

```
 CREATE table t_order (
ORDER_id BIGINT(20) not null auto_increment,
user_id int(11) not NULL,
status VARCHAR(50) COLLATE utf8_bin DEFAULT null,
PRIMARY key (order_id)
)ENGINE=INNODB DEFAULT CHARSET=utf8 COLLATE utf8_bin;

CREATE TABLE t_order_item(
  order_item_id BIGINT(20) not null,
  order_id BIGINT(20) not null,
  user_id int(11) not null,
  content VARCHAR(255) COLLATE utf8_bin DEFAULT null,
  STATUS VARCHAR(50) COLLATE utf8_bin DEFAULT null,
  PRIMARY key (order_item_id)
)ENGINE=INNODB DEFAULT CHARSET=utf8 COLLATE utf8_bin;
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwNzIzMjQzNjQyNS04NzE2Nzg4NDkucG5n)　　

### 3. 启动服务

- 使用默认配置项

```sh
${sharding-proxy}\bin\start.sh
```

- 配置端口

```sh
${sharding-proxy}\bin\start.sh ${port}
```

## 谷粒商城安装ES及入门(十六)

**102、全文检索-ElasticSearch-简介 --109、全文检索-ElasticSearch-入门-删除数据&bulk批量操作导入样本测试数据**

 **安装**

```
[root@play ~]# docker pull elasticsearch:7.4.2
7.4.2: Pulling from library/elasticsearch
d8d02d457314: Pull complete
f26fec8fc1eb: Pull complete
8177ad1fe56d: Pull complete
d8fdf75b73c1: Pull complete
47ac89c1da81: Pull complete
fc8e09b48887: Pull complete
367b97f47d5c: Pull complete
Digest: sha256:543bf7a3d61781bad337d31e6cc5895f16b55aed4da48f40c346352420927f74
Status: Downloaded newer image for elasticsearch:7.4.2
docker.io/library/elasticsearch:7.4.2
[root@play ~]# free -m
              total        used        free      shared  buff/cache   available
Mem:           7821        2802         476          16        4542        4703
Swap:          1639          11        1628
[root@play ~]# mkdir -p /mydata/elasticsearch/config
[root@play ~]# mkdir -p /mydata/elasticsearch/data
[root@play ~]# echo "http.host: 0.0.0.0" > /mydata/elasticsearch/config/elasticsearch.yml
[root@play ~]# cat /mydata/elasticsearch/config/elasticsearch.yml
http.host: 0.0.0.0
[root@play ~]# docker run --name elasticsearch -p 9200:9200 -p 9300:9300 --privileged=true \
> -e "discovery.type=single-node"  \
> -e ES_JAVA_OPTS="-Xms128m -Xms256m"  \
> -v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml   \
> -v /mydata/elasticsearch/data:/usr/share/elasticsearch/data   \
> -v /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins   \
> -d elasticsearch:7.4.2　　
```

但是会报错显示权限不足

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTAwMTgwMzQ0OS0yMDM4NDk2NDY3LnBuZw)

 安装kibana

```
[root@play elasticsearch]# chmod 777 -R .
[root@play elasticsearch]# ll
total 0
drwxrwxrwx. 2 root root 31 Jun  8 11:26 config
drwxrwxrwx. 2 root root  6 Jun  8 11:23 data
drwxrwxrwx. 2 root root  6 Jun  8 11:35 plugins
[root@play elasticsearch]# docker ps -l
CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS                     PORTS               NAMES
174c44e86f31        elasticsearch:7.4.2   "/usr/local/bin/dock…"   2 minutes ago       Exited (1) 2 minutes ago                       elasticsearch
[root@play elasticsearch]# docker start 174c44e86f31
174c44e86f31
[root@play elasticsearch]# docker pull kibana:7.4.2
7.4.2: Pulling from library/kibana
d8d02d457314: Already exists
bc64069ca967: Pull complete
c7aae8f7d300: Pull complete
8da0971e3b41: Pull complete
58ea4bb2901c: Pull complete
b1e21d4c2a7e: Pull complete
3953eac632cb: Pull complete
5f4406500758: Pull complete
340d85e0d1c7: Pull complete
1768564d16fb: Pull complete
Digest: sha256:355f9c979dc9cdac3ff9a75a817b8b7660575e492bf7dbe796e705168f167efc
Status: Downloaded newer image for kibana:7.4.2
docker.io/library/kibana:7.4.2
[root@play elasticsearch]# docker ps -a
CONTAINER ID        IMAGE                 COMMAND                  CREATED                                                                                       STATUS              PORTS                                            NAME                                                                          S
174c44e86f31        elasticsearch:7.4.2   "/usr/local/bin/dock…"   12 minutes ag                                                                          o      Up 9 minutes        0.0.0.0:9200->9200/tcp, 0.0.0.0:9300->9300/tcp   elas                                                                          ticsearch
[root@play elasticsearch]# docker run --name kibana -e ELASTICSEARCH_HOSTS=http:                                                                          //192.168.1.119:9200 -p 5601:5601 -d kibana:7.4.2
7ab7bf7aa2e5b88e561e6d43c5aa054d49724d30d16bc6d444b8ad4883edf35c
[root@play elasticsearch]# docker ps -a
CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                                            NAMES
7ab7bf7aa2e5        kibana:7.4.2          "/usr/local/bin/dumb…"   7 seconds ago       Up 6 seconds        0.0.0.0:5601->5601/tcp                           kibana
174c44e86f31        elasticsearch:7.4.2   "/usr/local/bin/dock…"   13 minutes ago      Up 10 minutes       0.0.0.0:9200->9200/tcp, 0.0.0.0:9300->9300/tcp   elasticsearch
```

### **Cat**　　

GET /_cat/nodes: 查看所有节点
GET /_cat/health: 查看es健康状况
GET /_cat/master: 查看主节点
GET /_cat/indices: 查看所有索引

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTAwMjA0MzEzMi0xMDE3NzMwNjcucG5n)

 

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTAwMjA0NzQ4Ni0xNDgwMDkzMDcucG5n)

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTAwMTkwNzc0OC0xNTI0Nzc2ODcucG5n)

　![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTAwMjEwMzg1Mi0xNzAzMjc1NDM0LnBuZw)

　![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTAwMjEyMjIyNi0xODEzMDM5MDY3LnBuZw)

 ***\*106、全文检索-ElasticSearch-入门-put&post新增数据\****

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTE1NTcxMzkzNS0xOTk3OTY0NjQxLnBuZw)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTE1NTgxMjU4OC04NDcyMDQ4NzUucG5n)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTE2MDQxMjQzMC05MjcxMjE3NjYucG5n)

**107、全文检索-ElasticSearch-入门-get查询数据&乐观锁字段**

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTE2MDY0NjgwOC0xNzYyMDQxNTUwLnBuZw)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTE2MTMxODI0OS02OTk2Mzc5MjIucG5n)

 **108、全文检索-ElasticSearch-入门-put&post修改数据**

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTE2MzIyMjA1Ni0xNjkwNjIxOTUyLnBuZw)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTE2MzMwMzI0OS0yMTQ1ODE5MDY1LnBuZw)

 PUT和没有update的POST进行更新的时候，是直接覆盖

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTE2MzU1MzQzMS0xODQ0NzExNDgxLnBuZw)

**109、全文检索-ElasticSearch-入门-删除数据&bulk批量操作导入样本测试数据**

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTE2MzkzNjUxNS0zOTYyODkyNjAucG5n)

 批量插入

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYwOTE2NDkyNDQ0NC00MzkyNDUzMzUucG5n)

 Json地址：

```
https://github.com/elastic/elasticsearch/blob/master/docs/src/test/resources/accounts.json
```

## 谷粒商城ES进阶和映射(十七)

**110、全文检索-ElasticSearch-进阶-两种查询方式-121 全文检索-ElasticSearch-映射-修改映射&数据迁移**

讲的也比较简单，就简单记录一下

```
GET /bank/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "account_number": "asc"
    }
  ]
}


GET /bank/_search?q=*&sort=account_number:asc

GET /bank/_search
{
  "query": {
    "match": {
      "account_number": "20"
    }
  }
}

GET /bank/_search
{
  "query": {
    "match": {
      "address": "Kings"
    }
  }
}

GET /bank/_search
{
  "query": {
    "match": {
      "address": "mill lane"
    }
  }
}

##会断检索条件进行分词匹配

GET /bank/_search
{
  "query": {
    "match_phrase": {
      "address": "132 Gunnison"
    }
  }
}
#注意，这个keyword是完全匹配
GET /bank/_search
{
  "query": {
    "match": {
      "address.keyword": " 132 Gunnison"
    }
  }
}

GET /bank/_search
{
  "query": {
    "multi_match": {
      "query": "mill",
      "fields": ["address","city"]
    }
  }
}


GET /bank/_search?pretty
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "gender": "F"
          }
        },
        {
          "match": {
            "age": "40"
          }
        }
      ],
      "must_not": [
        {
          "match": {
            "state": "ID"
          }
        }
      ],
      "should": [
        {
          "match": {
            "employer": "Suremax"
          }
        }
      ]
    }
  }
}

#使用filter不会计算相关性得分
GET /bank/_search
{
  "query": {
    "bool": {
      "filter": {
        "range": {
          "age": {
            "gte": 10,
            "lte": 20
          }
        }
      }
    }
  }
}


GET /bank/_search
{
  "query": {
    "term": {
        "age": "30"
    }
  }
}

GET /bank/_search
{
  "query": {
    "match": {
      "address": "mill"
    }
  },
  "aggs": {
    "ageAgg": {
      "terms": {
        "field": "age",
        "size": 10
      }
    },
    "ageAvg":{
      "avg": {
        "field": "age"
      }
    }
  },
  "size": 0
}


##按照年龄聚合，并且请求这些年龄段的这些人的平均薪资
GET /bank/_search
{
  "query": {
    "match_all": {}
  },"aggs": {
    "ageAgg": {
      "terms": {
        "field": "age",
        "size": 10
      },
      "aggs": {
        "ageAvg": {
          "avg": {
            "field": "balance"
          }
        }
      }
    }
  }
}


##查出所有年龄分布，并且这些年龄段中M的平均薪资和F的平均薪资以及这个年龄段的总体平均薪资
GET /bank/_search
{
  "query": {
    "match_all": {}
  },
  "aggs": {
    "ageAgg": {
      "terms": {
        "field": "age",
        "size": 100
      },
      "aggs": {
        "genderAvg": {
          "terms": {
            "field": "gender.keyword",
            "size": 10
          },
          "aggs": {
            "balanceAvg": {
              "avg": {
                "field": "balance"
              }
            }
          }
        },
        "ageBalance":{
          "avg": {
            "field": "balance"
          }
        }
      }
    }
  }
}



##新增映射规则
PUT /my-index
{
  "mappings": {
    "properties": {
      "age":    { "type": "integer" },  
      "email":  { "type": "keyword"  }, 
      "name":   { "type": "text"  }     
    }
  }
}

##修改映射
PUT /my-index/_mapping
{
  "properties": {
    "employee-id": {
      "type": "keyword",
      "index": false
    }
  }
}

#进行数据迁移
GET /bank/_mapping

GET /newbank/_mapping

PUT /newbank
{
  "mappings": {
    "properties": {
      "account_number": {
        "type": "long"
      },
      "address": {
        "type": "text"
      },
      "age": {
        "type": "integer"
      },
      "balance": {
        "type": "long"
      },
      "city": {
        "type": "keyword"
      },
      "email": {
        "type": "keyword"
      },
      "employer": {
        "type": "keyword"
      },
      "firstname": {
        "type": "text"
      },
      "gender": {
        "type": "keyword"
      },
      "lastname": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "state": {
        "type": "text"
      }
    }
  }
}


POST _reindex
{
  "source": {
    "index": "bank",
    "type": "account"
  },
  "dest": {
    "index": "newbank"
  }
}

GET /newbank/_search
```

## 谷粒商城ES自定义词库(十八)

具体的IK分词可以查看博客：https://www.cnblogs.com/dalianpai/p/12694298.html

**122、全文检索-ElasticSearch-分词-分词&安装ik分词 - 124、全文检索-ElasticSearch-分词-自定义扩展词库**

下载地址；**https://github.com/medcl/elasticsearch-analysis-ik**

```
[root@localhost plugins]# ll
total 4400
-rw-r--r-- 1 root root 4504487 Jun 15 13:13 elasticsearch-analysis-ik-7.4.2.zip
[root@localhost plugins]# unzip
UnZip 6.00 of 20 April 2009, by Info-ZIP.  Maintained by C. Spieler.  Send
bug reports using http://www.info-zip.org/zip-bug.html; see README for details.

Usage: unzip [-Z] [-opts[modifiers]] file[.zip] [list] [-x xlist] [-d exdir]
  Default action is to extract files in list, except those in xlist, to exdir;
  file[.zip] may be a wildcard.  -Z => ZipInfo mode ("unzip -Z" for usage).

  -p  extract files to pipe, no messages     -l  list files (short format)
  -f  freshen existing files, create none    -t  test compressed archive data
  -u  update files, create if necessary      -z  display archive comment only
  -v  list verbosely/show version info       -T  timestamp archive to latest
  -x  exclude files that follow (in xlist)   -d  extract files into exdir
modifiers:
  -n  never overwrite existing files         -q  quiet mode (-qq => quieter)
  -o  overwrite files WITHOUT prompting      -a  auto-convert any text files
  -j  junk paths (do not make directories)   -aa treat ALL files as text
  -U  use escapes for all non-ASCII Unicode  -UU ignore any Unicode fields
  -C  match filenames case-insensitively     -L  make (some) names lowercase
  -X  restore UID/GID info                   -V  retain VMS version numbers
  -K  keep setuid/setgid/tacky permissions   -M  pipe through "more" pager
  -O CHARSET  specify a character encoding for DOS, Windows and OS/2 archives
  -I CHARSET  specify a character encoding for UNIX and other archives

See "unzip -hh" or unzip.txt for more help.  Examples:
  unzip data1 -x joe   => extract all files except joe from zipfile data1.zip
  unzip -p foo | more  => send contents of foo.zip via pipe into program more
  unzip -fo foo ReadMe => quietly replace existing ReadMe if archive file newer
[root@localhost plugins]# unzip elasticsearch-analysis-ik-7.4.2.zip
Archive:  elasticsearch-analysis-ik-7.4.2.zip
  inflating: elasticsearch-analysis-ik-7.4.2.jar
  inflating: httpclient-4.5.2.jar
  inflating: httpcore-4.4.4.jar
  inflating: commons-logging-1.2.jar
  inflating: commons-codec-1.9.jar
  inflating: plugin-descriptor.properties
  inflating: plugin-security.policy
   creating: config/
  inflating: config/surname.dic
  inflating: config/quantifier.dic
  inflating: config/extra_stopword.dic
  inflating: config/suffix.dic
  inflating: config/extra_single_word_full.dic
  inflating: config/extra_single_word.dic
  inflating: config/preposition.dic
  inflating: config/IKAnalyzer.cfg.xml
  inflating: config/main.dic
  inflating: config/stopword.dic
  inflating: config/extra_main.dic
  inflating: config/extra_single_word_low_freq.dic
[root@localhost plugins]# ll
total 5828
-rw-r--r-- 1 root root  263965 May  6  2018 commons-codec-1.9.jar
-rw-r--r-- 1 root root   61829 May  6  2018 commons-logging-1.2.jar
drwxr-xr-x 2 root root     299 Oct  7  2019 config
-rw-r--r-- 1 root root   54643 Nov  4  2019 elasticsearch-analysis-ik-7.4.2.jar
-rw-r--r-- 1 root root 4504487 Jun 15 13:13 elasticsearch-analysis-ik-7.4.2.zip
-rw-r--r-- 1 root root  736658 May  6  2018 httpclient-4.5.2.jar
-rw-r--r-- 1 root root  326724 May  6  2018 httpcore-4.4.4.jar
-rw-r--r-- 1 root root    1805 Nov  4  2019 plugin-descriptor.properties
-rw-r--r-- 1 root root     125 Nov  4  2019 plugin-security.policy
[root@localhost plugins]# mkdir ik
[root@localhost plugins]# ll
total 1428
-rw-r--r-- 1 root root 263965 May  6  2018 commons-codec-1.9.jar
-rw-r--r-- 1 root root  61829 May  6  2018 commons-logging-1.2.jar
drwxr-xr-x 2 root root    299 Oct  7  2019 config
-rw-r--r-- 1 root root  54643 Nov  4  2019 elasticsearch-analysis-ik-7.4.2.jar
-rw-r--r-- 1 root root 736658 May  6  2018 httpclient-4.5.2.jar
-rw-r--r-- 1 root root 326724 May  6  2018 httpcore-4.4.4.jar
drwxr-xr-x 2 root root      6 Jun 15 13:17 ik
-rw-r--r-- 1 root root   1805 Nov  4  2019 plugin-descriptor.properties
-rw-r--r-- 1 root root    125 Nov  4  2019 plugin-security.policy
[root@localhost plugins]# mv * ik/
mv: cannot move ‘ik’ to a subdirectory of itself, ‘ik/ik’
```

进行重启容器，然后查询

```
POST _analyze
{
  "tokenizer": "standard",
  "text": "The 2 QUICK Brown-Foxes jumped over the lazy dog's bone."
}


POST _analyze
{
  "tokenizer": "ik_smart",
  "text": "尚硅谷电商"
}
```

但是有很多的词识别不了，需要自定义词汇表

先增大内存

```
[root@cicd ~]# docker ps -a
CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                                            NAMES
7ab7bf7aa2e5        kibana:7.4.2          "/usr/local/bin/dumb…"   7 days ago          Up 5 hours          0.0.0.0:5601->5601/tcp                           kibana
174c44e86f31        elasticsearch:7.4.2   "/usr/local/bin/dock…"   7 days ago          Up 2 minutes        0.0.0.0:9200->9200/tcp, 0.0.0.0:9300->9300/tcp   elasticsearch
[root@cicd ~]# docker stop 174c44e86f31
174c44e86f31
[root@cicd ~]# docker start 174c44e86f31
174c44e86f31
[root@cicd ~]# free -m
              total        used        free      shared  buff/cache   available
Mem:           7821        3944        2361           9        1515        3605
Swap:          1639           0        1639
[root@cicd ~]# docker stop 174c44e86f31
174c44e86f31
[root@cicd ~]# docker rm 174c44e86f31
174c44e86f31
[root@cicd ~]# docker run --name elasticsearch -p 9200:9200 -p 9300:9300 --privi                                                                              leged=true \
> -e "discovery.type=single-node"  \
> -e ES_JAVA_OPTS="-Xms512m -Xms1024m"  \
> -v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/con                                                                              fig/elasticsearch.yml   \
> -v /mydata/elasticsearch/data:/usr/share/elasticsearch/data   \
> -v /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins   \
> -d elasticsearch:7.4.2
aa707f92c246a4878adcb5e6f6e7c98ab55ecbe201fa026d3329178a41fc7791
[root@cicd ~]# docker ps -a
```

在安装nginx，并修改es的xml

```
[root@cicd ~]# cd /mydata/
[root@cicd mydata]# mkdir nginx
[root@cicd mydata]# docker pull nginx:1.10
1.10: Pulling from library/nginx
6d827a3ef358: Pull complete
1e3e18a64ea9: Pull complete
556c62bb43ac: Pull complete
Digest: sha256:6202beb06ea61f44179e02ca965e8e13b961d12640101fca213efbfd145d7575
Status: Downloaded newer image for nginx:1.10
docker.io/library/nginx:1.10
[root@cicd mydata]# ll
total 0
drwxrwxrwx. 5 root root 47 Jun  8 11:35 elasticsearch
drwxr-xr-x  2 root root  6 Jun 15 13:47 nginx
[root@cicd mydata]# docker run -p 80:80 --name nginx -d nginx:1.10
7217ab7d7ad153960b2d1acebffd3fc02527655e2b0888e8c5d1eb0cebb84a05
[root@cicd mydata]# docker ps -a
CONTAINER ID        IMAGE                 COMMAND                  CREATED                                                                                           STATUS              PORTS                                            NAME                                                                              S
7217ab7d7ad1        nginx:1.10            "nginx -g 'daemon of…"   5 seconds ago                                                                                     Up 4 seconds        0.0.0.0:80->80/tcp, 443/tcp                      ngin                                                                              x
aa707f92c246        elasticsearch:7.4.2   "/usr/local/bin/dock…"   3 minutes ago                                                                                     Up 3 minutes        0.0.0.0:9200->9200/tcp, 0.0.0.0:9300->9300/tcp   elas                                                                              ticsearch
7ab7bf7aa2e5        kibana:7.4.2          "/usr/local/bin/dumb…"   7 days ago                                                                                        Up 5 hours          0.0.0.0:5601->5601/tcp                           kiba                                                                              na
[root@cicd mydata]# docker container cp nginx:/etc/nginx .
[root@cicd mydata]# cd nginx/
[root@cicd nginx]# ll
total 32
drwxr-xr-x 2 root root   26 Mar 27  2017 conf.d
-rw-r--r-- 1 root root 1007 Jan 31  2017 fastcgi_params
-rw-r--r-- 1 root root 2837 Jan 31  2017 koi-utf
-rw-r--r-- 1 root root 2223 Jan 31  2017 koi-win
-rw-r--r-- 1 root root 3957 Jan 31  2017 mime.types
lrwxrwxrwx 1 root root   22 Jan 31  2017 modules -> /usr/lib/nginx/modules
-rw-r--r-- 1 root root  643 Jan 31  2017 nginx.conf
-rw-r--r-- 1 root root  636 Jan 31  2017 scgi_params
-rw-r--r-- 1 root root  664 Jan 31  2017 uwsgi_params
-rw-r--r-- 1 root root 3610 Jan 31  2017 win-utf
[root@cicd nginx]# docker ps -a
CONTAINER ID        IMAGE                 COMMAND                  CREATED              STATUS              PORTS                                            NAMES
7217ab7d7ad1        nginx:1.10            "nginx -g 'daemon of…"   About a minute ago   Up About a minute   0.0.0.0:80->80/tcp, 443/tcp                      nginx
aa707f92c246        elasticsearch:7.4.2   "/usr/local/bin/dock…"   4 minutes ago        Up 4 minutes        0.0.0.0:9200->9200/tcp, 0.0.0.0:9300->9300/tcp   elasticsearch
7ab7bf7aa2e5        kibana:7.4.2          "/usr/local/bin/dumb…"   7 days ago           Up 5 hours          0.0.0.0:5601->5601/tcp                           kibana
[root@cicd nginx]# docker stop 7217ab7d7ad1
7217ab7d7ad1
[root@cicd nginx]# docker rm 7217ab7d7ad1
7217ab7d7ad1
[root@cicd nginx]# cd ..
[root@cicd mydata]# ll
total 0
drwxrwxrwx. 5 root root  47 Jun  8 11:35 elasticsearch
drwxr-xr-x  3 root root 177 Mar 27  2017 nginx
[root@cicd mydata]# mv nginx conf
[root@cicd mydata]# ll
total 0
drwxr-xr-x  3 root root 177 Mar 27  2017 conf
drwxrwxrwx. 5 root root  47 Jun  8 11:35 elasticsearch
[root@cicd mydata]# mkdir nginx
[root@cicd mydata]# mv conf/ nginx/
[root@cicd mydata]# ll
total 0
drwxrwxrwx. 5 root root 47 Jun  8 11:35 elasticsearch
drwxr-xr-x  3 root root 18 Jun 15 13:52 nginx
[root@cicd mydata]# cd nginx/
[root@cicd nginx]# ll
total 0
drwxr-xr-x 3 root root 177 Mar 27  2017 conf
[root@cicd nginx]#
[root@cicd nginx]#
[root@cicd nginx]#
[root@cicd nginx]#
[root@cicd nginx]#
[root@cicd nginx]# docker run -p 80:80 --name nginx \
> -v /mydata/nginx/html:/usr/share/nginx/html  \
> -v /mydata/nginx/logs:/var/log/nginx \
> -v /mydata/nginx/conf/:/etc//nginx \
> -d nginx:1.10
7b3ae8abac8219ac43b99e058fed83d93f3e16db015744369477e99ec134cc16
[root@cicd nginx]# docker ps -l
CONTAINER ID        IMAGE               COMMAND                  CREATED                                                                                      STATUS              PORTS                         NAMES
7b3ae8abac82        nginx:1.10          "nginx -g 'daemon of…"   20 seconds ago                                                                               Up 18 seconds       0.0.0.0:80->80/tcp, 443/tcp   nginx
[root@cicd nginx]# cd html/
[root@cicd html]# ll
total 0
[root@cicd html]# vim index.html
[root@cicd html]# mkdir es
[root@cicd html]# cd es
[root@cicd es]# ll
total 0
[root@cicd es]# vim femci.txt
[root@cicd es]# mv femci.txt fenci.txt
[root@cicd es]# cd /mydata/elasticsearch/plugins/
[root@cicd plugins]# cd ik/config/
[root@cicd config]# ll
total 8260
-rw-r--r-- 1 root root 5225922 Oct  7  2019 extra_main.dic
-rw-r--r-- 1 root root   63188 Oct  7  2019 extra_single_word.dic
-rw-r--r-- 1 root root   63188 Oct  7  2019 extra_single_word_full.dic
-rw-r--r-- 1 root root   10855 Oct  7  2019 extra_single_word_low_freq.dic
-rw-r--r-- 1 root root     156 Oct  7  2019 extra_stopword.dic
-rw-r--r-- 1 root root     625 Oct  7  2019 IKAnalyzer.cfg.xml
-rw-r--r-- 1 root root 3058510 Oct  7  2019 main.dic
-rw-r--r-- 1 root root     123 Oct  7  2019 preposition.dic
-rw-r--r-- 1 root root    1824 Oct  7  2019 quantifier.dic
-rw-r--r-- 1 root root     164 Oct  7  2019 stopword.dic
-rw-r--r-- 1 root root     192 Oct  7  2019 suffix.dic
-rw-r--r-- 1 root root     752 Oct  7  2019 surname.dic
[root@cicd config]# vim IKAnalyzer.cfg.xml
[root@cicd config]# docker ps -a
CONTAINER ID        IMAGE                 COMMAND                  CREATED                                                                                      STATUS              PORTS                                            NAMES
7b3ae8abac82        nginx:1.10            "nginx -g 'daemon of…"   4 minutes ago                                                                                Up 4 minutes        0.0.0.0:80->80/tcp, 443/tcp                      nginx
aa707f92c246        elasticsearch:7.4.2   "/usr/local/bin/dock…"   12 minutes ago                                                                               Up 12 minutes       0.0.0.0:9200->9200/tcp, 0.0.0.0:9300->9300/tcp   elasticsearch
7ab7bf7aa2e5        kibana:7.4.2          "/usr/local/bin/dumb…"   7 days ago                                                                                   Up 5 hours          0.0.0.0:5601->5601/tcp                           kibana
[root@cicd config]# docker restart elasticsearch
elasticsearch
[root@cicd config]#　　
```

然后再进行分词

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYxNjAyMDY0Mjc0OC05NjY1ODg1OTQucG5n)

## 谷粒商城ES调用(十九)

 **125、全文检索-ElasticSearch-整合-SpringBoot整合high-level-client - 127、全文检索-ElasticSearch-整合-测试复杂检索**

Api的调用参考：https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-search.html

```
@SpringBootTest
class GulimallProductApplicationTests {

  @Qualifier("esRestClient")
  @Autowired(required = false)
  private RestHighLevelClient client;

  @Data
  @ToString
  static class Account {
    private int account_number;
    private int balance;
    private String firstname;
    private String lastname;
    private int age;
    private String gender;
    private String address;
    private String employer;
    private String email;
    private String city;
    private String state;
  }
  
  @Test
  void searchData() throws IOException {
    SearchRequest searchRequest = new SearchRequest();
    searchRequest.indices("bank");
    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();

    //构造检索条件
    searchSourceBuilder.query(QueryBuilders.matchQuery("address","mill"));

    //按照年龄进行聚合
    TermsAggregationBuilder termsAggregationBuilder = AggregationBuilders.terms("ageAgg").field("age").size(10);
    searchSourceBuilder.aggregation(termsAggregationBuilder);

    AvgAggregationBuilder avgAggregationBuilder = AggregationBuilders.avg("balanceAgg").field("balance");
    searchSourceBuilder.aggregation(avgAggregationBuilder);

    searchRequest.source(searchSourceBuilder);

    System.out.println(searchSourceBuilder.toString());
    //2。执行构造条件
    SearchResponse searchResponse = client.search(searchRequest,GulimallElasticSearchConfig.COMMON_OPTIONS);
    //分析结果
    System.out.println(searchResponse.toString());
    //拿到响应的结果
    SearchHits hits = searchResponse.getHits();
    SearchHit[] searchHits = hits.getHits();
    for (SearchHit hit : searchHits) {
      String sourceAsString = hit.getSourceAsString();
      Account account = JSON.parseObject(sourceAsString, Account.class);
      System.out.println(account);

    }
    //获取集合的信息
    Aggregations aggregations = searchResponse.getAggregations();
    Terms terms = aggregations.get("ageAgg");
    for (Terms.Bucket bucket : terms.getBuckets()) {
      System.out.println("年龄:"+bucket.getKeyAsString());
    }

    Avg avg = aggregations.get("balanceAgg");
    double value = avg.getValue();
    System.out.println(value);
//    Bucket elasticBucket = byCompanyAggregation.getBucketByKey("Elastic");
//    Avg averageAge = elasticBucket.getAggregations().get("average_age");
//    double avg = averageAge.getValue();

  }

  @Test
  void indexData() throws IOException {
    IndexRequest request = new IndexRequest("users");
    request.id("1");
    User u = new User();
    u.setAge(11);
    u.setGender("男");
    u.setUserName("wgr");
    String s = JSON.toJSONString(u);
    request.source(s, XContentType.JSON);
    IndexResponse indexResponse = client.index(request, GulimallElasticSearchConfig.COMMON_OPTIONS);
    System.out.println(indexResponse);
  }

  @Data
  class User{
    private String userName;
    private String gender;
    private Integer age;
  }

  @Test
  void contextLoads() {
      System.out.println(client);
  }

}
```

结果：

```
{"query":{"match":{"address":{"query":"mill","operator":"OR","prefix_length":0,"max_expansions":50,"fuzzy_transpositions":true,"lenient":false,"zero_terms_query":"NONE","auto_generate_synonyms_phrase_query":true,"boost":1.0}}},"aggregations":{"ageAgg":{"terms":{"field":"age","size":10,"min_doc_count":1,"shard_min_doc_count":0,"show_term_doc_count_error":false,"order":[{"_count":"desc"},{"_key":"asc"}]}},"balanceAgg":{"avg":{"field":"balance"}}}}
{"took":4,"timed_out":false,"_shards":{"total":1,"successful":1,"skipped":0,"failed":0},"hits":{"total":{"value":4,"relation":"eq"},"max_score":5.4032025,"hits":[{"_index":"bank","_type":"account","_id":"970","_score":5.4032025,"_source":{"account_number":970,"balance":19648,"firstname":"Forbes","lastname":"Wallace","age":28,"gender":"M","address":"990 Mill Road","employer":"Pheast","email":"forbeswallace@pheast.com","city":"Lopezo","state":"AK"}},{"_index":"bank","_type":"account","_id":"136","_score":5.4032025,"_source":{"account_number":136,"balance":45801,"firstname":"Winnie","lastname":"Holland","age":38,"gender":"M","address":"198 Mill Lane","employer":"Neteria","email":"winnieholland@neteria.com","city":"Urie","state":"IL"}},{"_index":"bank","_type":"account","_id":"345","_score":5.4032025,"_source":{"account_number":345,"balance":9812,"firstname":"Parker","lastname":"Hines","age":38,"gender":"M","address":"715 Mill Avenue","employer":"Baluba","email":"parkerhines@baluba.com","city":"Blackgum","state":"KY"}},{"_index":"bank","_type":"account","_id":"472","_score":5.4032025,"_source":{"account_number":472,"balance":25571,"firstname":"Lee","lastname":"Long","age":32,"gender":"F","address":"288 Mill Street","employer":"Comverges","email":"leelong@comverges.com","city":"Movico","state":"MT"}}]},"aggregations":{"lterms#ageAgg":{"doc_count_error_upper_bound":0,"sum_other_doc_count":0,"buckets":[{"key":38,"doc_count":2},{"key":28,"doc_count":1},{"key":32,"doc_count":1}]},"avg#balanceAgg":{"value":25208.0}}}
GulimallProductApplicationTests.Account(account_number=970, balance=19648, firstname=Forbes, lastname=Wallace, age=28, gender=M, address=990 Mill Road, employer=Pheast, email=forbeswallace@pheast.com, city=Lopezo, state=AK)
GulimallProductApplicationTests.Account(account_number=136, balance=45801, firstname=Winnie, lastname=Holland, age=38, gender=M, address=198 Mill Lane, employer=Neteria, email=winnieholland@neteria.com, city=Urie, state=IL)
GulimallProductApplicationTests.Account(account_number=345, balance=9812, firstname=Parker, lastname=Hines, age=38, gender=M, address=715 Mill Avenue, employer=Baluba, email=parkerhines@baluba.com, city=Blackgum, state=KY)
GulimallProductApplicationTests.Account(account_number=472, balance=25571, firstname=Lee, lastname=Long, age=32, gender=F, address=288 Mill Street, employer=Comverges, email=leelong@comverges.com, city=Movico, state=MT)
年龄:38
年龄:28
年龄:32
25208.0
```

## 谷粒商城商品上架(二十)

**128 商城业务-商品上架-sku在es中存储模型分析-135 商城业务-商品上架-抽取响应结果&上架测试完成**

主要踩的坑就是上一篇的博客，当数据放到R中，由于是HashMap结构，数据根本拿不到，具体可以看上一篇博客

https://www.cnblogs.com/dalianpai/p/13155540.html

 下面就贴一些主要的代码，后面项目跑起来，在提交到码云上。

```
GET /product/_search



PUT product
{
  "mappings":{
    "properties": {
      "skuId":{
        "type":"long"
      },
      "spuId":{
        "type":"keyword"
      },
      "skuTitle":{
        "type":"text",
        "analyzer": "ik_smart"
      },
      "skuPrice":{
        "type":"keyword"
      },
      "skuImg":{
        "type":"keyword",
        "index":false,
        "doc_values":false
      },
      "saleCount":{
        "type":"long"
      },
      "hasStock":{
        "type":"boolean"
      },
      "hasScore":{
        "type":"long"
      },
      "brandId":{
        "type":"long"
      },
      "catalogId":{
        "type":"long"
      },
      "brandName":{
        "type":"keyword",
        "index":false,
        "doc_values":false
      },
      "brandImg":{
        "type":"keyword",
        "index":false,
        "doc_values":false        
      },
      "catalogName":{
        "type":"keyword",
        "index":false,
        "doc_values":false          
      },
      "attrs":{
        "type":"nested",
        "properties": {
          "attrId":{
            "type":"long"
          },
          "attrName":{
              "type":"keyword",
              "index":false,
              "doc_values":false   
          },
          "attrValue":{
            "type":"keyword"
          }
        }
      }
    }
  }
}
```

上传的主方法

```
  @Override
    public void up(Long spuId) {
        List<SkuInfoEntity>   skuInfoEntities =skuInfoService.getSkusBySpuId(spuId);
       // List<SkuEsModel> uoProducts = new ArrayList<>();
        List<Long> skuIdList = skuInfoEntities.stream().map(SkuInfoEntity::getSkuId).collect(Collectors.toList());

        List<ProductAttrValueEntity> baseAttrs = attrValueService.baseAttrlistforspu(spuId);
        List<Long> attrIds = baseAttrs.stream().map(ProductAttrValueEntity::getAttrId).collect(Collectors.toList());
        List<Long> searchAttrIds = attrService.selectSearchAttrIds(attrIds);

        Set<Long> idSet = new HashSet<>(searchAttrIds);
        List<SkuEsModel.Attrs> attrsList = baseAttrs.stream().filter(item -> idSet.contains(item.getAttrId()))
                .map(item -> {
                    SkuEsModel.Attrs attrs1 = new SkuEsModel.Attrs();
                    BeanUtils.copyProperties(item, attrs1);
                    return attrs1;
                }).collect(Collectors.toList());

        //Feign的远程调用
        Map<Long, Boolean> stockMap = null;
        try {
        R r  = wareFeignService.getSkusHasStock(skuIdList);
        TypeReference<List<SkuHasStockVo>> typeReference = new TypeReference<List<SkuHasStockVo>>() {};
        stockMap = r.getData(typeReference).stream().collect(Collectors.toMap(SkuHasStockVo::getSkuId, SkuHasStockVo::getHasStock));
        System.out.println(stockMap);
                }catch (Exception e){
            log.error("库存远程调用异常,原因：{}",e);
        }
        Map<Long, Boolean> finalStockMap = stockMap;
        List<SkuEsModel> upProducts = skuInfoEntities.stream().map(sku -> {
            SkuEsModel esModel = new SkuEsModel();
            BeanUtils.copyProperties(sku, esModel);
            esModel.setSkuPrice(sku.getPrice());
            esModel.setSkuImg(sku.getSkuDefaultImg());

            //查询品牌和信息的名字
            BrandEntity brandEntity = brandService.getById(esModel.getBrandId());
            esModel.setBrandName(brandEntity.getName());
            esModel.setBrandImg(brandEntity.getLogo());

            CategoryEntity categoryEntity = categoryService.getById(esModel.getCatalogId());
            esModel.setCatalogName(categoryEntity.getName());

            esModel.setAttrs(attrsList);

            esModel.setHotScore(0L);
            if(finalStockMap !=null){
                esModel.setHasStock(finalStockMap.get(sku.getSkuId()));
            }else{
                esModel.setHasStock(true);
            }

            return esModel;
        }).collect(Collectors.toList());

        //将数据存到es中
        R r = searchFeignService.productStatusUp(upProducts);
        if(r.getCode() ==0){
            //修改上架的状态
            baseMapper.updateSpuStatus(spuId, ProductConstant.StatusEnum.SPU_UP.getCode());
        }else{

        }

    }



}
```

最好把每个服务的超时时间设置一下，不然第一次调用或者断点，很容易超时

```
feign:
  client:
    config:
      service-product:
        readTimeout: 6000
        connectTimeout: 6000
        loggerLevel: FULL　　
```

 下面的代码就是ES插入的代码

```
@RequestMapping("/search/save")
@RestController
@Slf4j
public class ElasticSaveController {

    @Autowired
    ProductSaveService productSaveService;

    @PostMapping("/product")
    public R productStatusUp(@RequestBody List<SkuEsModel> skuEsModels) {
        Boolean b = null;
        try {
            b = productSaveService.productStatusUp(skuEsModels);
        } catch (IOException e) {
            log.error("ElasticSaveController商品上架异常;{}",e);
            return R.error(BizCodeEnume.PRODUCT_UP_EXCEPTION.getCode(),BizCodeEnume.PRODUCT_UP_EXCEPTION.getMessage());
        }
        if(!b){
            return R.ok();
        }else{
            return R.error(BizCodeEnume.PRODUCT_UP_EXCEPTION.getCode(),BizCodeEnume.PRODUCT_UP_EXCEPTION.getMessage());
        }

    }
}
@Slf4j
@Service
public class ProductSaveServiceImpl implements ProductSaveService {

    @Autowired
    RestHighLevelClient restHighLevelClient;
    @Override
    public Boolean productStatusUp(List<SkuEsModel> skuEsModels) throws IOException {
           //1.先给es创建索引
        //BulkRequest bulkRequest, RequestOptions options
        BulkRequest bulkRequest = new BulkRequest();
        for (SkuEsModel model:skuEsModels){
            IndexRequest indexRequest = new IndexRequest(EsConstant.PRODUCT_INDEX);
            indexRequest.id(model.getSkuId().toString());
            String s = JSON.toJSONString(model);
            indexRequest.source(s, XContentType.JSON);
            bulkRequest.add(indexRequest);
        }
        BulkResponse bulk = restHighLevelClient.bulk(bulkRequest, GulimallElasticSearchConfig.COMMON_OPTIONS);

        //

        boolean b = bulk.hasFailures();
        List<String> collect = Arrays.stream(bulk.getItems()).map(item -> {
            return item.getId();
        }).collect(Collectors.toList());
        log.info("商品上架成功：{}",collect);

        return b;
    }
}
```

配置类

```
/**
 * @author WGR
 * @create 2020/6/16 -- 17:16
 */
@Configuration
public class GulimallElasticSearchConfig {

    public static final RequestOptions COMMON_OPTIONS;
    static {
        RequestOptions.Builder builder = RequestOptions.DEFAULT.toBuilder();
//        builder.addHeader("Authorization", "Bearer " + TOKEN);
//        builder.setHttpAsyncResponseConsumerFactory(
//                new HttpAsyncResponseConsumerFactory
//                        .HeapBufferedResponseConsumerFactory(30 * 1024 * 1024 * 1024));
        COMMON_OPTIONS = builder.build();
    }

    @Bean
    public RestHighLevelClient esRestClient(){
        RestHighLevelClient client = new RestHighLevelClient(
                RestClient.builder(
                        new HttpHost("192.168.1.119", 9200, "http")));
        return client;
    }
}
```

仓库的服务类

```
    @Override
    public List<SkuHasStockVo> getSkusHasStock(List<Long> skuIds) {
        List<SkuHasStockVo> hasStockVoList = skuIds.stream().map(id -> {
            SkuHasStockVo vo = new SkuHasStockVo();
            Long count = baseMapper.getSkuStock(id);
            vo.setSkuId(id);
            vo.setHasStock(count ==null ?false:count > 0);
            return vo;
        }).collect(Collectors.toList());
        return hasStockVoList;
    }
```

修改后的R类

```
public class R extends HashMap<String, Object> {
    private static final long serialVersionUID = 1L;

    public R setData(Object data) {
        put("data", data);
        return this;
    }

    ///利用fastjson进行逆转
    public <T> T getData(TypeReference<T> typeReference){
        Object data = get("data");//默认是map
        String s = JSON.toJSONString(data);
        T t = JSON.parseObject(s, typeReference);
        return t;
    }
```

 部分截图

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYxODIxMjcwMjQ1OS0xMTE5MzY4MDkxLnBuZw)

 

 

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYxODIxMjcxNDY4OC0yMTM2NDEwOTE1LnBuZw)

## 谷粒商城Nginx转网关(二十一)

 **136、商城业务-首页-整合thymeleaf渲染首页 - 140、商城业务-nginx-搭建域名访问环境二（负载均衡到网关)**

 坑主要出现在我服务器的虚拟机访问不到我的本地访问，所以nginx暂时不能在上面，自己在本地测试的话，就先安装在本地虚拟机上，到后面带上都部署到k8s上，在切换到服务器虚拟机上。

**渲染代码：**

```
    @GetMapping({"/", "index.html"})
    public String indexPage(Model model) {
        List<CategoryEntity> categoryEntities = categoryservice.getLevel1Categorys();
        model.addAttribute("categorys", categoryEntities);
        return "index";
    }

    @ResponseBody
    @GetMapping("/index/catalog.json")
    public Map<String, List<Catalog2Vo>> getCatalogJson() {
        Map<String, List<Catalog2Vo>> map = categoryservice.getCatalogJson();

        return map;
    }
 /**
     * 查询所有一级分类
     *
     * @return
     */
    @Override
    public List<CategoryEntity> getLevel1Categorys() {
        List<CategoryEntity> categoryEntities = baseMapper.selectList(new QueryWrapper<CategoryEntity>().eq("parent_cid", 0));
        return categoryEntities;
    }

    @Override
    public Map<String, List<Catalog2Vo>> getCatalogJson() {
        //查询出所有分类
        List<CategoryEntity> selectList = baseMapper.selectList(null);
        //先查出所有一级分类
        List<CategoryEntity> level1Categorys = getCategorys(selectList, 0L);
        //封装数据 map k,v 结构
        Map<String, List<Catalog2Vo>> map = level1Categorys.stream().collect(Collectors.toMap(k -> k.getCatId().toString(), v -> {
            //每一个的一级分类，查到这个一级分类的二级分类
            List<CategoryEntity> category2Entities = getCategorys(selectList, v.getCatId());
            List<Catalog2Vo> catelog2Vos = null;

            if (category2Entities != null) {
                catelog2Vos = category2Entities.stream().map(level2 -> {
                    //封装catalog2Vo
                    Catalog2Vo catalog2Vo = new Catalog2Vo(v.getCatId().toString(), null, level2.getCatId().toString(), level2.getName());
                    //每一个二级分类，查到三级分类
                    List<CategoryEntity> category3Entities = getCategorys(selectList, level2.getCatId());
                    if (category3Entities != null) {
                        List<Object> catalog3List = category3Entities.stream().map(level3 -> {
                            //封装catalog3Vo
                            Catalog2Vo.Catalog3Vo catalog3Vo = new Catalog2Vo.Catalog3Vo(level2.getCatId().toString(), level3.getCatId().toString(), level3.getName());
                            return catalog3Vo;
                        }).collect(Collectors.toList());
                        //封装catalog3Vo到catalog2Vo
                        catalog2Vo.setCatalog3List(catalog3List);
                    }
                    return catalog2Vo;
                }).collect(Collectors.toList());
            }
            //返回v=catalog2Vo
            return catelog2Vos;
        }));
        return map;
    }

    /**
     * 根据传进分类筛选出对应级别
     *
     * @param list
     * @param parent_cid
     * @return
     */
    public List<CategoryEntity> getCategorys(List<CategoryEntity> list, Long parent_cid) {
        List<CategoryEntity> collect = list.stream().filter(l -> parent_cid.equals(l.getParentCid())).collect(Collectors.toList());
        return collect;
    }
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYxODIzNTQxNTUzMS0yMDg5MTgwODc2LnBuZw)

```
          <ul>
            <li th:each="category:${categorys}">
              <a href="#" class="header_main_left_a" th:attr="ctg-data=${category.catId}"><b th:text="${category.name}">家用电器</b></a>
            </li>
          </ul>
```

**nginx** 

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYxODIzNTYwNjkxMC0yNjQ2MjczNjQucG5n)

```
[root@192 conf.d]# cat gulimall.conf
server {
    listen       80;
    server_name  gulimall.com;

    #charset koi8-r;
    #access_log  /var/log/nginx/log/host.access.log  main;

    location / {
          proxy_set_header Host $host;
           proxy_pass   http://gulimall;
    }

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    root           html;
    #    fastcgi_pass   127.0.0.1:9000;
    #    fastcgi_index  index.php;
    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #    include        fastcgi_params;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}
}

[root@192 conf.d]#
```

 **注：收获最多的就是 proxy_set_header Host $host;如果只配置网关的话，后面加api能路由到商品访问，但是访问不到gulimall。**

 修改网关：

```
      - id: gulimall_host
        uri: lb://gulimall-product
        predicates:
          - Host=**.gulimall.com,gulimall.com
```

***\*要把这个放到最后面，如果放到前面当请求接口的时候，会优先匹配到这个路由，而真正的访问商品访问是要去掉api的。\****

测试如下： 

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYxODIzNTc0NjE0MC02NzUwMTEyOTUucG5n)

 

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYxODIzNTgwNjAzNy0yMDIyNjE5NTI3LnBuZw)

## 谷粒商城缓存(二十三)

### **151、缓存-缓存使用-本地缓存与分布式缓存 - 157、缓存-缓存使用-本地锁在分布式下的问题**

 主要就是把数据缓存到redis中

```
@Override
    //会内存异常，主要就是lettuce的bug，导致内存溢出,它是使用netty进行网络通信
    //luttuce的bug导致netty堆外内存溢出 -Xmx300m;netty如没有指定，默认是-Xmx300m
    //不能使用-Dio.netty.maxDirectMemory只去调大堆外内存
    //1.升级Luttuce客户端， 2切换jedis
    public Map<String, List<Catalog2Vo>> getCatalogJson() {
        String catalogJSON = stringRedisTemplate.opsForValue().get("catalogJSON");
        if(StringUtils.isBlank("catalogJSON") || catalogJSON == null){
            Map<String, List<Catalog2Vo>> catalogJsonFromDb = getCatalogJsonFromDb();
            String s = JSON.toJSONString(catalogJsonFromDb);
            stringRedisTemplate.opsForValue().set("catalogJSON",s,1,TimeUnit.DAYS);
            return catalogJsonFromDb;
        }
        Map<String, List<Catalog2Vo>> map = JSON.parseObject(catalogJSON, new TypeReference<Map<String, List<Catalog2Vo>>>() {
        });
        return map;
    }
```

但是当压测到一定程度的时候，会报内存溢出

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMjE1NDIxMDIxOC0zOTc2Njc1MzAucG5n)

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMjE1NTQ0NzU4My0xMzYwNjY5MzM3LnBuZw)

 修改方式如下：

```
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
            <exclusions>
                <exclusion>
                    <groupId>io.lettuce</groupId>
                    <artifactId>lettuce-core</artifactId>
                </exclusion>
            </exclusions>
        </dependency>

        <dependency>
            <groupId>redis.clients</groupId>
            <artifactId>jedis</artifactId>
        </dependency>
```

 

**然后就是redis几个常见的问题** 

 可以参考这篇博客：https://www.cnblogs.com/dalianpai/p/12678795.html

谷粒商城推荐的方案如下：

1.空结果缓存：解决缓存穿透

2.设置过期时间(加随机值)：解决缓存雪崩

3：加锁解决缓存击穿

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMjIwMDkyNTM0Ni0xNDczMjUzNzY0LnBuZw)

 

 

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMjIwMDk1ODA4Mi0xOTM1MDgzMzAucG5n)

 

 

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMjIwMTA0NjA0OS02NjgxNjUxMjgucG5n)

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMjIwMzQ0MjIzNS0xNjI2Mjg2NTA3LnBuZw)

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMjIwMzUyNjA4Ny0xMTYwNjQ2NjEwLnBuZw) 

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMjIwMjYyOTYyNC03NDQ0MTk2ODAucG5n)

当项目是分布式项目的时候，不适合用本地锁，要改成分布式锁，我之前研究的是redis+lua的方式

具体可以查看之前写的博客

https://www.cnblogs.com/dalianpai/p/12714132.html

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMjIxNTQ1Nzg4NC0xNzA5MTA3MTA2LnBuZw)

## 谷粒商城Redisson分布式锁(二十四)

**159、缓存-分布式锁-Redisson简介&整合 - 166、缓存-分布式锁-缓存一致性解决**

 官网说明:https://github.com/redisson/redisson

 反正也很详细，有说明，也有配置的用法，感兴趣的可以具体看一下。底层也是用到lua脚本

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMzEyMjU1MDI2NS03ODkwOTE3ODYucG5n)

```
    /**
     * 简单请求
     * @return
     */
    @ResponseBody
    @GetMapping("/hello")
    public String hello() {
        RLock rLock = redisson.getLock("my-lock");
        //1.锁的自动续期，如果业务超长，运行期间会自动给锁续上新的30s。不用担心业务时间长，锁自动被删掉
        //2.加锁的业务只要运行完成，就不会给当前锁续期，即使不手动解锁，锁默认在30s以后自动删除。
        //rLock.lock();
        rLock.lock(30, TimeUnit.SECONDS);  //10秒自动解锁，自动解锁时间一定要大于业务的执行时间
        //问题：rLock.lock(10, TimeUnit.SECONDS);  在锁时间到了以后，不会自动续期
        //1.如果我们传递了锁的超时时间，就发送给redis执行脚本，进行占锁，默认超时就是我们指定的时间。
        //2.如果我们未指定锁的超时时间，就使用30*1000的LockWatchTimeout看门狗的默认时间；
        // 只要占锁成功，就会启动一个定时任务，每隔10s都会自动续期
        //建议； rLock.lock(30, TimeUnit.SECONDS); 省掉了续期的时间
        try {
            System.out.println("加锁成功，执行业务"+Thread.currentThread().getId());
            Thread.sleep(30000);
        }catch(Exception e){

        }finally {
            System.out.println("释放锁"+Thread.currentThread().getId());
            rLock.unlock();
        }

        
```

 

**![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMzEyMDYwMDYwNS01OTYzNDY2OC5wbmc)**

 

```
    //保证一定能读到最新数据，修改期间，写锁是一个排他锁(互斥锁)。读锁是一个共享锁
    //写锁没释放读就必须等待
    //读 + 读： 相当于无锁，并发读，只会在redis中记录好，所有当前的读锁。他们都会同时加锁成功
    //写 + 读： 等待写锁释放
    //写 + 写： 阻塞方式
    //读 + 写： 有读锁。写也需要等待
    //只要有写的存在，都必须等待。
    @GetMapping("/write")
    @ResponseBody
    public String writeValue(){
        RReadWriteLock lock = redisson.getReadWriteLock("rw-lock");
        String s = "";
        RLock rLock = lock.writeLock();
        try {
            rLock.lock();
            s = UUID.randomUUID().toString();
            redisTemplate.opsForValue().set("writeValue",s);
        } catch (Exception e) {
            e.printStackTrace();
        }finally {
            rLock.unlock();
        }
        return  s;

    }

    @GetMapping("/read")
    @ResponseBody
    public String read(){
        RReadWriteLock lock = redisson.getReadWriteLock("rw-lock");
        String s = "";
        RLock rLock = lock.readLock();
        try {
            rLock.lock();
            Thread.sleep(30000);
            s = redisTemplate.opsForValue().get("writeValue");
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally {
            rLock.unlock();
        }
        return  s;

    }
```

### 读写锁（ReadWriteLock）

 

基于Redis的Redisson分布式可重入读写锁`RReadWriteLock` Java对象实现了`java.util.concurrent.locks.ReadWriteLock`接口。其中读锁和写锁都继承了RLock接口。

 

分布式可重入读写锁允许同时有多个读锁和一个写锁处于加锁状态。

 

```
RReadWriteLock rwlock = redisson.getReadWriteLock("anyRWLock");
// 最常见的使用方法
rwlock.readLock().lock();
// 或
rwlock.writeLock().lock();
```

 

 

大家都知道，如果负责储存这个分布式锁的Redis节点宕机以后，而且这个锁正好处于锁住的状态时，这个锁会出现锁死的状态。为了避免这种情况的发生，Redisson内部提供了一个监控锁的看门狗，它的作用是在Redisson实例被关闭前，不断的延长锁的有效期。默认情况下，看门狗的检查锁的超时时间是30秒钟，也可以通过修改Config.lockWatchdogTimeout来另行指定。

 

另外Redisson还通过加锁的方法提供了`leaseTime`的参数来指定加锁的时间。超过这个时间后锁便自动解开了。

 

```
// 10秒钟以后自动解锁
// 无需调用unlock方法手动解锁
rwlock.readLock().lock(10, TimeUnit.SECONDS);
// 或
rwlock.writeLock().lock(10, TimeUnit.SECONDS);

// 尝试加锁，最多等待100秒，上锁以后10秒自动解锁
boolean res = rwlock.readLock().tryLock(100, 10, TimeUnit.SECONDS);
// 或
boolean res = rwlock.writeLock().tryLock(100, 10, TimeUnit.SECONDS);
...
lock.unlock();
```

### 闭锁（CountDownLatch）

基于Redisson的Redisson分布式闭锁（CountDownLatch）Java对象`RCountDownLatch`采用了与`java.util.concurrent.CountDownLatch`相似的接口和用法。

```
RCountDownLatch latch = redisson.getCountDownLatch("anyCountDownLatch");
latch.trySetCount(1);
latch.await();

// 在其他线程或其他JVM里
RCountDownLatch latch = redisson.getCountDownLatch("anyCountDownLatch");
latch.countDown();
    @GetMapping("/lockDoor")
    @ResponseBody
    public  String lockDoor () throws InterruptedException {
        RCountDownLatch door = redisson.getCountDownLatch("door");
        door.trySetCount(5);
        door.await();
        return "放假了。。。";
    }

    @GetMapping("/gogogo/{id}")
    @ResponseBody
    public String gogogo(@PathVariable("id") Long id){
        RCountDownLatch door = redisson.getCountDownLatch("door");
        door.countDown();
        return id+"班的人都走了";
    }
```

### 信号量（Semaphore）

基于Redis的Redisson的分布式信号量（Semaphore）Java对象`RSemaphore`采用了与`java.util.concurrent.Semaphore`相似的接口和用法。同时还提供了异步（Async）、反射式（Reactive）和RxJava2标准的接口。

```
RSemaphore semaphore = redisson.getSemaphore("semaphore");
semaphore.acquire();
//或
semaphore.acquireAsync();
semaphore.acquire(23);
semaphore.tryAcquire();
//或
semaphore.tryAcquireAsync();
semaphore.tryAcquire(23, TimeUnit.SECONDS);
//或
semaphore.tryAcquireAsync(23, TimeUnit.SECONDS);
semaphore.release(10);
semaphore.release();
//或
semaphore.releaseAsync();
```

 

 加上Redisson锁

```
    //Redisson加上分布式锁
    public Map<String, List<Catalog2Vo>> getCatalogJsonFromDbRedissonLock() {
        RLock lock = redisson.getLock("catalogSon-lock");
        lock.lock();
        log.info("分布式加锁成功");
        Map<String, List<Catalog2Vo>> dataFromDb;
        try{
            dataFromDb = getDataFromDb();
        }finally{
            lock.unlock();
            log.info("分布式解锁成功");
        }
        return dataFromDb;
    }
```

 

 解决方案：

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMzE3MzE1MjYwNS0xMDI5MjYzNjczLnBuZw)

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMzE3NTExMjI0OS0xNTUzODg5Mzg3LnBuZw)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMzE3NDA0NDY2Ni0zMTgzMzU3NTUucG5n)

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyMzE3NDUyMDEyMS0xNTk4MzcwNjg3LnBuZw)

 canal还是很有用的，等后面扩大了服务器的内存，在加入一下。

##  谷粒商城创建Redis集群(二十五)

所有的命令如下：

```
for port in $(seq 7001 7006);  \
do \
mkdir -p /mydata/redis/node-${port}/conf
touch /mydata/redis/node-${port}/conf/redis.conf
cat << EOF > /mydata/redis/node-${port}/conf/redis.conf
port ${port}
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
cluster-announce-ip 192.168.1.119
cluster-announce-port ${port}
cluster-announce-bus-port 1${port}
appendonly yes
EOF
docker run -p ${port}:${port} -p 1${port}:1${port} --name redis-${port}  \
-v /mydata/redis/node-${port}/data:/data \
-v /mydata/redis/node-${port}/conf/redis.conf:/etc/redis/redis.conf \
-d redis:5.0.7 redis-server /etc/redis/redis.conf; \
done



docker exec -it redis-7001 bash 
redis-cli  --cluster create 192.168.1.119:7001 192.168.1.119:7002 192.168.1.119:7003 192.168.1.119:7004 192.168.1.119:7005 192.168.1.119:7006
  --cluster-replicas 1
```

 创建集群的图如下：

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyNjAwMzQxODYyNi03NTY0ODU2ODYucG5n)

 演示故障的上下线

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyNjAwNDYyOTQyNy0yMDczMDY4NTE4LnBuZw)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyNjAwNDgzNzUwOC05NzIyMjgzOC5wbmc)

## 谷粒商城创建Rabbitmq集群(二十六)

**369、集群-RabbitMQ-镜像集群搭建**

```
docker run -d --hostname rabbitmq01  --name rabbitmq01 \
-v /mydata/rabbitmq/rabbitmq01:/var/lib/rabbitmq  -p \
15672:15672 -p 5672:5672 -e RABBITMQ_ERLANG_COOKIE='dalianpai' \
rabbitmq:management

[root@cicd ~]# docker run -d --hostname rabbitmq02  --name rabbitmq02 -v /mydata/rabbitmq/rabbitmq02:/var/lib/rabbitmq  -p 15674:15672 -p 5674:5672 -e RABBITMQ_ERLANG_COOKIE='dalianpai' --link rabbitmq01:rabbitmq01  rabbitmq:management
ae25c092e6f5cadd37f8ac6b4ed76aaab04a43605aaf3d739d8e053148b8cf4c
You have mail in /var/spool/mail/root



[root@cicd mail]# docker run -d --hostname rabbitmq03  --name rabbitmq03 -v /mydata/rabbitmq/rabbitmq03:/var/lib/rabbitmq  -p 15675:15672 -p 5675:5672 -e RABBITMQ_ERLANG_COOKIE='dalianpai' --link rabbitmq01:rabbitmq01  --link rabbitmq02:rabbitmq02  rabbitmq:management
2ca59e853b3908f0e368bf7f3ce8368b6e180993169b6ab388d5056a8a5535a0
[root@cicd mail]# docker ps -a



[root@cicd mail]# docker exec -it rabbitmq01 /bin/bash
root@rabbitmq01:/# rabbitmqctl stop_app
Stopping rabbit application on node rabbit@rabbitmq01 ...
root@rabbitmq01:/# rabbitmqctl reset
Resetting node rabbit@rabbitmq01 ...
root@rabbitmq01:/# rabbitmqctl start_app
Starting node rabbit@rabbitmq01 ...
root@rabbitmq01:/#

[root@cicd mail]# docker exec -it rabbitmq02 /bin/bash
root@rabbitmq02:/# rabbitmqctl stop_app
Stopping rabbit application on node rabbit@rabbitmq02 ...
root@rabbitmq02:/# rabbitmqctl reset
Resetting node rabbit@rabbitmq02 ...
root@rabbitmq02:/# rabbitmqctl join_cluster --ram rabbit@rabbitmq01
Clustering node rabbit@rabbitmq02 with rabbit@rabbitmq01
root@rabbitmq02:/# rabbitmqctl start_app
Starting node rabbit@rabbitmq02 ...
root@rabbitmq02:/# exit
exit



[root@cicd mail]# docker exec -it rabbitmq03 /bin/bash
root@rabbitmq03:/# rabbitmqctl stop_app
Stopping rabbit application on node rabbit@rabbitmq03 ...
root@rabbitmq03:/# rabbitmqctl reset
Resetting node rabbit@rabbitmq03 ...
root@rabbitmq03:/# rabbitmqctl join_cluster --ram rabbit@rabbitmq01
Clustering node rabbit@rabbitmq03 with rabbit@rabbitmq01
root@rabbitmq03:/#  rabbitmqctl start_app
Starting node rabbit@rabbitmq03 ...
root@rabbitmq03:/# exit
exit
[root@cicd mail]#


[root@cicd mail]# docker exec -it rabbitmq01 /bin/bash
root@rabbitmq01:/# rabbitmqctl set_policy -p / ha "^" '{"ha-mode":"all","ha-sync-mode":"automatic"}'                                                          Setting policy "ha" for pattern "^" to "{"ha-mode":"all","ha-sync-mode":"automatic"}" with priority "0" for vhost "/" ...
root@rabbitmq01:/# rabbitmqctl  list_policies -p /
Listing policies for vhost "/" ...
vhost   name    pattern apply-to        definition      priority
/       ha      ^       all     {"ha-mode":"all","ha-sync-mode":"automatic"}   
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyNzAwNTAyNDMxMC0xMDY4MDA3NDg3LnBuZw)

## 谷粒商城创建ES集群(二十七)

**367、集群-ElasticSearch-集群原理--368、集群-ElasticSearch-集群搭建**

```
for port in $(seq 1 3); \
do \
mkdir -p /mydata/elasticsearch/master-${port}/config
mkdir -p /mydata/elasticsearch/master-${port}/data
chmod -R 777 /mydata/elasticsearch/master-${port}
cat << EOF > /mydata/elasticsearch/master-${port}/config/elasticsearch.yml
cluster.name: my-es  #集群的名称，同一个集群该值必须设置成相同的
node.name: es-master-${port}  #该节点的名字
node.master: true  #该节点有机会成为master节点
node.data: false #该节点可以存储数据
network.host: 0.0.0.0
http.host: 0.0.0.0   #所有http均可访问
http.port: 920${port}
transport.tcp.port: 930${port}
discovery.zen.ping_timeout: 10s #设置集群中自动发现其他节点时ping连接的超时时间
discovery.seed_hosts: ["172.19.1.21:9301","172.19.1.22:9302","172.19.1.23:9303"]
cluster.initial_master_nodes: ["172.19.1.21"] #新集群初始时的候选主节点，es7的新增配置
EOF
docker run --name elasticsearch-node-${port} \
-p 920${port}:920${port} -p 930${port}:930${port} \
--network=mynet --ip 172.19.1.2${port} \
-e ES_JAVA_OPTS="-Xms300m -Xmx300m"  \
-v /mydata/elasticsearch/master-${port}/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml  \
-v /mydata/elasticsearch/master-${port}/data:/usr/share/elasticsearch/data  \
-v /mydata/elasticsearch/master-${port}/plugins:/usr/share/elasticsearch/plugins  \
-d elasticsearch:7.4.2
done

for port in $(seq 4 6); \
do \
mkdir -p /mydata/elasticsearch/master-${port}/config
mkdir -p /mydata/elasticsearch/master-${port}/data
chmod -R 777 /mydata/elasticsearch/master-${port}
cat << EOF > /mydata/elasticsearch/master-${port}/config/elasticsearch.yml
cluster.name: my-es  #集群的名称，同一个集群该值必须设置成相同的
node.name: es-node-${port}  #该节点的名字
node.master: false  #该节点有机会成为master节点
node.data: true #该节点可以存储数据
network.host: 0.0.0.0
http.host: 0.0.0.0   #所有http均可访问
http.port: 920${port}
transport.tcp.port: 930${port}
discovery.zen.ping_timeout: 10s #设置集群中自动发现其他节点时ping连接的超时时间
discovery.seed_hosts: ["172.19.1.21:9301","172.19.1.22:9302","172.19.1.23:9303"]
cluster.initial_master_nodes: ["172.19.1.21"] #新集群初始时的候选主节点，es7的新增配置
EOF
docker run --name elasticsearch-node-${port} \
-p 920${port}:920${port} -p 930${port}:930${port} \
--network=mynet --ip 172.19.1.2${port} \
-e ES_JAVA_OPTS="-Xms300m -Xmx300m"  \
-v /mydata/elasticsearch/master-${port}/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml  \
-v /mydata/elasticsearch/master-${port}/data:/usr/share/elasticsearch/data  \
-v /mydata/elasticsearch/master-${port}/plugins:/usr/share/elasticsearch/plugins  \
-d elasticsearch:7.4.2
done


docker network create  --driver bridge --subnet=172.19.1.0/16 --gateway=172.19.0.1 mynet
```

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyODEyNTEwMTI5OS0xMjM5OTU5MTA0LnBuZw)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyODEyNTEyMzk0Ni0xNjkzOTY2MjQxLnBuZw)

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyODEyNTEzMjY2NC0xODc0NzQ4MDQxLnBuZw)

## 谷粒商城K8s部署中间件(二十八)

**371、部署-k8s部署MySQL - 377、部署-k8s部署Sentinel**

 按照视频跟着做就行了，其中是nacos比较特殊点，一开始创建的是有状态服务，然后删掉服务，在指定NodePort。

下面就简单贴出来几个图，其中里面的命令脚本，我之前的博客也简单记录了一下，可以往前翻翻。

做的时候也很顺利，有问题的话可以探讨一下

访问mysql的DNS

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyODE1MTUxNTgxMy0yMDQ4Nzc2NjcucG5n)

 mysql的主从

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyODE1NDAxNDM0OS00MDEzOTU2MDgucG5n)

 ES

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyODE4NDI1OTY2Ni0xMTk0ODk4Mjc3LnBuZw)

 

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyODIxMDExNDg2NS0zMTc5NTcyNjIucG5n)

## 谷粒商城SpringCache缓存(二十九)

**167、缓存-SpringCache-简介-172、缓存-SpringCache-原理与不足**

 感觉也比较简单，视频中也是跟着官网的介绍做的，可以参考前面一篇的中文翻译。

主要代码如下：

```
/**
     * 级联更新所有关联的数据
     * @param category
     */
    @Transactional
    @Override
//    @Caching( evict ={
//            @CacheEvict(value={"category"},key = "'getLevel1Categorys'"),
//            @CacheEvict(value={"category"},key = "'getCatalogJson''")
//    })
    @CacheEvict(value ="category",allEntries = true)
    public void updateCascade(CategoryEntity category) {
        this.updateById(category);
        categoryBrandRelationService.updateCategory(category.getCatId(),category.getName());
    }

    /**
     * 查询所有一级分类
     *
     * @return
     */
   // @Cacheable(value={"category"},key = "'level1Categorys'")
    //代表当前结果需要缓存，如果有就不需要缓存，没有则缓存
    @Cacheable(value={"category"},key = "#root.method.name")
    @Override
    public List<CategoryEntity> getLevel1Categorys() {
        List<CategoryEntity> categoryEntities = baseMapper.selectList(new QueryWrapper<CategoryEntity>().eq("parent_cid", 0));
        return categoryEntities;
    }

    public Boolean lock(String key, String value,String luaPath) throws IOException {
        DefaultRedisScript<Boolean> lockScript = new DefaultRedisScript<>();
        ClassPathResource resource = new ClassPathResource(luaPath);
        ResourceScriptSource source = new ResourceScriptSource(resource);
        lockScript.setScriptSource(source);
        lockScript.setResultType(Boolean.class);
        Boolean result = (Boolean) stringRedisTemplate.execute(lockScript, Arrays.asList(key, value));
        return result;
    }


    @Override
    @Cacheable(value={"category"},key = "#root.method.name")
    public Map<String, List<Catalog2Vo>> getCatalogJson() {
        //查询出所有分类
        List<CategoryEntity> selectList = baseMapper.selectList(null);
        //先查出所有一级分类
        List<CategoryEntity> level1Categorys = getCategorys(selectList, 0L);
        //封装数据 map k,v 结构
        Map<String, List<Catalog2Vo>> map = level1Categorys.stream().collect(Collectors.toMap(k -> k.getCatId().toString(), v -> {
            //每一个的一级分类，查到这个一级分类的二级分类
            List<CategoryEntity> category2Entities = getCategorys(selectList, v.getCatId());
            List<Catalog2Vo> catelog2Vos = null;

            if (category2Entities != null) {
                catelog2Vos = category2Entities.stream().map(level2 -> {
                    //封装catalog2Vo
                    Catalog2Vo catalog2Vo = new Catalog2Vo(v.getCatId().toString(), null, level2.getCatId().toString(), level2.getName());
                    //每一个二级分类，查到三级分类
                    List<CategoryEntity> category3Entities = getCategorys(selectList, level2.getCatId());
                    if (category3Entities != null) {
                        List<Object> catalog3List = category3Entities.stream().map(level3 -> {
                            //封装catalog3Vo
                            Catalog2Vo.Catalog3Vo catalog3Vo = new Catalog2Vo.Catalog3Vo(level2.getCatId().toString(), level3.getCatId().toString(), level3.getName());
                            return catalog3Vo;
                        }).collect(Collectors.toList());
                        //封装catalog3Vo到catalog2Vo
                        catalog2Vo.setCatalog3List(catalog3List);
                    }
                    return catalog2Vo;
                }).collect(Collectors.toList());
            }
            //返回v=catalog2Vo
            return catelog2Vos;
        }));

        return map;

    }
```

演示的结果图：

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyODIxMjM0NzY1My02MDI5Mzg0MTQucG5n)

 修改数据，缓存消失：

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyODIxMjg1MDcwOC0xMDU3MzY0NTMxLnBuZw)

 在刷新首页，缓存修改后的数据

 ![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDYvMTgyOTc4NS0yMDIwMDYyODIxMzAwNjY4NS0xMTg0MjQwNjU5LnBuZw)

 总结如下：

 

```
/**
 * Spirng-Cache的不足
 * 1）读模式：
 *    缓存穿透：查询一个null数据。解决：缓存空数据：cache-null-values=true
 *    缓存击穿：大量并发进来同时查询一个正好过期的数据。解决：加锁，默认无锁，sync=true
 *    缓存雪崩：大量的key同时过期。解决：加随机时间。加上过期时间 spring.cache.redis.time-to-live=3600000
 *  2）写模式：（缓存与数据库一致）
 *    1：写入加锁
 *    2：引入canal，感受到mysql的变化
 *    3：读多写多，直接去数据库查询就行
 *  总结：
 *    常规数据（读多写少，即时性，一致性要求不高的数据，完全可以使用spring-cache）
 *    特殊数据：特殊设计
 */

//@MapperScan("com.dalianpai.gulimall.product.dao")
@ComponentScan("com.dalianpai")
@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients("com.dalianpai.gulimall.product.feign")
public class GulimallProductApplication {

    public static void main(String[] args) {
        SpringApplication.run(GulimallProductApplication.class, args);
    }

}
```

## 谷粒商城检索服务(三十)

**173、商城业务-检索服务-搭建页面环境 - 192、商城业务-检索服务-条件筛选联动**

敲完代码，感觉ES的复杂查询还不是很熟练，不过应用的也比较简单，权重和分词都没有应用到，ES后面要在好好学习，在把功能完善一下，下面就简单的贴出点代码。

#### web层

```java
/**



 * @author WGR



 * @create 2020/6/29 -- 19:53



 */



@Controller



public class SearchController {



 



    @Autowired



    private MallSearchService mallSearchService;



 



    @GetMapping("/list.html")



    public String listPage(SearchParam param, Model model, HttpServletRequest request){



        String queryString = request.getQueryString();



        param.set_queryString(queryString);



        SearchResult result = mallSearchService.search(param);



        model.addAttribute("result",result);



        return "list";



    }



}
```

#### service层

```java
/**



 * @author WGR



 * @create 2020/6/29 -- 21:00



 */



 



@Service



@Slf4j



public class MallSearchServiceImpl implements MallSearchService {



 



    @Autowired(required = false)



    private  RestHighLevelClient client;



    @Autowired(required = false)



    ProductFeignService productFeignService;



 



    @Override



    public SearchResult search(SearchParam param) {



        SearchResult result = null;



 



        //1.准备检索请求



        SearchRequest searchRequest = buildSearchRequest(param);



 



 



        try {



            SearchResponse response = client.search(searchRequest, GulimallElasticSearchConfig.COMMON_OPTIONS);



            result =  buildSearchResult(response,param);



        } catch (IOException e) {



            e.printStackTrace();



        }



        log.info("{}",result);



        return result;



    }



 



    public SearchResult buildSearchResult(SearchResponse response,SearchParam param) {



        SearchResult result = new SearchResult();



        SearchHits hits = response.getHits();



        //返回所有查询的结果



        List<SkuEsModel> esModels = new ArrayList<>();



        if(hits.getHits() !=null && hits.getHits().length > 0){



            for(SearchHit hit: hits.getHits()){



                String source = hit.getSourceAsString();



                SkuEsModel skuEsModel = JSON.parseObject(source, SkuEsModel.class);



                if(!StringUtils.isEmpty(param.getKeyword())){



                    HighlightField skuTitle = hit.getHighlightFields().get("skuTitle");



                    String string = skuTitle.getFragments()[0].string();



                    skuEsModel.setSkuTitle(string);



                }



                esModels.add(skuEsModel);



            }



        }



        result.setProducts(esModels);



 



 



        //2 当前所有商品涉及到的所有属性信息



        List<SearchResult.AttrVo> attrVos = new ArrayList<>();



        ParsedNested attr_agg = response.getAggregations().get("attr_agg");



        ParsedLongTerms attr_id_agg = attr_agg.getAggregations().get("attr_id_agg");



        for (Terms.Bucket bucket : attr_id_agg.getBuckets()) {



            SearchResult.AttrVo attrVo = new SearchResult.AttrVo();



            //1. 得到属性的id



            long attrId = bucket.getKeyAsNumber().longValue();



            //2. 得到属性的名字



            String attrName = ((ParsedStringTerms) bucket.getAggregations().get("attr_name_agg")).getBuckets().get(0).getKeyAsString();



            //3. 得到属性的所有值



            List<String> attrValues = ((ParsedStringTerms) bucket.getAggregations().get("attr_value_agg")).getBuckets().stream().map(item -> {



                String keyAsString = ((Terms.Bucket) item).getKeyAsString();



                return keyAsString;



            }).collect(Collectors.toList());



 



            attrVo.setAttrId(attrId);



            attrVo.setAttrName(attrName);



            attrVo.setAttrValue(attrValues);



 



            attrVos.add(attrVo);



 



        }



        result.setAttrs(attrVos);



 



        //3 当前所有商品涉及到的所有品牌信息



        List<SearchResult.BrandVo> brandVos = new ArrayList<>();



        ParsedLongTerms brand_agg = response.getAggregations().get("brand_agg");



        for (Terms.Bucket bucket : brand_agg.getBuckets()) {



            SearchResult.BrandVo brandVo = new SearchResult.BrandVo();



            //1.得到品牌id



            long brandId = bucket.getKeyAsNumber().longValue();



            //2. 得到品牌名



            String brandName = ((ParsedStringTerms) bucket.getAggregations().get("brand_name_agg")).getBuckets().get(0).getKeyAsString();



 



            String brandImg = ((ParsedStringTerms) bucket.getAggregations().get("brand_img_agg")).getBuckets().get(0).getKeyAsString();



             brandVo.setBrandId(brandId);



 



            brandVo.setBrandName(brandName);



            brandVo.setBrandImg(brandImg);



            brandVos.add(brandVo);



        }



        result.setBrands(brandVos);



 



        //4 当前所有商品涉及到的所有分类信息



        ParsedLongTerms catalog_agg = response.getAggregations().get("catalog_agg");



        List<SearchResult.CatalogVo> catalogVos = new ArrayList<>();



        List<? extends Terms.Bucket> buckets = catalog_agg.getBuckets();



        for (Terms.Bucket bucket : buckets) {



            SearchResult.CatalogVo catalogVo = new SearchResult.CatalogVo();



            String keyAsString = bucket.getKeyAsString();



            catalogVo.setCatalogId(Long.parseLong(keyAsString));



            //得到分类名



            ParsedStringTerms catalog_name_agg = bucket.getAggregations().get("catalog_name_agg");



            String catalog_name = catalog_name_agg.getBuckets().get(0).getKeyAsString();



            catalogVo.setCatalogName(catalog_name);



 



            catalogVos.add(catalogVo);



        }



        result.setCatalogs(catalogVos);



 



        //5.分页信息-总页数-计算  11/2



        result.setPageNum(param.getPageNum());



        long total = hits.getTotalHits().value;



        result.setTotal(total);



        //5. 分页信息-总页码-计算  11/2 =



        int totalPages = ((int) total % EsConstant.PRODUCT_PAGESIZE) == 0 ? ((int) total / EsConstant.PRODUCT_PAGESIZE) : ((int) total / EsConstant.PRODUCT_PAGESIZE + 1);



        result.setTotalPages(totalPages);



 



 



 



        List<Integer> pageNavs = new ArrayList<>();



        for (int i = 1; i <totalPages +1 ; i++) {



            pageNavs.add(i);



        }



        result.setPageNavs(pageNavs);



 



        if(param.getAttrs()!=null && param.getAttrs().size()>0){



            List<SearchResult.NavVo> collect = param.getAttrs().stream().map(attr ->{



                SearchResult.NavVo navVo = new SearchResult.NavVo();



 



                String[] s = attr.split("_");



                navVo.setNavValue(s[1]);



                R r = productFeignService.attrInfo(Long.parseLong(s[0]));



                result.getAttrIds().add(Long.parseLong(s[0]));



                if(r.getCode() ==0 ){



                    AttrResponseVo data = r.getData("attr", new TypeReference<AttrResponseVo>() {



                    });



                    navVo.setNavName(data.getAttrName());



                }else{



                    navVo.setNavName(s[0]);



                }



 



                String replace = replaceQueryString(param, attr,"attrs");



                navVo.setLink("http://search.gulimall.com/list.html?"+replace);



                System.out.println(navVo.getLink());



                return navVo;



            }).collect(Collectors.toList());



 



            result.setNavs(collect);



        }



 



        if(param.getBrandId()!=null && param.getBrandId().size()>0){



            List<SearchResult.NavVo> navs = result.getNavs();



            SearchResult.NavVo navVo = new SearchResult.NavVo();



            navVo.setNavName("品牌");



            R r = productFeignService.brandsInfo(param.getBrandId());



            if(r.getCode() ==0 ){



                System.out.println(r);



                List<BrandVo> brand = r.getData("brand", new TypeReference<List<BrandVo>>() {



                });



                StringBuffer sb = new StringBuffer();



                String replace ="";



                for (BrandVo brandVo : brand) {



                    sb.append(brandVo.getName()+";");



                    replace = replaceQueryString(param, brandVo.getBrandId()+"","brandId");



                }



                navVo.setNavValue(sb.toString());



                navVo.setLink("http://search.gulimall.com/list.html?"+replace);



            }



            navs.add(navVo);



        }



 



        return result;



    }



 



    private String replaceQueryString(SearchParam param, String value,String key) {



        String encode = null;



 



        try {



            encode = URLEncoder.encode(value,"UTF-8");



            encode = encode.replace("+","%20"); //浏览器差异



        } catch (UnsupportedEncodingException e) {



            e.printStackTrace();



        }



        return param.get_queryString().replace("&"+key+"="+encode,"");



    }



 



    /**



     * 准备检索请求



     * 模糊匹配，过滤(按照属性，分类，品牌，价格区间，库存)，排序，分页，高亮，聚合分析



     * @param param



     * @return



     */



    private SearchRequest buildSearchRequest(SearchParam param) {



        SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();



        /**



         * 模糊匹配，过滤(按照属性，分类，品牌，价格区间，库存)



         */



        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();



        //MUST的模糊匹配



        if(StringUtils.isNotBlank(param.getKeyword())){



            boolQuery.must(QueryBuilders.matchQuery("skuTitle",param.getKeyword()));



        }



        //filter  按照三级分类id查询



        if(param.getCatalog3Id() !=null){



            boolQuery.filter(QueryBuilders.termQuery("catalogId",param.getCatalog3Id()));



        }



        //按照品牌id查询



        if(param.getBrandId() !=null && param.getBrandId().size()>0){



            boolQuery.filter(QueryBuilders.termsQuery("brandId",param.getBrandId()));



        }



 



        //按照所有指定的属性进行查询



        if(param.getAttrs()!=null && param.getAttrs().size()>0){



            for (String attrStr: param.getAttrs()){



                BoolQueryBuilder nestedboolQuery = QueryBuilders.boolQuery();



                String[] s = attrStr.split("_");



                String attrId = s[0];



                String[] attrValues = s[1].split(":");



                nestedboolQuery.must(QueryBuilders.termsQuery("attrs.attrId",attrId));



                nestedboolQuery.must(QueryBuilders.termsQuery("attrs.attrValue",attrValues));



                NestedQueryBuilder nestedQuery = QueryBuilders.nestedQuery("attrs", nestedboolQuery, ScoreMode.None);



                boolQuery.filter(nestedQuery);



            }



 



        }



 



 



        //根据库存来查



        if(param.getHasStock()!=null){



            boolQuery.filter(QueryBuilders.termQuery("hasStock",param.getHasStock()==1));



        }



        if(StringUtils.isNotBlank(param.getSkuPrice())){



            RangeQueryBuilder rangeQuery = QueryBuilders.rangeQuery("skuPrice");



 



            String[] s = param.getSkuPrice().split("_");



            if(s.length == 2){



                rangeQuery.gte(s[0]).lte(s[1]);



            }else  if (s.length ==1){



                if(param.getSkuPrice().startsWith("_")){



                    rangeQuery.lte(s[0]);



                }



 



                if(param.getSkuPrice().endsWith("_")){



                    rangeQuery.gte(s[0]);



                }



            }



            boolQuery.filter(rangeQuery);



        }



 



        sourceBuilder.query(boolQuery);



        //排序，分页，高亮



        // 排序



        if(StringUtils.isNotBlank(param.getSort())){



            String sort = param.getSort();



            String[] s = sort.split("_");



            SortOrder order = s[1].equalsIgnoreCase("asc") ? SortOrder.ASC : SortOrder.DESC;



            sourceBuilder.sort(s[0],order);



        }



        sourceBuilder.from((param.getPageNum()-1)* EsConstant.PRODUCT_PAGESIZE);



        sourceBuilder.size(EsConstant.PRODUCT_PAGESIZE);



 



        //高亮



        if(StringUtils.isNotBlank(param.getKeyword())){



            HighlightBuilder builder = new HighlightBuilder();



            builder.field("skuTitle");



            builder.preTags("<b style='color:red'>");



            builder.postTags("</b>");



            sourceBuilder.highlighter(builder);



        }



 



        //聚合



        TermsAggregationBuilder brand_agg = AggregationBuilders.terms("brand_agg");



        brand_agg.field("brandId").size(50);



        //品牌聚合的子聚合



        brand_agg.subAggregation(AggregationBuilders.terms("brand_name_agg").field("brandName").size(1));



        brand_agg.subAggregation(AggregationBuilders.terms("brand_img_agg").field("brandImg").size(1));



        sourceBuilder.aggregation(brand_agg);



        //分类聚合 catalog_agg



        TermsAggregationBuilder catalog_agg = AggregationBuilders.terms("catalog_agg").field("catalogId").size(20);



        catalog_agg.subAggregation(AggregationBuilders.terms("catalog_name_agg").field("catalogName").size(1));



        sourceBuilder.aggregation(catalog_agg);



        //属性聚合



        NestedAggregationBuilder attr_agg = AggregationBuilders.nested("attr_agg", "attrs");



        TermsAggregationBuilder attr_id_agg = AggregationBuilders.terms("attr_id_agg").field("attrs.attrId");



        attr_id_agg.subAggregation(AggregationBuilders.terms("attr_name_agg").field("attrs.attrName").size(1));



        attr_id_agg.subAggregation(AggregationBuilders.terms("attr_value_agg").field("attrs.attrValue").size(50));



        attr_agg.subAggregation(attr_id_agg);



        sourceBuilder.aggregation(attr_agg);



 



        String s = sourceBuilder.toString();



        log.info(s);



        SearchRequest searchRequest = new SearchRequest(new String[]{EsConstant.PRODUCT_INDEX},sourceBuilder);



        return searchRequest;



    }



}
```

#### Fegin层

```java
/**



 * @author WGR



 * @create 2020/7/1 -- 22:46



 */



@FeignClient("gulimall-product")



public interface ProductFeignService {



 



    @GetMapping("/product/attr/info/{attrId}")



    public R attrInfo(@PathVariable("attrId") Long attrId);



 



    @RequestMapping("/product/brand/infos")



    public R brandsInfo(@RequestParam("brandIds") List<Long> brandIds);



}
```

#### html

```html
<!DOCTYPE html>



<html lang="en" xmlns:th="http://www.thymeleaf.org">



<head>



    <meta charset="UTF-8">



    <meta name="viewport"



          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">



    <meta http-equiv="X-UA-Compatible" content="ie=edge">



    <link rel="stylesheet" href="/static/search/css/index.css">



    <link rel="stylesheet" type="text/css" href="/static/search/font/iconfont.css">



    <!--<script src="/static/search/./js/jquery-3.2.1.min.js"></script>-->



    <script src="/static/search/js/jquery-1.12.4.js"></script>



    <title>Document</title>



</head>



<body>



<!--头部-->



<div class="header_head">



    <div class="header_head_box">



        <b class="header_head_p">



            <div style="overflow: hidden">



                <a href="http://gulimall.com" class="header_head_p_a1" style="width:73px;">



                    谷粒商城首页



                </a>



                <a href="/static/search/#" class="header_head_p_a">



                    <!--<img src="/static/search/img/img_05.png" style="border-radius: 50%;"/>-->



                    北京</a>



            </div>



            <div class="header_head_p_cs">



                <a href="/static/search/#" style="background: #C81623;color: #fff;">北京</a>



                <a href="/static/search/#">上海</a>



                <a href="/static/search/#">天津</a>



                <a href="/static/search/#">重庆</a>



                <a href="/static/search/#">河北</a>



                <a href="/static/search/#">山西</a>



                <a href="/static/search/#">河南</a>



                <a href="/static/search/#">辽宁</a>



                <a href="/static/search/#">吉林</a>



                <a href="/static/search/#">黑龙江</a>



                <a href="/static/search/#">内蒙古</a>



                <a href="/static/search/#">江苏</a>



                <a href="/static/search/#">山东</a>



                <a href="/static/search/#">安徽</a>



                <a href="/static/search/#">浙江</a>



                <a href="/static/search/#">福建</a>



                <a href="/static/search/#">湖北</a>



                <a href="/static/search/#">湖南</a>



                <a href="/static/search/#">广东</a>



                <a href="/static/search/#">广西</a>



                <a href="/static/search/#">江西</a>



                <a href="/static/search/#">四川</a>



                <a href="/static/search/#">海南</a>



                <a href="/static/search/#">贵州</a>



                <a href="/static/search/#">云南</a>



                <a href="/static/search/#">西藏</a>



                <a href="/static/search/#">陕西</a>



                <a href="/static/search/#">甘肃</a>



                <a href="/static/search/#">青海</a>



                <a href="/static/search/#">宁夏</a>



                <a href="/static/search/#">新疆</a>



                <a href="/static/search/#">港澳</a>



                <a href="/static/search/#">台湾</a>



                <a href="/static/search/#">钓鱼岛</a>



                <a href="/static/search/#">海外</a>



            </div>



        </b>



        <ul>



            <li>



                <a href="/static/search/#" class="li_2">你好，请登录</a>



            </li>



            <li>



                <a href="/static/search/#">免费注册</a>



            </li>



            <span>|</span>



            <li>



                <a href="/static/search/#">我的订单</a>



            </li>



            <span>|</span>



            <li class="header_wdjd" style="width:80px;">



                <a href="/static/search/#">我的谷粒商城</a>



                <img src="/static/search/image/down-@1x.png" />



                <!--<b class="glyphicon glyphicon-menu-down"></b>-->



                <div class="header_wdjd_txt">



                    <ul>



                        <li>



                            <a href="/static/search/#">待处理订单</a>



                        </li>



                        <li>



                            <a href="/static/search/#">消息</a>



                        </li>



                        <li>



                            <a href="/static/search/#">返修退换货</a>



                        </li>



                        <li>



                            <a href="/static/search/#">我的回答</a>



                        </li>



                        <li>



                            <a href="/static/search/#">降价商品</a>



                        </li>



                        <li>



                            <a href="/static/search/#">我的关注</a>



                        </li>



                    </ul>



                    <ul>



                        <li>



                            <a href="/static/search/#">我的京豆</a>



                        </li>



                        <li>



                            <a href="/static/search/#">我的优惠券</a>



                        </li>



                        <li>



                            <a href="/static/search/#">我的白条</a>



                        </li>



                        <li>



                            <a href="/static/search/#">我的理财</a>



                        </li>



                    </ul>



                </div>



            </li>



            <span>|</span>



            <li>



                <a href="/static/search/#">谷粒商城会员</a>



            </li>



            <span>|</span>



            <li>



                <a href="/static/search/#">企业采购</a>



            </li>



            <span>|</span>



            <li class="header_wdjd1">



                <a href="/static/search/#">客户服务</a>



                <img src="/static/search/image/down-@1x.png" />



                <!--<b class="glyphicon glyphicon-menu-down"></b>-->



                <div class="header_wdjd_txt">



                    <ul>



                        <p style="width:100%;">客户</p>



                        <li>



                            <a href="/static/search/#">帮助中心</a>



                        </li>



                        <li>



                            <a href="/static/search/#">售后服务</a>



                        </li>



                        <li>



                            <a href="/static/search/#">在线客服</a>



                        </li>



                        <li>



                            <a href="/static/search/#">意见建议</a>



                        </li>



                        <li>



                            <a href="/static/search/#">电话客服</a>



                        </li>



                        <li>



                            <a href="/static/search/#">客服邮箱</a>



                        </li>



                        <li>



                            <a href="/static/search/#">金融资讯</a>



                        </li>



                        <li>



                            <a href="/static/search/#">售全球客服</a>



                        </li>



                    </ul>



                    <ul>



                        <p style="width:100%;">商户</p>



                        <li>



                            <a href="/static/search/#">合作招商</a>



                        </li>



                        <li>



                            <a href="/static/search/#">学习中心</a>



                        </li>



                        <li>



                            <a href="/static/search/#">商家后台</a>



                        </li>



                        <li>



                            <a href="/static/search/#">京麦工作台</a>



                        </li>



                        <li>



                            <a href="/static/search/#">商家帮助</a>



                        </li>



                        <li>



                            <a href="/static/search/#">规则平台</a>



                        </li>



                    </ul>



                </div>



            </li>



            <span>|</span>



            <li class="header_wzdh">



                <a href="/static/search/#">网站导航</a>



                <img src="/static/search/image/down-@1x.png" />



                <!--<b class="glyphicon glyphicon-menu-down"></b>-->



                <div class="header_wzdh_txt">



                    <ul style="width: 25%;">



                        <p style="width:100%;">特色主题</p>



                        <li>



                            <a href="/static/search/#">谷粒商城试用</a>



                        </li>



                        <li>



                            <a href="/static/search/#">谷粒商城金融</a>



                        </li>



                        <li>



                            <a href="/static/search/#">全球售</a>



                        </li>



                        <li>



                            <a href="/static/search/#">国际站</a>



                        </li>



                        <li>



                            <a href="/static/search/#">谷粒商城会员</a>



                        </li>



                        <li>



                            <a href="/static/search/#">谷粒商城预售</a>



                        </li>



                        <li>



                            <a href="/static/search/#">买什么</a>



                        </li>



                        <li>



                            <a href="/static/search/#">俄语站</a>



                        </li>



                        <li>



                            <a href="/static/search/#">装机大师</a>



                        </li>



                        <li>



                            <a href="/static/search/#">0元评测</a>



                        </li>



                        <li>



                            <a href="/static/search/#">定期送</a>



                        </li>



                        <li>



                            <a href="/static/search/#">港澳售</a>



                        </li>



                        <li>



                            <a href="/static/search/#">优惠券</a>



                        </li>



                        <li>



                            <a href="/static/search/#">秒杀</a>



                        </li>



                        <li>



                            <a href="/static/search/#">闪购</a>



                        </li>



                        <li>



                            <a href="/static/search/#">印尼站</a>



                        </li>



                        <li>



                            <a href="/static/search/#">谷粒商城金融科技</a>



                        </li>



                        <li>



                            <a href="/static/search/#">In货推荐</a>



                        </li>



                        <li>



                            <a href="/static/search/#">陪伴计划</a>



                        </li>



                        <li>



                            <a href="/static/search/#">出海招商</a>



                        </li>



                    </ul>



                    <ul style="width: 20%;">



                        <p style="width:100%;">行业频道</p>



                        <li>



                            <a href="/static/search/#">手机</a>



                        </li>



                        <li>



                            <a href="/static/search/#">智能数码</a>



                        </li>



                        <li>



                            <a href="/static/search/#">玩3c</a>



                        </li>



                        <li>



                            <a href="/static/search/#">电脑办公</a>



                        </li>



                        <li>



                            <a href="/static/search/#">家用电器</a>



                        </li>



                        <li>



                            <a href="/static/search/#">谷粒商城智能</a>



                        </li>



                        <li>



                            <a href="/static/search/#">服装城</a>



                        </li>



                        <li>



                            <a href="/static/search/#">美妆馆</a>



                        </li>



                        <li>



                            <a href="/static/search/#">家装城</a>



                        </li>



                        <li>



                            <a href="/static/search/#">母婴</a>



                        </li>



                        <li>



                            <a href="/static/search/#">食品</a>



                        </li>



                        <li>



                            <a href="/static/search/#">运动户外</a>



                        </li>



                        <li>



                            <a href="/static/search/#">农资频道</a>



                        </li>



                        <li>



                            <a href="/static/search/#">整车</a>



                        </li>



                        <li>



                            <a href="/static/search/#">图书</a>



                        </li>



                    </ul>



                    <ul style="width: 21%;">



                        <p style="width:100%;">生活服务</p>



                        <li>



                            <a href="/static/search/#">白条</a>



                        </li>



                        <li>



                            <a href="/static/search/#">谷粒商城金融App</a>



                        </li>



                        <li>



                            <a href="/static/search/#">谷粒商城小金库</a>



                        </li>



                        <li>



                            <a href="/static/search/#">理财</a>



                        </li>



                        <li>



                            <a href="/static/search/#">智能家电</a>



                        </li>



                        <li>



                            <a href="/static/search/#">话费</a>



                        </li>



                        <li>



                            <a href="/static/search/#">水电煤</a>



                        </li>



                        <li>



                            <a href="/static/search/#">彩票</a>



                        </li>



                        <li>



                            <a href="/static/search/#">旅行</a>



                        </li>



                        <li>



                            <a href="/static/search/#">机票酒店</a>



                        </li>



                        <li>



                            <a href="/static/search/#">电影票</a>



                        </li>



                        <li>



                            <a href="/static/search/#">谷粒商城到家</a>



                        </li>



                        <li>



                            <a href="/static/search/#">谷粒商城众测</a>



                        </li>



                        <li>



                            <a href="/static/search/#">游戏</a>



                        </li>



                    </ul>



                    <ul style="width: 23%; border-right: 0;">



                        <p style="width:100%;">更多精选</p>



                        <li>



                            <a href="/static/search/#">合作招商</a>



                        </li>



                        <li>



                            <a href="/static/search/#">谷粒商城通信</a>



                        </li>



                        <li>



                            <a href="/static/search/#">谷粒商城E卡</a>



                        </li>



                        <li>



                            <a href="/static/search/#">企业采购</a>



                        </li>



                        <li>



                            <a href="/static/search/#">服务市场</a>



                        </li>



                        <li>



                            <a href="/static/search/#">办公生活馆</a>



                        </li>



                        <li>



                            <a href="/static/search/#">乡村招募</a>



                        </li>



                        <li>



                            <a href="/static/search/#">校园加盟</a>



                        </li>



                        <li>



                            <a href="/static/search/#">京友帮</a>



                        </li>



                        <li>



                            <a href="/static/search/#">谷粒商城社区</a>



                        </li>



                        <li>



                            <a href="/static/search/#">智能社区</a>



                        </li>



                        <li>



                            <a href="/static/search/#">游戏社区</a>



                        </li>



                        <li>



                            <a href="/static/search/#">知识产权维权</a>



                        </li>



                    </ul>



                </div>



            </li>



            <span>|</span>



            <li class="header_sjjd">



                <a href="/static/search/#">手机谷粒商城</a>



                <div class="header_sjjd_div">



                    <img src="/static/search/img/01.png" />



                </div>



            </li>



        </ul>



    </div>



</div>



 



<!--搜索导航-->



<div class="header_sous">



    <div class="logo">



        <a href="http://gulimall.com"><img src="/static/search/./image/logo1.jpg" alt=""></a>



    </div>



    <div class="header_form">



        <input id="keyword_input"  type="text" placeholder="手机" th:value="${param.keyword}"/>



        <a href="javascript:searchByKeyword();">搜索</a>



    </div>



    <div class="header_ico">



        <div class="header_gw">



            <span><a href="/static/search/#">我的购物车</a></span>



            <img src="/static/search/image/settleup-@1x.png" />



            <span>0</span>



        </div>



        <div class="header_ko">



            <p>购物车中还没有商品，赶紧选购吧！</p>



        </div>



    </div>



    <div class="header_form_nav">



        <ul>



            <li>



                <a href="/static/search/#">谷粒商城之家</a>



            </li>



            <li>



                <a href="/static/search/#">谷粒商城专卖店</a>



            </li>



            <li>



                <a href="/static/search/#">平板</a>



            </li>



            <li>



                <a href="/static/search/#">电脑</a>



            </li>



            <li>



                <a href="/static/search/#">ipad</a>



            </li>



        </ul>



    </div>



    <nav>



        <ul>



            <li class="nav_li1">



                <a href="/static/search/#">全部商品分类</a>



            </li>



            <li class="nav_li">



                <a href="/static/search/#">服装城</a>



            </li>



            <li class="nav_li">



                <a href="/static/search/#">没装馆</a>



            </li>



            <li class="nav_li">



                <a href="/static/search/#">超市</a>



            </li>



            <li class="nav_li">



                <a href="/static/search/#">生鲜</a>



            </li>



        </ul>



        <div class="spacer">|</div>



        <ul>



            <li class="nav_li">



                <a href="/static/search/#">全球购</a>



            </li>



            <li class="nav_li">



                <a href="/static/search/#">闪购</a>



            </li>



            <li class="nav_li">



                <a href="/static/search/#">拍卖</a>



            </li>



        </ul>



        <div class="spacer">|</div>



        <ul>



            <li class="nav_li">



                <a href="/static/search/#">金融</a>



            </li>



        </ul>



 



    </nav>



    <div class="header_main_left">



        <ul>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>家用电器</b></a>



            </li>



            <li class="header_li2">



                <a href="/static/search/#" class="header_main_left_a"><b>手机</b> / <b>运营商</b> / <b>数码</b></a>



                <div class="header_main_left_main">



                    <div class="header_sj">



                        <a href="/static/search/#" class="header_sj_a">玩3c</a>



                        <a href="/static/search/#" class="header_sj_a">手机频道</a>



                        <a href="/static/search/#" class="header_sj_a">网上营业厅</a>



                        <a href="/static/search/#" class="header_sj_a">配件选购中心</a>



                        <a href="/static/search/#" class="header_sj_a">企业购</a>



                        <a href="/static/search/#" class="header_sj_a">以旧换新</a>



                    </div>



                    <ol class="header_ol">



                        <a href="/static/search/#" style="color: #111;" class="aaa">手机通讯 ></a>



                        <li>



                            <a href="/static/search/#" style="color: #999;">手机</a>



                            <a href="/static/search/#" style="color: #999;">对讲机</a>



                            <a href="/static/search/#" style="color: #999;">手机维修</a>



                            <a href="/static/search/#" style="color: #999;">以旧换新</a>



                        </li>



                        <a href="/static/search/#" style="color: #111;" class="aaa">运营商 ></a>



                        <li>



                            <a href="/static/search/#" style="color: #999;">合约机</a>



                            <a href="/static/search/#" style="color: #999;">固话宽带</a>



                            <a href="/static/search/#" style="color: #999;">办套餐</a>



                            <a href="/static/search/#" style="color: #999;">从话费/流量</a>



                            <a href="/static/search/#" style="color: #999;">中国电信</a>



                            <a href="/static/search/#" style="color: #999;">中国移动</a>



                            <a href="/static/search/#" style="color: #999;">中国联通</a>



                            <a href="/static/search/#" style="color: #999;">谷粒商城通信</a>



                            <a href="/static/search/#" style="color: #999;">170选号</a>



                        </li>



                        <a href="/static/search/#" style="color: #111;" class="aaa">手机配件 ></a>



                        <li style="height: 60px;">



 



                            <a href="/static/search/#" style="color: #999;">手机壳</a>



                            <a href="/static/search/#" style="color: #999;">贴膜</a>



                            <a href="/static/search/#" style="color: #999;">手机储存卡</a>



                            <a href="/static/search/#" style="color: #999;">数据线</a>



                            <a href="/static/search/#" style="color: #999;">存电器</a>



                            <a href="/static/search/#" style="color: #999;">手机耳机</a>



                            <a href="/static/search/#" style="color: #999;">创业配件</a>



                            <a href="/static/search/#" style="color: #999;">手机饰品</a>



                            <a href="/static/search/#" style="color: #999;">手机电池</a>



                            <a href="/static/search/#" style="color: #999;">苹果周边</a>



                            <a href="/static/search/#" style="color: #999;">移动电源</a>



                            <a href="/static/search/#" style="color: #999;">蓝牙耳机</a>



                            <a href="/static/search/#" style="color: #999;">手机支架</a>



                            <a href="/static/search/#" style="color: #999;">车载配件</a>



                            <a href="/static/search/#" style="color: #999;">拍照配件</a>



 



                        </li>



                        <a href="/static/search/#" style="color: #111;" class="aaa">摄影摄像 ></a>



                        <li style="height: 60px;">



 



                            <a href="/static/search/#" style="color: #999;">数码相机</a>



                            <a href="/static/search/#" style="color: #999;">单电/微单相机</a>



                            <a href="/static/search/#" style="color: #999;">单反相机</a>



                            <a href="/static/search/#" style="color: #999;">拍立得</a>



                            <a href="/static/search/#" style="color: #999;">运动相机</a>



                            <a href="/static/search/#" style="color: #999;">摄像机</a>



                            <a href="/static/search/#" style="color: #999;">镜头</a>



                            <a href="/static/search/#" style="color: #999;">户外器材</a>



                            <a href="/static/search/#" style="color: #999;">影棚器材</a>



                            <a href="/static/search/#" style="color: #999;">冲印服务</a>



                            <a href="/static/search/#" style="color: #999;">数码相框</a>



                        </li>



                        <a href="/static/search/#" style="color: #111;" class="aaa">数码配件 ></a>



                        <li style="height: 60px;">



 



                            <a href="/static/search/#" style="color: #999;">三脚架/云台</a>



                            <a href="/static/search/#" style="color: #999;">相机包</a>



                            <a href="/static/search/#" style="color: #999;">滤镜</a>



                            <a href="/static/search/#" style="color: #999;">散光灯/手柄</a>



                            <a href="/static/search/#" style="color: #999;">相机清洁</a>



                            <a href="/static/search/#" style="color: #999;">机身附件</a>



                            <a href="/static/search/#" style="color: #999;">镜头附件</a>



                            <a href="/static/search/#" style="color: #999;">读卡器</a>



                            <a href="/static/search/#" style="color: #999;">支架</a>



                            <a href="/static/search/#" style="color: #999;">电池/存电器</a>



 



                        </li>



                        <a href="/static/search/#" style="color: #111;" class="aaa">影音娱乐 ></a>



                        <li>



 



                            <a href="/static/search/#" style="color: #999;">耳机/耳麦</a>



                            <a href="/static/search/#" style="color: #999;">音箱/音响</a>



                            <a href="/static/search/#" style="color: #999;">智能音箱</a>



                            <a href="/static/search/#" style="color: #999;">便携/无线音箱</a>



                            <a href="/static/search/#" style="color: #999;">收音机</a>



                            <a href="/static/search/#" style="color: #999;">麦克风</a>



                            <a href="/static/search/#" style="color: #999;">MP3/MP4</a>



                            <a href="/static/search/#" style="color: #999;">专业音频</a>



                        </li>



                        <a href="/static/search/#" style="color: #111;" class="aaa">智能设备 ></a>



                        <li style="height: 60px;">



 



                            <a href="/static/search/#" style="color: #999;">智能手环</a>



                            <a href="/static/search/#" style="color: #999;">智能手表</a>



                            <a href="/static/search/#" style="color: #999;">智能眼镜</a>



                            <a href="/static/search/#" style="color: #999;">智能机器人</a>



                            <a href="/static/search/#" style="color: #999;">运动跟踪器</a>



                            <a href="/static/search/#" style="color: #999;">健康监测</a>



                            <a href="/static/search/#" style="color: #999;">智能配饰</a>



                            <a href="/static/search/#" style="color: #999;">智能家居</a>



                            <a href="/static/search/#" style="color: #999;">体感车</a>



                            <a href="/static/search/#" style="color: #999;">无人机</a>



                            <a href="/static/search/#" style="color: #999;">其他配件</a>



                        </li>



                        <a href="/static/search/#" style="color: #111;" class="aaa">电子教育 ></a>



                        <li>



                            <a href="/static/search/#" style="color: #999;">学生平板</a>



                            <a href="/static/search/#" style="color: #999;">点读机</a>



                            <a href="/static/search/#" style="color: #999;">早教益智</a>



                            <a href="/static/search/#" style="color: #999;">录音笔</a>



                            <a href="/static/search/#" style="color: #999;">电纸书</a>



                            <a href="/static/search/#" style="color: #999;">电子词典</a>



                            <a href="/static/search/#" style="color: #999;">复读机</a>



                        </li>



                    </ol>



                    <div class="header_r">



                        <div class="header_r_tu">



                            <a href="/static/search/#"><img src="/static/search/img/56b2f385n8e4eb051.jpg" /></a>



                            <a href="/static/search/#"><img src="/static/search/img/56b2f385n8e4eb051.jpg" /></a>



                            <a href="/static/search/#"><img src="/static/search/img/56b2f385n8e4eb051.jpg" /></a>



                            <a href="/static/search/#"><img src="/static/search/img/56b2f385n8e4eb051.jpg" /></a>



                            <a href="/static/search/#"><img src="/static/search/img/56b2f385n8e4eb051.jpg" /></a>



                            <a href="/static/search/#"><img src="/static/search/img/56b2f385n8e4eb051.jpg" /></a>



                            <a href="/static/search/#"><img src="/static/search/img/56b2f385n8e4eb051.jpg" /></a>



                            <a href="/static/search/#"><img src="/static/search/img/56b2f385n8e4eb051.jpg" /></a>



                        </div>



                        <div class="header_r_tu1">



                            <a href="/static/search/#"><img src="/static/search/img/JD_ash7 - 副本.png" /></a>



                            <a href="/static/search/#"><img src="/static/search/img/JD_ash6.png" /></a>



                        </div>



                    </div>



                </div>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>电脑</b> / <b>办公</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>家居</b> / <b>家具</b> / <b>家装</b> / <b>厨具</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>男装</b> / <b>女装</b> / <b>童装</b> / <b>内衣</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>美妆个护 </b>/ <b>宠物</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>女鞋</b> / <b>箱包</b> / <b>钟表</b> / <b>珠宝</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>男鞋</b> / <b>运动</b> / <b>户外</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>汽车</b> / <b>汽车用品</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>母婴</b> / <b>玩具乐器</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>食品</b> / <b>酒类</b> / <b>生鲜</b> / <b>特产</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>礼品鲜花</b> / <b>农资绿植</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>医药保健</b> / <b>计生情趣</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>图书</b> / <b>音箱</b>/ <b>电子书</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>机票</b> / <b>酒店</b> / <b>旅游</b> / <b>生活</b></a>



            </li>



            <li>



                <a href="/static/search/#" class="header_main_left_a"><b>理财</b> / <b>众筹</b> / <b>白条</b> / <b>保险</b></a>



            </li>



        </ul>



 



    </div>



</div>



 



<hr style="border: 1px solid red;margin-top: -7px;">



 



<!--热卖促销-->



<div class="JD_temai">



    <div class="JD_main">



        <div class="JD_left">



            <div class="hd">



                热卖推荐



            </div>



            <div class="bd mc">



                <ul class="mc">



                    <li>



                        <a href="/static/search/#" class="mc_a"><img src="/static/search/./img/5a28b5a1n8a5c095f.jpg" alt=""></a>



                        <div class="mc_div">



                            <a href="/static/search/#" class="mc_div_a1">



                                <em>华为 HUAWEI nova 2S 全面屏四摄 6GB +64GB 曜石黑 移动联通电信4G手机 双卡双待</em>



                            </a>



                            <p>



                                <strong>



                                    <em class="number J-p-5963064">￥2999.00</em>



                                </strong>



                            </p>



                            <a href="/static/search/#" class="mc_div_a2">立即抢购</a>



                        </div>



                    </li>



                    <li>



                        <a href="/static/search/#" class="mc_a"><img src="/static/search/./img/59f5eef1n99542494.jpg" alt=""></a>



                        <div class="mc_div">



                            <a href="/static/search/#" class="mc_div_a1">



                                <em>【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待</em>



                            </a>



                            <p>



                                <strong>



                                    <em class="number J-p-5963064">￥1699.00</em>



                                </strong>



                            </p>



                            <a href="/static/search/#" class="mc_div_a2">立即抢购</a>



                        </div>



                    </li>



                    <li style="margin-right: 0">



                        <a href="/static/search/#" class="mc_a"><img src="/static/search/./img/59f5eef1n99542494.jpg" alt=""></a>



                        <div class="mc_div">



                            <a href="/static/search/#" class="mc_div_a1">



                                <em>华为 HUAWEI nova 2S 全面屏四摄 6GB +64GB 曜石黑 移动联通电信4G手机 双卡双待</em>



                            </a>



                            <p>



                                <strong>



                                    <em class="number J-p-5963064">￥2999.00</em>



                                </strong>



                            </p>



                            <a href="/static/search/#" class="mc_div_a2">立即抢购</a>



                        </div>



                    </li>



                </ul>



            </div>



        </div>



        <div class="JD_right">



            <div class="hd"> 促销活动</div>



            <div class="bd">



                <ul>



                    <li> . <a href="/static/search/#">红米千元全面屏手机上市</a></li>



                    <li> . <a href="/static/search/#">锤子坚果Pro2火爆预约中</a></li>



                    <li> . <a href="/static/search/#">大牌新品 疯狂抢购</a></li>



                    <li> . <a href="/static/search/#">X20 vivo蓝新色上市</a></li>



                    <li> . <a href="/static/search/#">荣耀畅玩7X新品上市</a></li>



                </ul>



            </div>



        </div>



    </div>



</div>



 



<!--手机-->



<div class="JD_ipone">



    <div class="JD_ipone_bar">



        <div class="JD_ipone_one a">



            <a href="/static/search/#">手机</a>



        </div>



        <i><img src="/static/search/image/right-@1x.png" alt=""></i>



        <div class="JD_ipone_one b">



            <a href="/static/search/#" class="qqq">手机通讯录 <img src="/static/search/image/down-@1x.png" alt=""></a>



            <div>



                <a href="/static/search/#">手机通讯</a>



                <a href="/static/search/#">运营商</a>



                <a href="/static/search/#">手机配件</a>



                <a href="/static/search/#">手机服务</a>



            </div>



        </div>



        <i><img src="/static/search/image/right-@1x.png" alt=""></i>



        <div class="JD_ipone_one c">



            <a href="/static/search/#" class="qqq">手机 <img src="/static/search/image/down-@1x.png" alt=""></a>



            <div>



                <a href="/static/search/#">手机</a>



                <a href="/static/search/#">老人机</a>



                <a href="/static/search/#">对讲机</a>



                <a href="/static/search/#">女性手机</a>



                <a href="/static/search/#">超续航手机</a>



                <a href="/static/search/#">全面屏手机</a>



                <a href="/static/search/#">拍照手机</a>



                <a href="/static/search/#">游戏手机</a>



            </div>



        </div>



        <div class="JD_ipone_one c">



            <a th:href="${nav.link}" th:each="nav:${result.navs}"><span th:text="${nav.navName}"></span>: <span th:text="${nav.navValue}"></span>×</a>



        </div>



        <i><img src="/static/search/image/right-@1x.png" alt=""></i>



<!--        </div>-->



    </div>



</div>



 



<!--商品筛选和排序-->



<div class="JD_banner w">



    <div class="JD_nav">



        <div class="JD_selector">



            <!--手机商品筛选-->



            <div class="title">



                <h3><b>手机</b><em>商品筛选</em></h3>



                <div class="st-ext">共&nbsp;<span>10135</span>个商品 </div>



            </div>



            <div class="JD_nav_logo" th:with="brandid= ${param.brandId}">



                <!--品牌-->



                <div  th:if="${#strings.isEmpty(brandid)}" class="JD_nav_wrap">



                    <div class="sl_key">



                        <span><b>品牌：</b></span>



                    </div>



                    <div class="sl_value">



                        <div class="sl_value_logo">



                            <ul>



                                <li th:each="brand:${result.brands}">



                                    <a href="/static/search/#" th:href="${'javascript:searchProducts(&quot;brandId&quot;,'+brand.brandId+')'}">



                                        <img th:src="${brand.brandImg}" alt="">



                                        <div th:text="${brand.brandName}">



                                            华为(HUAWEI)



                                        </div>



                                    </a>



                                </li>



                            </ul>



                        </div>



                    </div>



                    <div class="sl_ext">



                        <a href="/static/search/#">



                            更多



                            <i style='background: url("image/search.ele.png")no-repeat 3px 7px'></i>



                            <b style='background: url("image/search.ele.png")no-repeat 3px -44px'></b>



                        </a>



                        <a href="/static/search/#">



                            多选



                            <i>+</i>



                            <span>+</span>



                        </a>



                    </div>



                </div>



                <!--分类-->



                <div class="JD_pre">



                    <div class="sl_key">



                        <span><b>分类：</b></span>



                    </div>



                    <div class="sl_value">



                      <!--      <ul>



                                <li th:each="catalog:${result.catalogs}">



                                    <a href="/static/search/#" th:text="${catalog.catalogName}">



                                    </a>



                                </li>



                            </ul> -->



                            <ul>



                                <li th:each="catalog:${result.catalogs}"><a href="/static/search/#"



                                                          th:href="${'javascript:searchProducts(&quot;catalog3Id&quot;,'+catalog.catalogId+')'}"



                                                          th:text="${catalog.catalogName}" >5.56英寸及以上</a></li>



                            </ul>



                    </div>



                    <div class="sl_ext">



                        <a href="/static/search/#">



                            更多



                            <i style='background: url("image/search.ele.png")no-repeat 3px 7px'></i>



                            <b style='background: url("image/search.ele.png")no-repeat 3px -44px'></b>



                        </a>



                        <a href="/static/search/#">



                            多选



                            <i>+</i>



                            <span>+</span>



                        </a>



                    </div>



                </div>



                <!--其他属性-->



                <div class="JD_pre" th:each="attr:${result.attrs}" th:if="${!#lists.contains(result.attrIds,attr.attrId)}">



                    <div class="sl_key">



                        <span th:text="${attr.attrName}">屏幕尺寸：</span>



                    </div>



                    <div class="sl_value">



                        <ul>



                            <li th:each="val:${attr.attrValue}"><a href="/static/search/#"



                                     th:href="${'javascript:searchProducts(&quot;attrs&quot;,&quot;'+attr.attrId+'_'+val+'&quot;)'}"



                                     th:text="${val}" >5.56英寸及以上</a></li>



                        </ul>



                    </div>



                </div>



            </div>



            <div class="JD_show">



                <a href="/static/search/#">



                    <span>



                        更多选项（ CPU核数、网络、机身颜色 等）



                    </span>



                </a>



            </div>



        </div>



        <!--排序-->



        <div class="JD_banner_main">



            <!--商品精选-->



            <div class="JD_con_left">



                <div class="JD_con_left_bar">



                    <div class="JD_con_one">



                        <div class="mt">



                            <h3>商品精选</h3>



                            <span>广告</span>



                        </div>



                        <div class="mc">



                            <ul>



                                <li>



                                    <a href="/static/search/#" title="vivo X9s 全网通 4GB+64GB 磨砂黑 移动联通电信4G手机 双卡双待"><img src="/static/search/img/59bf3c47n91d65c73.jpg" alt=""></a>



                                    <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                                        <em>华为 HUAWEI nova 2S 全面屏四摄 6GB +64GB 曜石黑 移动联通电信4G手机 双卡双待</em>



                                    </a>



                                    <div class="mc_price">



                                        <strong class="price">



                                            <span class="J-p-5963064">￥2999.00</span>



                                        </strong>



                                        <span class="mc-ico" title="购买本商品送赠品">



                                            <i class="goods-icons">赠品</i>



                                        </span>



                                    </div>



                                    <div class="mc_rev">



                                        已有



                                        <a href="/static/search/#" class="number">12466</a>



                                        人评价



                                    </div>



                                </li>



                                <li>



                                    <a href="/static/search/#" title="vivo X9s 全网通 4GB+64GB 磨砂黑 移动联通电信4G手机 双卡双待"><img src="/static/search/img/59bf3c47n91d65c73.jpg" alt=""></a>



                                    <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                                        <em>华为 HUAWEI nova 2S 全面屏四摄 6GB +64GB 曜石黑 移动联通电信4G手机 双卡双待</em>



                                    </a>



                                    <div class="mc_price">



                                        <strong class="price">



                                            <span class="J-p-5963064">￥2999.00</span>



                                        </strong>



                                        <span class="mc-ico" title="购买本商品送赠品">



                                            <i class="goods-icons">赠品</i>



                                        </span>



                                    </div>



                                    <div class="mc_rev">



                                        已有



                                        <a href="/static/search/#" class="number">12466</a>



                                        人评价



                                    </div>



                                </li>



                                <li>



                                    <a href="/static/search/#" title="vivo X9s 全网通 4GB+64GB 磨砂黑 移动联通电信4G手机 双卡双待"><img src="/static/search/img/593ba628n8794c6a6.jpg" alt=""></a>



                                    <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                                        <em>诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机</em>



                                    </a>



                                    <div class="mc_price">



                                        <strong class="price">



                                            <span class="J-p-5963064">￥1799.00</span>



                                        </strong>



                                        <span class="mc-ico" title="购买本商品送赠品">



                                            <i class="goods-icons">赠品</i>



                                        </span>



                                    </div>



                                    <div class="mc_rev">



                                        已有



                                        <a href="/static/search/#" class="number">15600</a>



                                        人评价



                                    </div>



                                </li>



                                <li>



                                    <a href="/static/search/#" title="vivo X9s 全网通 4GB+64GB 磨砂黑 移动联通电信4G手机 双卡双待"><img src="/static/search/img/5919637an271a1301.jpg" alt=""></a>



                                    <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                                        <em>vivo Xplay6 全网通 6GB+64GB 磨砂黑 移动联通电信4G手机 双卡双待</em>



                                    </a>



                                    <div class="mc_price">



                                        <strong class="price">



                                            <span class="J-p-5963064">￥3498.00</span>



                                        </strong>



                                        <span class="mc-ico" title="购买本商品送赠品">



                                            <i class="goods-icons">赠品</i>



                                        </span>



                                    </div>



                                    <div class="mc_rev">



                                        已有



                                        <a href="/static/search/#" class="number">5369</a>



                                        人评价



                                    </div>



                                </li>



                            </ul>



                        </div>



                    </div>



                    <div class="JD_con_one">



                        <div class="mt">



                            <h3>达人选购</h3>



                        </div>



                        <div class="mc">



                            <ul>



                                <li>



                                    <a href="/static/search/#" title="vivo X9s 全网通 4GB+64GB 磨砂黑 移动联通电信4G手机 双卡双待"><img src="/static/search/img/59bf3c47n91d65c73.jpg" alt=""></a>



                                    <a href="/static/search/#">



                                        <em>华为 HUAWEI nova 2S 全面屏四摄 6GB +64GB 曜石黑 移动联通电信4G手机 双卡双待</em>



                                    </a>



                                    <div class="mc_price">



                                        <strong class="price">



                                            <span class="J-p-5963064">￥2999.00</span>



                                        </strong>



                                    </div>



                                </li>



                                <li>



                                    <a href="/static/search/#" title="vivo X9s 全网通 4GB+64GB 磨砂黑 移动联通电信4G手机 双卡双待"><img src="/static/search/img/59bf3c47n91d65c73.jpg" alt=""></a>



                                    <a href="/static/search/#">



                                        <em>华为 HUAWEI nova 2S 全面屏四摄 6GB +64GB 曜石黑 移动联通电信4G手机 双卡双待</em>



                                    </a>



                                    <div class="mc_price">



                                        <strong class="price">



                                            <span class="J-p-5963064">￥2999.00</span>



                                        </strong>



                                    </div>



                                </li>



                                <li>



                                    <a href="/static/search/#" title="vivo X9s 全网通 4GB+64GB 磨砂黑 移动联通电信4G手机 双卡双待"><img src="/static/search/img/593ba628n8794c6a6.jpg" alt=""></a>



                                    <a href="/static/search/#">



                                        <em>诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机</em>



                                    </a>



                                    <div class="mc_price">



                                        <strong class="price">



                                            <span class="J-p-5963064">￥1799.00</span>



                                        </strong>



                                    </div>



                                </li>



                                <li>



                                    <a href="/static/search/#" title="vivo X9s 全网通 4GB+64GB 磨砂黑 移动联通电信4G手机 双卡双待"><img src="/static/search/img/5919637an271a1301.jpg" alt=""></a>



                                    <a href="/static/search/#">



                                        <em>vivo Xplay6 全网通 6GB+64GB 磨砂黑 移动联通电信4G手机 双卡双待</em>



                                    </a>



                                    <div class="mc_price">



                                        <strong class="price">



                                            <span class="J-p-5963064">￥3498.00</span>



                                        </strong>



                                    </div>



                                </li>



                            </ul>



                        </div>



                    </div>



                    <div class="JD_con_one" style="border:none;">



                        <div class="mt">



                            <h3>商品精选</h3>



                            <span>广告</span>



                        </div>



                        <div class="mc">



                            <ul>



                                <li>



                                    <a href="/static/search/#"><img src="/static/search/img/599a806bn9d829c1c.jpg" alt=""></a>



                                </li>



                                <li>



                                    <a href="/static/search/#"><img src="/static/search/img/593e4de0n5ff878a4.jpg" alt=""></a>



                                </li>



                            </ul>



                        </div>



                    </div>



                </div>



            </div>



            <!--综合排序-->



            <div class="JD_con_right">



                <div class="filter">



                    <!--综合排序-->



                    <div class="filter_top">



                        <div class="filter_top_left" th:with="p = ${param.sort},priceRange= ${param.skuPrice}">



                            <a   th:class="${(!#strings.isEmpty(p) && #strings.startsWith(p,'hotScore') && #strings.endsWith(p,'desc'))?'sort_a desc':'sort_a '}"



                               th:attr="style=${(#strings.isEmpty(p) || #strings.startsWith(p ,'hotScore'))?'color: #FFF;border-color:#e4393c;background: #e4393c':'color: #333;border-color:#CCC;background: #FFF'}"



                               sort="hotScore" href="/static/search/#">综合排序  [[${ (!#strings.isEmpty(p) && #strings.startsWith(p,'hotScore') && #strings.endsWith(p,'desc'))?'↓':'↑'}]]</a>



                            <a  th:class="${(!#strings.isEmpty(p) && #strings.startsWith(p,'saleCount') && #strings.endsWith(p,'desc'))?'sort_a desc':'sort_a '}"



                               th:attr="style=${(!#strings.isEmpty(p) && #strings.startsWith(p,'saleCount'))?'color: #FFF;border-color:#e4393c;background: #e4393c':'color: #333;border-color:#CCC;background: #FFF'}"



                               sort="saleCount" href="/static/search/#">销量 [[${ (!#strings.isEmpty(p) && #strings.startsWith(p,'saleCount') && #strings.endsWith(p,'desc'))?'↓':'↑'}]]</a>



                            <a  th:class="${(!#strings.isEmpty(p) && #strings.startsWith(p,'skuPrice') && #strings.endsWith(p,'desc'))?'sort_a desc':'sort_a '}"



                               th:attr="style=${(!#strings.isEmpty(p) && #strings.startsWith(p ,'skuPrice'))?'color: #FFF;border-color:#e4393c;background: #e4393c':'color: #333;border-color:#CCC;background: #FFF'}"



                               sort="skuPrice" href="/static/search/#">价格 [[${ (!#strings.isEmpty(p) && #strings.startsWith(p,'skuPrice') && #strings.endsWith(p,'desc'))?'↓':'↑'}]]</a>



                            <a href="/static/search/#">评论分</a>



                            <a  href="/static/search/#">上架时间</a>



                            <input id="skuPriceFrom" type="number" style="width: 100px;margin-left: 30px;" th:value="${#strings.isEmpty(priceRange)?'':#strings.substringBefore(priceRange,'_') }"> -



                            <input id="skuPriceTo" type="number" style="width: 100px;" th:value="${#strings.isEmpty(priceRange)?'':#strings.substringAfter(priceRange,'_') }"> <button id="skuPriceSearchBtn">确定</button>



                        </div>



                        <div class="filter_top_right">



                            <span class="fp-text">



                               <b>1</b><em>/</em><i>169</i>



                           </span>



                            <a href="/static/search/#" class="prev"><</a>



                            <a href="/static/search/#" class="next"> > </a>



                        </div>



                    </div>



                    <!--收货地址-->



                    <div class="filter_bottom">



                        <div class="filter_bottom_left">



                            <div class="fs-cell">收货地</div>



                            <div class="dizhi">



                                <div class="dizhi_show">



                                    <em>北京朝阳区三环以内</em>



                                    <b></b>



                                </div>



                            </div>



                            <div class="dizhi_con">



                                <ul id="tab">



                                    <li id="tab1" value="1">北京 <img src="/static/search/image/down-@1x.png" alt=""></li>



                                    <li id="tab2" value="2">朝阳 <img src="/static/search/image/down-@1x.png" alt=""></li>



                                    <li id="tab3" value="3">三环以内 <img src="/static/search/image/down-@1x.png" alt=""></li>



                                </ul>



                                <div id="container">



                                    <div id="content1" style="z-index: 1;">



                                        <a href="/static/search/#">北京</a>



                                        <a href="/static/search/#">上海</a>



                                        <a href="/static/search/#">天津</a>



                                        <a href="/static/search/#">重庆</a>



                                        <a href="/static/search/#">河北</a>



                                        <a href="/static/search/#">山西</a>



                                        <a href="/static/search/#">河南</a>



                                        <a href="/static/search/#">辽宁</a>



                                        <a href="/static/search/#">吉林</a>



                                        <a href="/static/search/#">黑龙江</a>



                                        <a href="/static/search/#">内蒙古</a>



                                        <a href="/static/search/#">江苏</a>



                                        <a href="/static/search/#">山东</a>



                                        <a href="/static/search/#">安徽</a>



                                        <a href="/static/search/#">浙江</a>



                                        <a href="/static/search/#">福建</a>



                                        <a href="/static/search/#">湖北</a>



                                        <a href="/static/search/#">湖南</a>



                                        <a href="/static/search/#">广东</a>



                                        <a href="/static/search/#">广西</a>



                                        <a href="/static/search/#">江西</a>



                                        <a href="/static/search/#">四川</a>



                                        <a href="/static/search/#">海南</a>



                                        <a href="/static/search/#">贵州</a>



                                        <a href="/static/search/#">云南</a>



                                        <a href="/static/search/#">西藏</a>



                                        <a href="/static/search/#">陕西</a>



                                        <a href="/static/search/#">甘肃</a>



                                        <a href="/static/search/#">青海</a>



                                        <a href="/static/search/#">宁夏</a>



                                        <a href="/static/search/#">新疆</a>



                                        <a href="/static/search/#">港澳</a>



                                        <a href="/static/search/#">台湾</a>



                                        <a href="/static/search/#">钓鱼岛</a>



                                        <a href="/static/search/#">海外</a>



 



                                    </div>



                                    <div id="content2">



                                        <a href="/static/search/#">朝阳区</a>



                                        <a href="/static/search/#">海淀区</a>



                                        <a href="/static/search/#">西城区</a>



                                        <a href="/static/search/#">东城区</a>



                                        <a href="/static/search/#">大兴区</a>



                                        <a href="/static/search/#">丰台区</a>



                                        <a href="/static/search/#">昌平区</a>



                                        <a href="/static/search/#">顺义区</a>



 



                                    </div>



                                    <div id="content3">



                                        <a href="/static/search/#">三环以内</a>



                                        <a href="/static/search/#">管庄</a>



                                        <a href="/static/search/#">北苑</a>



                                        <a href="/static/search/#">定福庄</a>



                                        <a href="/static/search/#">三环到四环之间</a>



                                        <a href="/static/search/#">四环到五环之间</a>



                                        <a href="/static/search/#">五环到六环之间</a>



                                    </div>



                                </div>



                            </div>



                        </div>



                        <div class="filter_bottom_right">



                            <ul>



                                <li>



                                    <a href="/static/search/#">



                                        <i></i>



                                        谷粒商城配送



                                    </a>



                                </li>



                                <li>



                                    <a href="/static/search/#">



                                        <i></i>



                                        京尊达                                    </a>



                                </li>



                                <li>



                                    <a href="/static/search/#">



                                        <i></i>



                                        货到付款



                                    </a>



                                </li>



                                <li>



                                    <a href="/static/search/#" th:with="check=${param.hasStock}">



                                        <input id="showHasStock" type="checkbox" th:checked="${#strings.equals(check,'1')}">



                                        仅显示有货



                                    </a>



                                </li>



                                <li>



                                    <a href="/static/search/#">



                                        <i></i>



                                        可配送全球



                                    </a>



                                </li>



                            </ul>



                        </div>



 



                    </div>



                    <!--排序内容-->



                    <div class="rig_tab">



                        <div th:each="product:${result.getProducts()}">



                            <div class="ico">



                                <i class="iconfont icon-weiguanzhu"></i>



                                <a href="/static/search/#">关注</a>



                            </div>



                            <p class="da">



                                <a href="/static/search/#" >



                                    <img th:src="${product.skuImg}" class="dim">



                                </a>



                            </p>



                            <ul class="tab_im">



                                <li><a href="/static/search/#" title="黑色">



                                    <img th:src="${product.skuImg}"></a></li>



                            </ul>



                            <p class="tab_R">



                                <span th:text="'¥'+${product.skuPrice}">¥5199.00</span>



                            </p>



                            <p class="tab_JE">



                                <a href="/static/search/#" th:utext="${product.skuTitle}">



                                    Apple iPhone 7 Plus (A1661) 32G 黑色 移动联通电信4G手机



                                </a>



                            </p>



                            <p class="tab_PI">已有<span>11万+</span>热门评价



                                <a href="/static/search/#">二手有售</a>



                            </p>



                            <p class="tab_CP"><a href="/static/search/#" title="谷粒商城Apple产品专营店">谷粒商城Apple产品...</a>



                                <a href='#' title="联系供应商进行咨询">



                                    <img src="/static/search/img/xcxc.png">



                                </a>



                            </p>



                            <div class="tab_FO">



                                <div class="FO_one">



                                    <p>自营



                                        <span>谷粒商城自营,品质保证</span>



                                    </p>



                                    <p>满赠



                                        <span>该商品参加满赠活动</span>



                                    </p>



                                </div>



                            </div>



                        </div>



                    </div>



                    <!--分页-->



                    <div class="filter_page">



                        <div class="page_wrap">



                            <span class="page_span1">



                                <a  class="page_a"  th:attr="pn=${result.pageNum - 1}"



                                    th:if="${result.pageNum>1}">



                                    < 上一页



                                </a>



                                <a class="page_a" th:attr="pn=${nav},style=${nav == result.pageNum ?'border: 0;color:#ee2222;background: #fff':''}"



                                   th:each="nav:${result.pageNavs}">[[${nav}]]</a>



                                <a class="page_a" th:attr="pn=${result.pageNum + 1}"



                                   th:if="${result.pageNum < result.totalPages}">



                                    下一页 >



                                </a>



                            </span>



                            <span class="page_span2">



                                <em>共<b>[[${result.totalPages}]]</b>页&nbsp;&nbsp;到第</em>



                                <input type="number" value="1">



                                <em>页</em>



                                <a class="page_submit" >确定</a>



                            </span>



                        </div>



                    </div>



                </div>



            </div>



        </div>



    </div>



</div>



 



<!--商品精选-->



<div class="JD_jx">



    <div class="JD_jx_title">



        <div class="mt">



            <strong class="mt-title">商品精选</strong>



            <img src="/static/search/image/u-ad.gif" alt="">



        </div>



        <div class="mc">



            <ul>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                            <img src="/static/search/img/5a25ffc7N98b35d49.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_name">



                        <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                            <em>【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待</em>



                        </a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥1999.00</span>



                        </strong>



                        <span class="mc_ico" title="购买本商品送赠品">赠品</span>



                    </div>



                    <div class="mc_rev">



                        <a href="/static/search/#">15930</a>



                        <span>人好评</span>



                    </div>



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                            <img src="/static/search/img/5a25ffc7N98b35d49.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_name">



                        <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                            <em>【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待</em>



                        </a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥1999.00</span>



                        </strong>



                        <span class="mc_ico" title="购买本商品送赠品">赠品</span>



                    </div>



                    <div class="mc_rev">



                        <a href="/static/search/#">15930</a>



                        <span>人好评</span>



                    </div>



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                            <img src="/static/search/img/5a25ffc7N98b35d49.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_name">



                        <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                            <em>【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待</em>



                        </a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥1999.00</span>



                        </strong>



                        <span class="mc_ico" title="购买本商品送赠品">赠品</span>



                    </div>



                    <div class="mc_rev">



                        <a href="/static/search/#">15930</a>



                        <span>人好评</span>



                    </div>



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                            <img src="/static/search/img/5a25ffc7N98b35d49.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_name">



                        <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                            <em>【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待</em>



                        </a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥1999.00</span>



                        </strong>



                        <span class="mc_ico" title="购买本商品送赠品">赠品</span>



                    </div>



                    <div class="mc_rev">



                        <a href="/static/search/#">15930</a>



                        <span>人好评</span>



                    </div>



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                            <img src="/static/search/img/5a25ffc7N98b35d49.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_name">



                        <a href="/static/search/#" title="【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待">



                            <em>【预约版】华为 HUAWEI 畅享7S 全面屏双摄 4GB +64GB 黑色 移动联通电信4G手机 双卡双待</em>



                        </a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥1999.00</span>



                        </strong>



                        <span class="mc_ico" title="购买本商品送赠品">赠品</span>



                    </div>



                    <div class="mc_rev">



                        <a href="/static/search/#">15930</a>



                        <span>人好评</span>



                    </div>



                </li>



            </ul>



 



 



        </div>



    </div>



</div>



 



<!--猜你喜欢-->



<div class="JD_cnxh">



    <div class="JD_jx_title">



        <div class="mt">



            <strong class="mt-title">猜你喜欢</strong>



            <a href="/static/search/#">



                <img src="/static/search/image/update.png" alt="">



                换一批



            </a>



        </div>



        <div class="mc">



            <ul>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <img src="/static/search/img/59bf3c47n91d65c73.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_name">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <em>诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机</em>



                        </a>



                    </div>



                    <div class="mc_rev">



                        <a href="/static/search/#">已有80万+人评价</a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥1999.00</span>



                        </strong>



                    </div>



 



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <img src="/static/search/img/5a28b5c6Ndec5088f.jpg" alt=""></a>



                    </div>



                    <div class="mc_name">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <em>诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机</em>



                        </a>



                    </div>



                    <div class="mc_rev">



                        <a href="/static/search/#">已有80万+人评价</a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥1999.00</span>



                        </strong>



                    </div>



 



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机"><img src="/static/search/img/593e4de0n5ff878a4.jpg" alt=""></a>



                    </div>



                    <div class="mc_name">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <em>诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机</em>



                        </a>



                    </div>



                    <div class="mc_rev">



                        <a href="/static/search/#">已有80万+人评价</a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥1999.00</span>



                        </strong>



                    </div>



 



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机"><img src="/static/search/img/593e4de0n5ff878a4.jpg" alt=""></a>



                    </div>



                    <div class="mc_name">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <em>诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机</em>



                        </a>



                    </div>



                    <div class="mc_rev">



                        <a href="/static/search/#">已有80万+人评价</a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥1999.00</span>



                        </strong>



                    </div>



 



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机"><img src="/static/search/img/59c493a7N3f9b9c85 (1).jpg" alt=""></a>



                    </div>



                    <div class="mc_name">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <em>诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机</em>



                        </a>



                    </div>



                    <div class="mc_rev">



                        <a href="/static/search/#">已有80万+人评价</a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥1999.00</span>



                        </strong>



                    </div>



 



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机"><img src="/static/search/img/59c493a7N3f9b9c85 (1).jpg" alt=""></a>



                    </div>



                    <div class="mc_name">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <em>诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机</em>



                        </a>



                    </div>



                    <div class="mc_rev">



                        <a href="/static/search/#">已有80万+人评价</a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥1999.00</span>



                        </strong>



                    </div>



 



                </li>



            </ul>



 



 



        </div>



    </div>



</div>



 



<!--我的足迹-->



<div class="JD_zuji">



    <div class="JD_jx_title">



        <div class="mt">



            <strong class="mt-title">我的足迹</strong>



            <a href="/static/search/#">



                更多浏览记录



            </a>



        </div>



        <div class="mc">



            <ul>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <img src="/static/search/img/59e58a11Nc38676d5.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥2998.00</span>



                        </strong>



                    </div>



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <img src="/static/search/img/5a28acccN73689386.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥88.00</span>



                        </strong>



                    </div>



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <img src="/static/search/img/5a1690ddN441b5dce.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥199.00</span>



                        </strong>



                    </div>



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <img src="/static/search/img/5a02bde7N7d4453b1.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥799.00</span>



                        </strong>



                    </div>



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <img src="/static/search/img/5a122dbeN044ebf19.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥599.00</span>



                        </strong>



                    </div>



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <img src="/static/search/img/59c493a7N3f9b9c85.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥699.00</span>



                        </strong>



                    </div>



                </li>



                <li>



                    <div class="mc_img">



                        <a href="/static/search/#" title="诺基亚 7 (Nokia 7) 4GB+64GB 黑色 全网通 双卡双待 移动联通电信4G手机">



                            <img src="/static/search/img/5a08f6f6N5bab2c1c.jpg" alt="">



                        </a>



                    </div>



                    <div class="mc_price">



                        <strong>



                            <span>￥715.00</span>



                        </strong>



                    </div>



                </li>



            </ul>



 



 



        </div>



    </div>



</div>



 



<div style="width: 1210px;margin: 0 auto;margin-bottom: 10px"><img src="/static/search/img/5a33a2e0N9a04b4af.jpg" alt=""></div>



<!--底部-->



<footer class="footer">



    <div class="footer_top">



        <ul>



            <li>



                <span></span>



                <h3>品类齐全，轻松购物</h3>



            </li>



            <li>



                <span></span>



                <h3>多仓直发，极速配发</h3>



            </li>



            <li>



                <span></span>



                <h3>正品行货，精致服务</h3>



            </li>



            <li>



                <span></span>



                <h3>天天低价，畅选无忧</h3>



            </li>



        </ul>



    </div>



    <div class="footer_center">



        <ol>



            <li>购物指南</li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">购物流程</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">会员介绍</a>



            </li>



            <li><a href="/static/search/#">生活旅行</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">常见问题</a>



            </li>



            <li><a href="/static/search/#">大家电</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">联系客服</a>



            </li>



        </ol>



        <ol>



            <li>配送方式</li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">上门自提</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">211限时达</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">配送服务查询</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">配送费收取标准</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">海外配送</a>



            </li>



        </ol>



        <ol>



            <li>支付方式</li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">货到付款</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">在线支付</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">分期付款</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">邮局汇款</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">公司转账</a>



 



            </li>



        </ol>



        <ol>



            <li>售后服务</li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">售后政策</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">价格保护</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">退款说明</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">返修/退换货</a>



            </li>



            <li><a href="/static/search/#">取消订单</a>



            </li>



        </ol>



        <ol>



            <li>特色服务</li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">夺宝岛</a>



            </li>



            <li><a href="/static/search/#">DIY装机</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">延保服务</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">谷粒商城E卡</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">谷粒商城通信</a>



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">谷粒商城gulimall+</a>



            </li>



        </ol>



        <ol>



            <li>谷粒商城自营覆盖区域</li>



            <li>



                谷粒商城已向全国2661个区县提供自<br> 营配送服务，支持货到付款、



                <br> POS机刷卡和售后上门服务。



            </li>



            <li><a href="/static/search/#" style="color: rgb(114, 114, 114);">查看详情&gt;</a>



            </li>



        </ol>



    </div>



    <div class="footer_foot">



        <p class="footer_p p1">



            <a href="/static/search/#">关于我们</a>



            <span></span>



            <a href="/static/search/#" style="color: rgb(114, 114, 114);">联系我们</a>



            <span></span>



            <a href="/static/search/#">联系客服</a>



            <span></span>



            <a href="/static/search/#" style="color: rgb(114, 114, 114);">合作招商</a>



            <span></span>



            <a href="/static/search/#" style="color: rgb(114, 114, 114);">商家帮助</a>



            <span></span>



            <a href="/static/search/#" style="color: rgb(114, 114, 114);">营销中心</a>



            <span></span>



            <a href="/static/search/#" style="color: rgb(114, 114, 114);">手机谷粒商城</a>



            <span></span>



            <a href="/static/search/#" style="color: rgb(114, 114, 114);">友情链接</a>



            <span></span>



            <a href="/static/search/#" style="color: rgb(114, 114, 114);">销售联盟</a>



            <span></span>



            <a href="/static/search/#" style="color: rgb(114, 114, 114);">谷粒商城社区</a>



            <span></span>



            <a href="/static/search/#" style="color: rgb(114, 114, 114);">风险监测</a>



            <span></span>



            <a href="/static/search/#">隐私政策</a>



            <span></span>



            <a href="/static/search/#">谷粒商城公益</a>



            <span></span>



            <a href="/static/search/#" style="color: rgb(114, 114, 114);">English Site</a>



            <span></span>



            <a href="/static/search/#">media &amp; IR</a>



        </p>



        <p class="footer_p">



            <a href="/static/search/#">京公网安备 11000002000088号</a>



            <span></span>



            <a href="/static/search/#">京ICP证070359号</a>



            <span></span>



            <a href="/static/search/#">互联网药品信息服务资格证编号(京)-经营性-2014-0008</a>



            <span></span>



            <a href="/static/search/#">新出发京零 字第大120007号</a>



        </p>



        <p class="footer_p">



            <a href="/static/search/#">互联网出版许可证编号新出网证(京)字150号</a>



            <span></span>



            <a href="/static/search/#">出版物经营许可证</a>



            <span></span>



            <a href="/static/search/#">网络文化经营许可证京网文[2014]2148-348号</a>



            <span></span>



            <a href="/static/search/#">违法和不良信息举报电话：4006561155</a>



        </p>



        <p class="footer_p">



            <a href="/static/search/#">Copyright © 2004 - 2017  谷粒商城JD.com 版权所有</a>



            <span></span>



            <a href="/static/search/#">消费者维权热线：4006067733</a>



            <a href="/static/search/#">经营证照</a>



        </p>



        <p class="footer_p">



            <a href="/static/search/#">谷粒商城旗下网站:</a>



            <a href="/static/search/#">谷粒商城支付</a>



            <span></span>



            <a href="/static/search/#">谷粒商城云</a>



        </p>



        <ul>



            <li></li>



            <li></li>



            <li></li>



            <li></li>



            <li></li>



            <li></li>



        </ul>



    </div>



</footer>



 



<!--右侧侧边栏-->



<div class="header_bar">



    <div class="header_bar_box">



        <ul>



            <li>



                <a href="/static/search/#"><img src="/static/search/img/wo.png" /></a>



                <div class="div">



                    <a href="/static/search/#">谷粒商城会员</a>



                </div>



            </li>



            <li>



                <a href="/static/search/#"><img src="/static/search/img/gouwuche.png" /></a>



                <div class="div">



                    <a href="/static/search/#">购物车</a>



                </div>



            </li>



            <li>



                <a href="/static/search/#"><img src="/static/search/img/taoxin.png" /></a>



                <div class="div">



                    <a href="/static/search/#">我的关注</a>



                </div>



            </li>



 



            <li>



                <a href="/static/search/#"><img src="/static/search/img/shi.png" /></a>



                <div class="div">



                    <a href="/static/search/#">我的足迹</a>



                </div>



            </li>



            <li>



                <a href="/static/search/#"><img src="/static/search/img/xinxi.png" /></a>



                <div class="div">



                    <a href="/static/search/#">我的消息</a>



                </div>



            </li>



            <li>



                <a href="/static/search/#"><img src="/static/search/img/qianbao.png" /></a>



                <div class="div">



                    <a href="/static/search/#">资讯JIMI</a>



                </div>



            </li>



        </ul>



        <ul>



            <li>



                <a href="/static/search/#"><img src="/static/search/img/fa3f24a70d38bd439261cb7439e517a5.png" /></a>



                <div class="div">



                    <a href="/static/search/#">顶部</a>



                </div>



            </li>



            <li>



                <a href="/static/search/#"><img src="/static/search/img/xinxi.png" /></a>



                <div class="div">



                    <a href="/static/search/#">反馈</a>



                </div>



            </li>



        </ul>



    </div>



</div>



 



<script>



    $(".sl_ext a:nth-child(1)").hover(function(){



        $(this).children("b").stop(true).animate({top:"3px"},50);



        $(this).children("i").stop(true).animate({top:"-23px"},50)



    },function(){



        $(this).children("b").stop(true).animate({top:"24px"},50);



        $(this).children("i").stop(true).animate({top:"3px"},50)



    });



    $(".sl_ext a:nth-child(2)").hover(function(){



        $(this).children("span").stop(true).animate({top:"-1px"},100);



        $(this).children("i").stop(true).animate({top:"-14px"},100).css({display:"none"})



    },function(){



        $(this).children("span").stop(true).animate({top:"14px"},100);



        $(this).children("i").stop(true).animate({top:"-1px"},100).css({display:"block"})



    });



    $('.tab_im img').hover(function(){



        var a=$(this).prop('src');



        var index=$(this).parents('li').index();



        $(this).parents('li').css('border','2px solid red').siblings('li').css('border','1px solid #ccc');



        $(this).parents('ul').prev().find('img').prop('src',a);



        $(this).parents('ul').siblings('.tab_JE').find('a').eq(list).css('display','block').siblings('a').css('display','none');



        $(this).parents('ul').siblings('.tab_R').find('span').eq(list).css('display','block').siblings('span').css('display','none')



    });



 



    $(".JD_ipone_one").hover(function(){



        $(this).children("div").css({display:"block"})



    },function(){



        $(this).children("div").css({display:"none"})



    });



 



    $("#tab>li").click(function() {



        var i = $(this).index();



        $("#container>div").hide().eq(i).show()



    });



    $(".dizhi_show").hover(function(){



        $(".dizhi_con").css({display:"block"})



    },function(){



        $(".dizhi_con").css({display:"none"})



    });



    $(".dizhi_con").hover(function(){



        $(this).css({display:"block"})



    },function(){



        $(this).css({display:"none"})



    });



    //显示隐藏



    var $li = $(".JD_nav_logo>div:gt(3)").hide();



    $('.JD_show span').click(function(){



        if($li.is(':hidden')){



            $li.show();



            $(this).css({width:"86px"}).text('收起 ^');



        }else{



            $li.hide();



            $('.JD_show span').css({width:"291px"}).text('更多选项（ CPU核数、网络、机身颜色 等）');



        }



        return false;



    });



 



 



 



    $(".rig_tab>div").hover(function(){



        var i = $(this).index();



        $(this).find('.ico').css({display:'block'}).stop(true).animate({top:"190px"},300)



    },function(){



        var i = $(this).index();



        $(this).find('.ico').css({display:'none'}).stop(true).animate({top:"230px"})



    });



 



    $('.header_main_left>ul>li').hover(function() {



        $(this).css({



            background: "#f0f0f0"



        }).find('.header_main_left_main').stop(true).fadeIn(300)



    }, function() {



        $(this).css({



            background: "#fff"



        }).find(".header_main_left_a").css({



            color: "#000"



        });



        $(this).find('.header_main_left_main').stop(true).fadeOut(100)



    });



    $(".header_sj a").hover(function() {



        $(this).css({



            background: "#444"



        })



    }, function() {



        $(this).css({



            background: "#6e6568"



        })



    });



 



 



    $(".nav_li1 a").hover(function(){



        $(".header_main_left").stop(true).fadeIn()



    },function(){



        $(".header_main_left").stop(true).fadeOut()



    });



    $(".header_main_left").hover(function(){



        $(this).stop(true).fadeIn()



    },function(){



        $(this).stop(true).fadeOut()



    });



 



 



    //右侧侧边栏



    $(".header_bar_box ul li").hover(function() {



        $(this).css({



            background: "#7A6E6E"



        }).children(".div").css({



            display: "block"



        }).stop(true).animate({



            left: "-60px"



        }, 300)



    }, function() {



        $(this).css({



            background: "#7A6E6E"



        }).children(".div").css({



            display: "none"



        }).stop(true).animate({



            left: "0"



        }, 300)



    });



 



 



    //底部



    $(".footer_foot .p1 a").hover(function(){



        $(this).css("color","#D70B1C")



    },function(){



        $(this).css("color","#727272")



    });



 



    $(".footer .footer_center ol li a").hover(function(){



        $(this).css("color","#D70B1C")



    },function(){



        $(this).css("color","#727272")



    })



    function  searchProducts(name,value) {



        console.log(name);



       //原来页面



        var href = location.href + "";



        if(href.indexOf("attrs")!=-1 && name == "attrs"){



            location.href =  replaceAndAddParamVal(href,name,value,true);



        }else{



            location.href =  replaceAndAddParamVal(href,name,value,false);



        }



 



    }



 



    $(".page_a").click(function () {



      var pn = $(this).attr("pn");



      var href = location.href;



      if(href.indexOf("pageNum")!=-1){



          location.href = replaceAndAddParamVal(href,"pageNum",pn,false);



      }else{



          location.href = location.href + "&pageNum="+pn;



      }



    })



 



    function replaceAndAddParamVal(url,paramName,replaceVal,forceAdd) {



        var oUrl = url.toString();



        if(oUrl.indexOf(paramName)!=-1){



            if(forceAdd){



                var nUrl = "";



                if(oUrl.indexOf("?")!=-1){



                    nUrl = oUrl + "&"+paramName+'='+replaceVal;



                }else{



                    nUrl = oUrl + "?"+paramName+'='+replaceVal;



                }



                return nUrl;



            }else{



                var re = eval('/('+ paramName+'=)([^&]*)/gi');



                var nUrl = oUrl.replace(re,paramName+'='+replaceVal);



                return nUrl;



            }



        }else{



            var nUrl = "";



            if(oUrl.indexOf("?")!=-1){



                nUrl = oUrl + "&"+paramName+'='+replaceVal;



            }else{



                nUrl = oUrl + "?"+paramName+'='+replaceVal;



            }



            return nUrl;



        }



    }



    



    function searchByKeyword() {



        searchProducts("keyword",$("#keyword_input").val());



    }



 



    $(".sort_a").click(function () {



    //     chageStyle(this);



         $(this).toggleClass("desc");



         var sort = $(this).attr("sort");



         sort = $(this).hasClass("desc")?sort+"_desc":sort+"_asc";



         location.href = replaceAndAddParamVal(location.href,"sort",sort,false);



         return false;



    });



 



    //'color: #FFF;border-color:#e4393c;background: #e4393c'



    function chageStyle(ele) {



        $(".sort_a").css({"color":"#333","border-color":"#CCC","background":"#FFF"});



        $(".sort_a").each(function () {



            var text = $(this).text().replace("↓","").replace("↑","");



            $(this).text(text);



        });



 



        $(ele).css({"color":"#FFF","border-color":"#e4393c","background":"#e4393c"});



 



        $(ele).toggleClass("desc");



        if($(ele).hasClass("desc")){



            var text = $(ele).text().replace("↓","").replace("↑","");



            text = text + "↓";



            $(ele).text(text);



        }else{



            var text = $(ele).text().replace("↓","").replace("↑","");



            text = text + "↑";



            $(ele).text(text);



        }



    }



 



    $("#skuPriceSearchBtn").click(function () {



         var from = $("#skuPriceFrom").val();



         var to = $("#skuPriceTo").val();



 



         var query = from + "_" + to;



 



         location.href = replaceAndAddParamVal(location.href,"skuPrice",query,false);



    });



 



    $("#showHasStock").change(function () {



        if($(this).prop('checked')){



            location.href =  replaceAndAddParamVal(location.href,"hasStock",1,false);



        }else{



            var re = eval('/(hasStock=)([^&]*)/gi');



            location.href = (location.href+"").replace(re,'');



        }



    });



 



</script>



</body>



</html>
```

#### 效果图

![image-20200702170647261](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcwMjE3MDY0NzI2MS5wbmc)

## 谷粒商城异步编排(三十一)

## CompletableFuture异步编排(193-202)

```java
/**



 * @author WGR



 * @create 2020/7/7 -- 19:34



 */



public class ThreadTest {



    public static ExecutorService executor =  Executors.newFixedThreadPool(10);



 



    public static void main(String[] args) {



        System.out.println("main......start");



        CompletableFuture<Integer> future = CompletableFuture.supplyAsync(() -> {



            System.out.println("当前线程：" + Thread.currentThread().getId());



            int i = 10 / 2;



            System.out.println("运行结果：" + i);



            return i;



        }, executor).whenCompleteAsync((t, e) -> {



            System.out.println("结果是：" + t + "异常:" + e);



        }).exceptionally(throwable -> {



            return 10;



        });



        Integer integer = future.get();



        System.out.println("main......end");



    }



}
```

代码：

```java
public static void main(String[] args) throws ExecutionException, InterruptedException {



        System.out.println("main......start");



        CompletableFuture<Integer> future = CompletableFuture.supplyAsync(() -> {



            System.out.println("当前线程：" + Thread.currentThread().getId());



            int i = 10 / 0;



            System.out.println("运行结果：" + i);



            return i;



        }, executor).handle((res, thr) -> {



            if (res!=null) {



                return res*2;



            }



            if(thr!=null){



                return 0;



            }



            return 0;



        });



        Integer integer = future.get();



        System.out.println("main......end"+integer);



    }
public static void main(String[] args) throws ExecutionException, InterruptedException {



        System.out.println("main......start");



         CompletableFuture.supplyAsync(() -> {



            System.out.println("当前线程：" + Thread.currentThread().getId());



            int i = 10 / 2;



            System.out.println("运行结果：" + i);



            return i;



        }, executor).thenRunAsync(() ->{



            System.out.println("线程二开始");



        },executor);



        System.out.println("main......end");



    }
```

日志：

```java
main......start



main......end



当前线程：11



运行结果：5



线程二开始
```

总结：thenRunAsync，不能获取上一步执行的数据，也没结果

```java
public static void main(String[] args) throws ExecutionException, InterruptedException {



        System.out.println("main......start");



         CompletableFuture.supplyAsync(() -> {



            System.out.println("当前线程：" + Thread.currentThread().getId());



            int i = 10 / 2;



            System.out.println("运行结果：" + i);



            return i;



        }, executor).thenAcceptAsync( i ->{



             System.out.println("任务二拿到的结果：" + i);



         });



        System.out.println("main......end");



    }
main......start



main......end



当前线程：11



运行结果：5



任务二拿到的结果：5
```

总结：thenAcceptAsync能获取上一步执行的数据，没结果

```java
public static void main(String[] args) throws ExecutionException, InterruptedException {



        System.out.println("main......start");



        CompletableFuture<Integer> future = CompletableFuture.supplyAsync(() -> {



            System.out.println("当前线程：" + Thread.currentThread().getId());



            int i = 10 / 2;



            System.out.println("运行结果：" + i);



            return i;



        }, executor).thenApplyAsync(res -> {



            System.out.println("任务2启动了。。。。" + res);



            return res * 2;



        }, executor);



        System.out.println(future.get());



        System.out.println("main......end");



    }
main......start



当前线程：11



运行结果：5



任务2启动了。。。。5



10



main......end
```

**两个任务组合之都要完成**

thenCombine:组合2个future，获取2个future的返回结果，并返回当前任务的返回值。

thenAcceptBoth:组合2个future，获取2个future任务的返回结果，然后处理任务，没用返回值。

runAfter：组合2个future，不需要获取future的结果，只需2个future处理完任务后，处理该任务。

```java
public static void main(String[] args)  {



        System.out.println("main......start");



        CompletableFuture<Integer> future01 = CompletableFuture.supplyAsync(() -> {



            System.out.println("任务1线程:" + Thread.currentThread().getId());



            System.out.println("任务1结束");



            return 3;



        }, executor);



        CompletableFuture<String> future02 = CompletableFuture.supplyAsync(() -> {



            System.out.println("任务2线程:" + Thread.currentThread().getId());



            System.out.println("任务2结束");



            return "Hello";



        }, executor);



        future01.runAfterBothAsync(future02,()->{



            System.out.println("任务3开始。。。");



        },executor);



        System.out.println("main......end");



    }
```

结果：

```log
main......start



main......end



任务1线程:11



任务1结束



任务2线程:12



任务2结束



任务3开始。。。
```

代码：

```java
public static void main(String[] args)  {



        System.out.println("main......start");



        CompletableFuture<Integer> future01 = CompletableFuture.supplyAsync(() -> {



            System.out.println("任务1线程:" + Thread.currentThread().getId());



            System.out.println("任务1结束");



            return 3;



        }, executor);



        CompletableFuture<String> future02 = CompletableFuture.supplyAsync(() -> {



            System.out.println("任务2线程:" + Thread.currentThread().getId());



            System.out.println("任务2结束");



            return "Hello";



        }, executor);



        future01.thenAcceptBothAsync(future02,(f1,f2)->{



            System.out.println("任务3开始。。。之前的结果"+f1+">>>"+f2);



        },executor);



        System.out.println("main......end");



    }
```

日志：

```java
main......start



main......end



任务1线程:11



任务2线程:12



任务1结束



任务2结束



任务3开始。。。之前的结果3>>>Hello
public static void main(String[] args) throws ExecutionException, InterruptedException {



        System.out.println("main......start");



        CompletableFuture<Integer> future01 = CompletableFuture.supplyAsync(() -> {



            System.out.println("任务1线程:" + Thread.currentThread().getId());



            System.out.println("任务1结束");



            return 3;



        }, executor);



        CompletableFuture<String> future02 = CompletableFuture.supplyAsync(() -> {



            System.out.println("任务2线程:" + Thread.currentThread().getId());



            System.out.println("任务2结束");



            return "Hello";



        }, executor);



        CompletableFuture<String> future = future01.thenCombineAsync(future02, (f1, f2) -> {



            return "结果" + f1 + ">>>" + f2;



        }, executor);



        System.out.println("main......end"+future.get());



    }
```

结果：

```
main......start



任务1线程:11



任务1结束



任务2线程:12



任务2结束



main......end结果3>>>Hello
```

**2个任务一个完成**

applyToEither:2个任务有一个执行完成，获取它的返回值,处理任务有新的返回值。

acceptEither:2个任务有一个执行完成，获取它的返回值，处理任务，没有新的返回值。

applyToEither:2个任务有一个执行完成，不需要获取future的结果，处理任务，也没有返回值

```java
public static void main(String[] args) throws ExecutionException, InterruptedException {



        System.out.println("main......start");



        CompletableFuture<Integer> future01 = CompletableFuture.supplyAsync(() -> {



            System.out.println("任务1线程:" + Thread.currentThread().getId());



            System.out.println("任务1结束");



            return 3;



        }, executor);



        CompletableFuture<String> future02 = CompletableFuture.supplyAsync(() -> {



            System.out.println("任务2线程:" + Thread.currentThread().getId());



            try {



                Thread.sleep(10000);



            } catch (InterruptedException e) {



                e.printStackTrace();



            }



            System.out.println("任务2结束");



            return "Hello";



        }, executor);



        future01.runAfterEitherAsync(future02,()->{



            System.out.println("任务3开始");



        },executor);



        System.out.println("main......end");



    }
```

日志：

```java
main......start



任务1线程:11



任务1结束



任务2线程:12



main......end



任务3开始



任务2结束
public static void main(String[] args) throws ExecutionException, InterruptedException {



        System.out.println("main......start");



        CompletableFuture<Object> future01 = CompletableFuture.supplyAsync(() -> {



            System.out.println("任务1线程:" + Thread.currentThread().getId());



            System.out.println("任务1结束");



            return 3;



        }, executor);



        CompletableFuture<Object> future02 = CompletableFuture.supplyAsync(() -> {



            System.out.println("任务2线程:" + Thread.currentThread().getId());



            try {



                Thread.sleep(10000);



            } catch (InterruptedException e) {



                e.printStackTrace();



            }



            System.out.println("任务2结束");



            return "Hello";



        }, executor);



        future01.acceptEitherAsync(future02,(res)->{



            System.out.println("任务3开始"+res);



        },executor);



        System.out.println("main......end");



    }
```

日志：

```
main......start



任务1线程:11



任务1结束



任务2线程:12



main......end



任务3开始3



任务2结束
public static void main(String[] args) throws ExecutionException, InterruptedException {



        System.out.println("main......start");



        CompletableFuture<Object> future01 = CompletableFuture.supplyAsync(() -> {



            System.out.println("任务1线程:" + Thread.currentThread().getId());



            System.out.println("任务1结束");



            return "3";



        }, executor);



        CompletableFuture<Object> future02 = CompletableFuture.supplyAsync(() -> {



            System.out.println("任务2线程:" + Thread.currentThread().getId());



            try {



                Thread.sleep(10000);



            } catch (InterruptedException e) {



                e.printStackTrace();



            }



            System.out.println("任务2结束");



            return "Hello";



        }, executor);



        CompletableFuture<String> future = future01.applyToEitherAsync(future02, (res) -> {



            System.out.println("任务3开始." + res);



            return "dalianpai";



        }, executor);



        System.out.println("main......end"+future.get());



    }
```

日志：

```java
main......start



任务1线程:11



任务1结束



任务2线程:12



任务3开始.3



main......enddalianpai



任务2结束
```

代码：

```java
public static void main(String[] args) throws ExecutionException, InterruptedException {



        System.out.println("main......start");



        CompletableFuture<String> futureImg = CompletableFuture.supplyAsync(() -> {



            System.out.println("查询商品的图片信息");



            return "hellp.jpg";



        }, executor);



        CompletableFuture<String> futureAttr = CompletableFuture.supplyAsync(() -> {



            System.out.println("查询商品的属性");



            return "黑色+256G";



        }, executor);



        CompletableFuture<Object> futureDesc = CompletableFuture.supplyAsync(() -> {



            try {



                Thread.sleep(3000);



                System.out.println("查询商品介绍");



            } catch (InterruptedException e) {



                e.printStackTrace();



            }



            return "华为";



        }, executor);



//        CompletableFuture<Void> allOf = CompletableFuture.allOf(futureImg, futureAttr, futureDesc);



//        allOf.get();  //阻塞



        CompletableFuture<Object> anyOf = CompletableFuture.anyOf(futureImg, futureAttr, futureDesc);



        Object o = anyOf.get();



        System.out.println("main......end"+o);



    }
```

日志：

```java
main......start



查询商品的图片信息



查询商品的属性



main......endhellp.jpg



查询商品介绍
```

## 谷粒商城异步编排(三十二)

### 202-210

敲完了这个阶段，感觉最后整合的时候还是特别有用的，在工作中还是很有用的。这个阶段没啥太技术含量的东西，就一笔带过了。

最后整合的代码：

```java
@Override



    public SkuItemVo item(Long skuId) throws ExecutionException, InterruptedException {



        SkuItemVo skuItemVo = new SkuItemVo();



        CompletableFuture<SkuInfoEntity> infoFuture = CompletableFuture.supplyAsync(() -> {



            SkuInfoEntity info = getById(skuId);



            skuItemVo.setInfo(info);



            return info;



        }, executor);



        CompletableFuture<Void> saleAttrFuture = infoFuture.thenAcceptAsync((res) -> {



            //3.获取spu的销售属性组合



            List<SkuItemSaleAttrVo> saleAttrVos = skuSaleAttrValueService.getSaleAttrsBySpuId(res.getSpuId());



            skuItemVo.setSaleAttr(saleAttrVos);



        }, executor);



 



        CompletableFuture<Void> descFuture = infoFuture.thenAcceptAsync((res) -> {



            //4.获取spu的介绍



            SpuInfoDescEntity spuInfoDescEntity = spuInfoDescService.getById(res.getSpuId());



            skuItemVo.setDesp(spuInfoDescEntity);



        }, executor);



 



        CompletableFuture<Void> baseAttrFuture = infoFuture.thenAcceptAsync((res) -> {



            //5



            List<SpuItemAttrGroupVo>  attrGroupVos = attrGroupService.getAttrGroupWithAttrsBySpuId(res.getSpuId(),res.getCatalogId());



            skuItemVo.setGroupAttrs(attrGroupVos);



        }, executor);



 



        CompletableFuture<Void> imagesFuture = CompletableFuture.runAsync(() -> {



            List<SkuImagesEntity> images = imagesService.getImagesBySkuId(skuId);



            skuItemVo.setImages(images);



        }, executor);



 



        CompletableFuture.allOf(saleAttrFuture,descFuture,baseAttrFuture,imagesFuture).get();



        return skuItemVo;



 



    }
```

几个重要的sql，也比较简单，重要的是有思路，知道需要什么样的sql

```xml
<resultMap id="SkuItemSaleAttrVo" type="com.dalianpai.gulimall.product.vo.SkuItemSaleAttrVo">



        <result column="attr_id" property="attrId"></result>



        <result column="attr_name" property="attrName"></result>



        <collection property="attrValues" ofType="com.dalianpai.gulimall.product.vo.AttrValueWithSkuIdVo">



            <result column="attr_value" property="attrValue"></result>



            <result column="sku_ids" property="skuIds"></result>



        </collection>



    </resultMap>



    <select id="getSaleAttrsBySpuId" resultMap="SkuItemSaleAttrVo">



        select ssav.attr_id  attr_id,



        ssav.attr_name  attr_name,



        ssav.attr_value,



        GROUP_CONCAT(distinct info.sku_id)  sku_ids



        FROM



        pms_sku_info info



        left join pms_sku_sale_attr_value ssav on ssav.sku_id=info.sku_id



        where info.spu_id = #{spuId}



        group by ssav.attr_id,ssav.attr_name,ssav.attr_value



    </select>
<resultMap id="spuItemAttrGroupVo" type="com.dalianpai.gulimall.product.vo.SpuItemAttrGroupVo">



        <result property="groupName" column="attr_group_name"/>



        <collection property="attrValues" ofType="com.dalianpai.gulimall.product.vo.Attr">



            <result column="attr_names" property="attrName"></result>



            <result column="attr_value" property="attrValue"></result>



        </collection>



    </resultMap>



    <select id="getAttrGroupWithAttrsBySpuId"



            resultMap="spuItemAttrGroupVo">



 



        select



            pav.spu_id,



            ag.attr_group_name,



            ag.attr_group_id,



            aar.attr_id,



            attr.attr_name,



            pav.attr_value



             FROM pms_attr_group ag



            left join pms_attr_attrgroup_relation aar on aar.attr_group_id = ag.attr_group_id



            left join pms_attr  attr on attr.attr_id = aar.attr_id



            left join pms_product_attr_value pav on pav.attr_id = attr.attr_id



            where ag.catelog_id=#{catalogId} AND pav.spu_id =#{spuId}



    </select>
```

商品详情页的html:

```html
<!DOCTYPE html>



<html lang="en" xmlns:th="http://www.thymeleaf.org">



 



	<head>



		<meta charset="UTF-8">



		<title></title>



		<link rel="stylesheet" type="text/css" href="/static/item/scss/shop.css" />



		<link rel="stylesheet" type="text/css" href="/static/item/scss/jd.css"/>



		<link rel="stylesheet" href="/static/item/scss/header.css" />



		<link rel="stylesheet" type="text/css" href="/static/item/bootstrap/css/bootstrap.css"/>



	</head>



	<body>



		<div id="max">



		<header>



			<!--品牌官方网站-->



					<div class="min">



						<ul class="header_ul_left">



							<li class="glyphicon glyphicon-home"> <a href="/static/item/shouye.html" class="aa">京东首页</a></li>



							<li class="glyphicon glyphicon-map-marker"> <a href="/static/item/javascript:;">北京</a>



								<ol id="beijing">



									<li style="background: red;"><a href="/static/item/javascript:;" style="color: white;">北京</a></li>



									<li><a href="/static/item/javascript:;">上海</a></li>



									<li><a href="/static/item/javascript:;">天津</a></li>



									<li><a href="/static/item/javascript:;">重庆</a></li>



									<li><a href="/static/item/javascript:;">河北</a></li>



									<li><a href="/static/item/javascript:;">山西</a></li>



									<li><a href="/static/item/javascript:;">河南</a></li>



									<li><a href="/static/item/javascript:;">辽宁</a></li>



									<li><a href="/static/item/javascript:;">吉林</a></li>



									<li><a href="/static/item/javascript:;">黑龙江</a></li>



									<li><a href="/static/item/javascript:;">内蒙古</a></li>



									<li><a href="/static/item/javascript:;">江苏</a></li>



									<li><a href="/static/item/javascript:;">山东</a></li>



									<li><a href="/static/item/javascript:;">安徽</a></li>



									<li><a href="/static/item/javascript:;">浙江</a></li>



									<li><a href="/static/item/javascript:;">福建</a></li>



									<li><a href="/static/item/javascript:;">湖北</a></li>



									<li><a href="/static/item/javascript:;">湖南</a></li>



									<li><a href="/static/item/javascript:;">广东</a></li>



									<li><a href="/static/item/javascript:;">广西</a></li>



									<li><a href="/static/item/javascript:;">江西</a></li>



									<li><a href="/static/item/javascript:;">四川</a></li>



									<li><a href="/static/item/javascript:;">海南</a></li>



									<li><a href="/static/item/javascript:;">贵州</a></li>



									<li><a href="/static/item/javascript:;">云南</a></li>



									<li><a href="/static/item/javascript:;">西藏</a></li>



									<li><a href="/static/item/javascript:;">陕西</a></li>



									<li><a href="/static/item/javascript:;">甘肃</a></li>



									<li><a href="/static/item/javascript:;">青海</a></li>



									<li><a href="/static/item/javascript:;">宁夏</a></li>



									<li><a href="/static/item/javascript:;">新疆</a></li>



									<li><a href="/static/item/javascript:;">港澳</a></li>



									<li><a href="/static/item/javascript:;">台湾</a></li>



									<li><a href="/static/item/javascript:;">钓鱼岛</a></li>



									<li><a href="/static/item/javascript:;">海外</a></li>



								</ol>



							</li>



						</ul>



						<ul class="header_ul_right">



							<li style="border: 0;"><a href="/static/item/../登录页面\index.html" class="aa">你好，请登录</a></li>



							<li><a href="/static/item/../注册页面\index.html" style="color: red;">免费注册</a> |</li>



							<li><a href="/static/item/javascript:;" class="aa">我的订单</a> |</li>



							<li class="jingdong"><a href="/static/item/javascript:;">我的京东</a><span class="glyphicon glyphicon-menu-down">|</span>



								<ol class="jingdong_ol">



									<li><a href="/static/item/javascript:;">待处理订单</a></li>



									<li><a href="/static/item/javascript:;">消息</a></li>



									<li><a href="/static/item/javascript:;">返修退换货</a></li>



									<li><a href="/static/item/javascript:;">我的回答</a></li>



									<li><a href="/static/item/javascript:;">降价商品</a></li>



									<li><a href="/static/item/javascript:;">我的关注</a></li>



									<li style="width: 100%;height: 1px;background: lavender;margin-top: 15px;"></li>



									<li style="margin-top: 0;"><a href="/static/item/javascript:;">我的京豆</a></li>



									<li style="margin-top: 0;"><a href="/static/item/javascript:;">我的优惠券</a></li>



									<li style="margin-bottom: 10px;"><a href="/static/item/javascript:;">我的白条</a></li>



 



								</ol>



							</li>



 



							<li><a href="/static/item/javascript:;" class="aa">京东会员</a> |</li>



							<li><a href="/static/item/javascript:;" class="aa">企业采购</a> |</li>



							<li class="fuwu"><a href="/static/item/javascript:;">客户服务</a><span class="glyphicon glyphicon-menu-down"></span> |



								<ol class="fuwu_ol">



									<h6>客户</h6>



									<li><a href="/static/item/javascript:;">帮助中心</a></li>



									<li><a href="/static/item/javascript:;">售后服务</a></li>



									<li><a href="/static/item/javascript:;">在线客服</a></li>



									<li><a href="/static/item/javascript:;">意见建议</a></li>



									<li><a href="/static/item/javascript:;">电话客服</a></li>



									<li><a href="/static/item/javascript:;">客服邮箱</a></li>



									<li style="margin-bottom: -5px;"><a href="/static/item/javascript:;">金融咨询</a></li>



									<li style="margin-bottom: -5px;"><a href="/static/item/javascript:;">售全球客服</a></li>



									<h6 style="border-top: 1px dashed darkgray;height: 30px;line-height: 30px;">商户</h6>



									<li style="margin-top: -5px;"><a href="/static/item/javascript:;">合作招商</a></li>



									<li style="margin-top: -5px;"><a href="/static/item/javascript:;">学习中心</a></li>



									<li><a href="/static/item/javascript:;">商家后台</a></li>



									<li><a href="/static/item/javascript:;">京麦工作台</a></li>



									<li><a href="/static/item/javascript:;">商家帮助</a></li>



									<li><a href="/static/item/javascript:;">规则平台</a></li>



								</ol>



							</li>



							<li class="daohang"><a href="/static/item/javascript:;">网站导航</a><span class="glyphicon glyphicon-menu-down"></span> |



								<ol class="daohang_ol">



									<li style="width: 34%;">



										<h5>特色主题</h5>



										<p>



											<a href="/static/item/javascript:;">京东试用</a>



											<a href="/static/item/javascript:;">京东金融</a>



											<a href="/static/item/javascript:;">全球售</a>



											<a href="/static/item/javascript:;">国际站</a>



										</p>



										<p>



											<a href="/static/item/javascript:;">京东会员</a>



											<a href="/static/item/javascript:;">京东预售</a>



											<a href="/static/item/javascript:;">买什么</a>



											<a href="/static/item/javascript:;">俄语站</a>



										</p>



										<p>



											<a href="/static/item/javascript:;">装机大师</a>



											<a href="/static/item/javascript:;">0元评测</a>



											<a href="/static/item/javascript:;">定期送</a>



											<a href="/static/item/javascript:;">港澳售</a>



										</p>



										<p>



											<a href="/static/item/javascript:;">优惠券</a>



											<a href="/static/item/javascript:;">秒杀</a>



											<a href="/static/item/javascript:;">闪购</a>



											<a href="/static/item/javascript:;">印尼站</a>



										</p>



										<p>



											<a href="/static/item/javascript:;">京东金融科技</a>



											<a href="/static/item/javascript:;">In货推荐</a>



											<a href="/static/item/javascript:;">陪伴计划</a>



											<a href="/static/item/javascript:;">出海招商</a>



										</p>



									</li>



									<li>



										<h5>行业频道</h5>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">手机</a>



											<a href="/static/item/javascript:;" class="aa_2">智能数码</a>



											<a href="/static/item/javascript:;" class="aa_2">玩3C</a>



										</p>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">电脑办公</a>



											<a href="/static/item/javascript:;" class="aa_2">家用电器</a>



											<a href="/static/item/javascript:;" class="aa_2">京东智能</a>



										</p>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">服装城</a>



											<a href="/static/item/javascript:;" class="aa_2">美妆馆</a>



											<a href="/static/item/javascript:;" class="aa_2">家装城</a>



										</p>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">母婴</a>



											<a href="/static/item/javascript:;" class="aa_2">食品</a>



											<a href="/static/item/javascript:;" class="aa_2">运动户外</a>



										</p>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">农资频道</a>



											<a href="/static/item/javascript:;" class="aa_2">整车</a>



											<a href="/static/item/javascript:;" class="aa_2">图书</a>



										</p>



									</li>



									<li>



										<h5>生活服务</h5>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">京东众筹</a>



											<a href="/static/item/javascript:;" class="aa_2">白条</a>



											<a href="/static/item/javascript:;" class="aa_2">京东金融APP</a>



										</p>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">京东小金库</a>



											<a href="/static/item/javascript:;" class="aa_2">理财</a>



											<a href="/static/item/javascript:;" class="aa_2">智能家电</a>



										</p>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">话费</a>



											<a href="/static/item/javascript:;" class="aa_2">水电煤</a>



											<a href="/static/item/javascript:;" class="aa_2">彩票</a>



										</p>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">旅行</a>



											<a href="/static/item/javascript:;" class="aa_2">机票酒店</a>



											<a href="/static/item/javascript:;" class="aa_2">电影票</a>



										</p>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">京东到家</a>



											<a href="/static/item/javascript:;" class="aa_2">京东众测</a>



											<a href="/static/item/javascript:;" class="aa_2">游戏</a>



										</p>



									</li>



									<li style="border: 0;">



										<h5>更多精选</h5>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">合作招商</a>



											<a href="/static/item/javascript:;" class="aa_2">京东通信</a>



											<a href="/static/item/javascript:;" class="aa_2">京东E卡</a>



										</p>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">企业采购</a>



											<a href="/static/item/javascript:;" class="aa_2">服务市场</a>



											<a href="/static/item/javascript:;" class="aa_2">办公生活馆</a>



										</p>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">乡村招募</a>



											<a href="/static/item/javascript:;" class="aa_2">校园加盟</a>



											<a href="/static/item/javascript:;" class="aa_2">京友邦</a>



										</p>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">京东社区</a>



											<a href="/static/item/javascript:;" class="aa_2">智能社区</a>



											<a href="/static/item/javascript:;" class="aa_2">游戏社区</a>



										</p>



										<p>



											<a href="/static/item/javascript:;" class="aa_2">知识产权维权</a>



											<a href="/static/item/javascript:;" class="aa_2"></a>



											<a href="/static/item/javascript:;" class="aa_2"></a>



										</p>



									</li>



								</ol>



							</li>



							<li class="sjjd" style="border: 0;"><a href="/static/item/javascript:;" class="aa">手机京东</a>



								<div class="er">



									<div class="er_1">



										<div class="er_1_1">



											<h6><a href="/static/item/#">手机京东</a></h6>



											<p>新人专享大礼包</p>



 



										</div>



									</div>



									<div class="er_1">



										<div class="er_1_1">



											<h6><a href="/static/item/#">关注京东微信</a></h6>



											<p>微信扫一扫关注新粉最高180元惊喜礼包</p>



										</div>



									</div>



									<!--我的理财-->



									<div class="er_1" style="border: 0;">



										<img src="/static/item/img/5874a555Ne8192324.jpg"/>



										<div class="er_1_1">



											<h6><a href="/static/item/#">京东金融客户端</a></h6>



											<p>新人专享大礼包</p>



											<div><a href="/static/item/#"><img src="/static/item/img/11.png"/></a><a href="/static/item/#"><img src="/static/item/img/22.png"/></a></div>



										</div>



									</div>



								</div>



							</li>



						</ul>



					</div>



				</header>



				<nav>



				<div class="nav_min">



					<div class="nav_top">



						<div class="nav_top_one"><a href="/static/item/#"><img src="/static/item/img/111.png"/></a></div>



						<div class="nav_top_two"><input type="text"/><button>搜索</button></div>



						<div class="nav_top_three"><a href="/static/item/../JD_Shop/One_JDshop.html">我的购物车</a><span class="glyphicon glyphicon-shopping-cart"></span>



							<div class="nav_top_three_1">



								<img src="/static/item/img/44.png"/>购物车还没有商品，赶紧选购吧！



							</div>



						</div>



					</div>



					<div class="nav_down">



						<ul class="nav_down_ul">



							<li class="nav_down_ul_1" style="width: 24%;float: left;"><a href="/static/item/javascript:;">全部商品分类</a>



 



							</li>



							<li class="ul_li"><a href="/static/item/javascript:;">服装城</a></li>



							<li class="ul_li"><a href="/static/item/javascript:;">美妆馆</a></li>



							<li class="ul_li"><a href="/static/item/javascript:;">超市</a></li>



							<li class="ul_li" style="border-right: 1px solid lavender;"><a href="/static/item/javascript:;">生鲜</a></li>



							<li class="ul_li"><a href="/static/item/javascript:;">全球购</a></li>



							<li class="ul_li"><a href="/static/item/javascript:;">闪购</a></li>



							<li class="ul_li" style="border-right: 1px solid lavender;"><a href="/static/item/javascript:;">拍卖</a></li>



							<li class="ul_li"><a href="/static/item/javascript:;">金融</a></li>



						</ul>



					</div>



				</div>



			</nav>



 



				</div>



 



 



			<div class="crumb-wrap">



			<div class="w">



				<div class="crumb">



					<div class="crumb-item">



						<a href="/static/item/">手机</a>



					</div>



					<div class="crumb-item sep">></div>



					<div class="crumb-item">



						<a href="/static/item/">手机通讯</a>



					</div>



					<div class="crumb-item sep">></div>



					<div class="crumb-item">



						<a href="/static/item/">手机</a>



					</div>



					<div class="crumb-item sep">></div>



					<div class="crumb-item">



						<div class="crumb-item-one">



							华为 (HUAWEI)



							<img src="/static/item/img/4a79b87a68623d4e8a73aff3e25fa99b.png" alt="" class="img" />



							<div class="crumb-item-two ">



								<div class="crumb-item-con clear">



									<ul class="con-ul">



										<li>



											<img src="/static/item/img/5825a5a6Nde8ecb75.jpg" alt="" />



										</li>



										<li>



											<p>



												荣耀8青春版 全网通标配 3GB+32GB 幻海蓝



											</p>



											<p>



												￥1099.00



											</p>



										</li>



									</ul>



									<ul class="con-ul">



										<li>



											<img src="/static/item/img/5919637aN271a1301.jpg" alt="" />



										</li>



										<li>



											<p>



												荣耀8青春版 全网通标配 3GB+32GB 幻海蓝



											</p>



											<p>



												￥1099.00



											</p>



										</li>



									</ul>



									<ul class="con-ul">



										<li>



											<img src="/static/item/img/599a806bN9d829c1c.jpg" alt="" />



										</li>



										<li>



											<p>



												荣耀8青春版 全网通标配 3GB+32GB 幻海蓝



											</p>



											<p>



												￥1099.00



											</p>



										</li>



									</ul>



								</div>



								<div class="crumb-item-cons clear">



									<ul>



										<li>华为(huawei)</li>



										<li>小米(xiaomi)</li>



										<li>APPle</li>



										<li>魅族(meizu)</li>



										<li>锤子</li>



 



									</ul>



									<ul>



										<li>三星</li>



										<li>vivo</li>



										<li>飞利浦</li>



										<li>360</li>



										<li>更多>></li>



 



									</ul>



								</div>



							</div>



 



						</div>



 



					</div>



					<div class="crumb-item sep">></div>



					<div class="crumb-item">



						华为Mate 10



					</div>



				</div>



 



				<div class="contact">



					<ul class="contact-ul">



						<li>



							<a href="/static/item/#">



								华为京东自营官方旗舰店



							</a>



 



							<span class="contact-sp">



								<span class="contact-sp1">



								JD



							</span>



							<span class="contact-sp2">



								自营



							    </span>



							</span>



						</li>



						<li>



							<a href="/static/item/#">



								<img src="/static/item/img/f5831b9848b32440b381bcd30a3d96c7.png" alt="" /> 联系供应商



							</a>



						</li>



						<li>



							<a href="/static/item/#">



								<img src="/static/item/img/81a6326edc82d343a5a8860a6970f93b.png" alt="" /> JIMI



							</a>



						</li>



						<li>



							<a href="/static/item/#">



								<img src="/static/item/img/a400e3d61d5645459f769b00d9f431e7.png" alt="" /> 关注店铺



							</a>



						</li>



					</ul>



					<div class="contact-one">



						<ul>



							<li>客服</li>



							<li><img src="/static/item/img/f5831b9848b32440b381bcd30a3d96c7.png" alt="" />留言</li>



							<li><img src="/static/item/img/81a6326edc82d343a5a8860a6970f93b.png" alt="" />JIMI智能</li>



							<li>



								<img src="/static/item/img/1466134037230.jpg" class="contact-img" />



								<p>手机下单</p>



							</li>



 



						</ul>



						<div class="contact-two">



							<span><img src="/static/item/img/a400e3d61d5645459f769b00d9f431e7.png" alt="" />进店逛逛</span>



							<span><img src="/static/item/img/a400e3d61d5645459f769b00d9f431e7.png" alt="" />关注店铺</span>



						</div>



					</div>



				</div>



 



			</div>



		</div>



<div class="Shop">



		<div class="box">



			<div class="box-one ">



				<div class="boxx">



 



					<div class="imgbox">



						<div class="probox">



							<img class="img1" alt="" th:src="${item.info.skuDefaultImg}">



							<div class="hoverbox"></div>



						</div>



						<div class="showbox">



							<img class="img1" alt="" th:src="${item.info.skuDefaultImg}">



						</div>



					</div>



 



					<div class="box-lh">



 



						<div class="box-lh-one">



							<ul>



								<li th:each="img:${item.images}" ><img th:src="${img.imgUrl}" /></li>



							</ul>



						</div>



						<div id="left">



							< </div>



								<div id="right">



									>



								</div>



 



						</div>



 



						<div class="boxx-one">



							<ul>



								<li>



									<span>



										<img src="/static/item/img/b769782fe4ecca40913ad375a71cb92d.png" alt="" />关注



									</span>



									<span>



										<img src="/static/item/img/9224fcea62bfff479a6712ba3a6b47cc.png" alt="" />



										对比



									</span>



								</li>



								<li>



 



								</li>



							</ul>



						</div>



 



					</div>



					<div class="box-two">



						<div class="box-name" th:text="${item.info.skuTitle}">



							华为 HUAWEI Mate 10 6GB+128GB 亮黑色 移动联通电信4G手机 双卡双待



						</div>



						<div class="box-hide" th:text="${item.info.skuSubtitle}">预订用户预计11月30日左右陆续发货！麒麟970芯片！AI智能拍照！



							<a href="/static/item/"><u></u></a>



						</div>



						<div class="box-yuyue">



							<div class="yuyue-one">



								<img src="/static/item/img/7270ffc3baecdd448958f9f5e69cf60f.png" alt="" /> 预约抢购



							</div>



							<div class="yuyue-two">



								<ul>



									<li>



										<img src="/static/item/img/f64963b63d6e5849977ddd6afddc1db5.png" />



										<span>190103</span> 人预约



									</li>



									<li>



										<img src="/static/item/img/36860afb69afa241beeb33ae86678093.png" /> 预约剩余



										<span id="timer">



 



									</span>



									</li>



								</ul>



							</div>



						</div>



						<div class="box-summary clear">



							<ul>



								<li>京东价</li>



								<li>



									<span>￥</span>



									<span th:text="${#numbers.formatDecimal(item.info.price,3,2)} ">4499.00</span>



								</li>



								<li>



									预约享资格



								</li>



								<li>



									<a href="/static/item/">



										预约说明



									</a>



								</li>



							</ul>



						</div>



						<div class="box-wrap clear">



							<div class="box-wrap-one clear">



								<ul>



									<li>增值业务</li>



									<li><img src="/static/item/img/90a6fa41d0d46b4fb0ff6907ca17c478.png" /></li>



									<li><img src="/static/item/img/2e19336b961586468ef36dc9f7199d4f.png" /></li>



									<li><img src="/static/item/img/1f80c3d6fabfd3418e54b005312c00b5.png" /></li>



								</ul>



							</div>



						</div>



 



						<div class="box-stock">



							<ul class="box-ul">



								<li>配送至</li>



								<li class="box-stock-li">



									<div class="box-stock-one">



										北京朝阳区管庄



										<img src="/static/item/img/4a79b87a68623d4e8a73aff3e25fa99b.png" alt="" class="img" />



									</div>



									<div class="box-stock-two">



										<dl>



											<dt>



												<a>选择新地址</a>



												<img src="/static/item/img/4a79b87a68623d4e8a73aff3e25fa99b.png" alt="" class="box-stock-two-img"/>



											</dt>



											<dd>



												<div class="box-stock-dd">



													<div class="box-stock-top">



														<div class="box-stock-div">北京</div>



														<div class="box-stock-div">朝阳区</div>



														<div class="box-stock-div">管庄</div>



													</div>



													<div class="box-stock-fot">



														<div class="box-stock-con" style="display: block;">



															<ul>



																<li>北京</li>



																<li>上海</li>



																<li>天津</li>



																<li>重庆</li>



															</ul>



														</div>



														<div class="box-stock-con">



															<ul>



																<li>朝阳区</li>



																<li>海淀区</li>



																<li>东城区</li>



																<li>西城区</li>



															</ul>



														</div>



														<div class="box-stock-con">



															<ul>



																<li>4环到5环之内</li>



																<li>管庄</li>



																<li>北苑</li>



															</ul>



														</div>



 



													</div>



												</div>



											</dd>



										</dl>



 



									</div>



 



								</li>



								<li>



									<span th:text="${item.hasStock?'有货':'无货'}">无货</span>， 此商品暂时售完



								</li>



							</ul>



						</div>



						<div class="box-supply">



							<ul class="box-ul">



								<li></li>



								<li>



									由<span>京东</span> 发货，并提供售后服务



								</li>



							</ul>



						</div>



						<div class="box-attr-3">



							<div class="box-attr clear" th:each="attr:${item.saleAttr}">



								<dl>



									<dt>选择[[${attr.attrName}]]</dt>



									<dd th:each="vals:${attr.attrValues}">



										<a



										   th:attr="skus=${vals.skuIds},class=${#lists.contains(#strings.listSplit(vals.skuIds,','),item.info.skuId.toString())?'sku_attr_value checked':'sku_attr_value'}">



											[[${vals.attrValue}]]



											<!-- <img src="/static/item/img/59ddfcb1Nc3edb8f1.jpg" /> -->



										</a>



									</dd>



								</dl>



							</div>



						</div>



 



						<div class="box-btns clear">



							<div class="box-btns-one">



								<input type="text" name="" id="" value="1" />



								<div class="box-btns-one1">



 



									<div>



										<button id="jia">



									+



									</button>



									</div>



									<div>



										<button id="jian">



										-



									</button>



									</div>



 



								</div>



							</div>



							<div class="box-btns-two">



								<a href="/static/item/../商品分类\index.html">



									立即预约



								</a>



							</div>



							<div class="box-btns-three">



								<img src="/static/item/img/e4ed3606843f664591ff1f68f7fda12d.png" alt="" /> 分享



							</div>



						</div>



 



						<div class="box-footer-zo">



							<div class="box-footer clear">



								<dl>



									<dt>本地活动</dt>



									<dd>



										<a href="/static/item/">



											·1元500MB激活到账30元 >>



										</a>



									</dd>



								</dl>



							</div>



 



							<div class="box-footer">



								<dl>



									<dt>温馨提示</dt>



									<dd>·本商品不能使用 东券 京券</dd>



									<dd>·请完成预约后及时抢购！</dd>



								</dl>



							</div>



						</div>



					</div>



 



				</div>



			</div>



			<!--欲约抢购流程-->



			<div class="qianggoulioucheng">



				<div class="lioucheng">



					<h3>欲约抢购流程</h3>



				</div>



				<!--抢购步骤-->



				<ul class="qianggoubuzhao">



					<li>



						<img src="/static/item/img/shop_03.png" />



						<dl class="buzhou">



							<dt>1.等待预约</dt>



							<dl>预约即将开始</dl>



						</dl>



					</li>



					<li>



						<img src="/static/item/img/shop_04.png" />



						<dl class="buzhou">



							<dt>2.预约中</dt>



							<dl>2017-11-15 10:35 2017-11-15 23:59</dl>



						</dl>



					</li>



					<li>



						<img src="/static/item/img/shop_05.png" />



						<dl class="buzhou">



							<dt>3.等待抢购</dt>



							<dl>抢购即将开始</dl>



						</dl>



					</li>



					<li>



						<img src="/static/item/img/shop_06.png" />



						<dl class="buzhou">



							<dt>4.抢购中</dt>



							<dl></dl>



						</dl>



					</li>



				</ul>



			</div>



 



			<div class="ShopXiangqing">



				<div class="allLeft">



					<!--火热预约-->



					<div class="huoreyuyue">



						<h3>火热预约</h3>



					</div>



					<div class="dangeshopxingqing">



						<ul class="shopdange">



							<li>



								<a href="/static/item/##"><img src="/static/item/img/5a0afeddNb34732af.jpg" /></a>



								<p>



									<a href="/static/item/##">OPPO R11s Plus 双卡双待全面屏拍照手机香槟色 全网通(6G RAM+64G ROM)标配</a>



								</p>



								<p><strong class="J-p-20015341974">￥3699.00</strong></p>



							</li>



							<li>



								<a href="/static/item/##"><img src="/static/item/img/5a12873eN41754123.jpg" /></a>



								<p>



									<a target="_blank" title="詹姆士（GEMRY） R19plus全网通4G 智能手机 双卡双待 6+128GB 鳄鱼纹雅致版（新品预约）" href="/static/item///item.jd.com/20348283521.html">詹姆士（GEMRY） R19plus全网通4G 智能手机 双卡双待 6+128GB 鳄鱼纹雅致版（新品预约）</a>



								</p>



								<p><strong class="J-p-20348283521">￥13999.00</strong></p>



							</li>



							<li>



								<a href="/static/item/##"><img src="/static/item/img/59ec0131Nf239df75.jpg" /></a>



								<p>



									<a target="_blank" title="斐纳（TOMEFON） 德国家用无线无绳手持立式充电吸尘器 静音大吸力吸尘器TF-X60" href="/static/item///item.jd.com/16683419775.html">斐纳（TOMEFON） 德国家用无线无绳手持立式充电吸尘器 静音大吸力吸尘器TF-X60</a>



								</p>



								<p><strong class="J-p-16683419775">￥1599.00</strong></p>



							</li>



							<li>



								<a href="/static/item/##"><img src="/static/item/img/59015444N27317512.jpg" /></a>



								<p>



									<a target="_blank" title="斐纳（TOMEFON） 扫地机器人德国智能导航规划全自动超薄扫地机器人吸尘器TF-D60 香槟金" href="/static/item///item.jd.com/12187770381.html">斐纳（TOMEFON） 扫地机器人德国智能导航规划全自动超薄扫地机器人吸尘器TF-D60 香槟金</a>



								</p>



								<p><strong class="J-p-12187770381">￥2599.00</strong></p>



							</li>



						</ul>



					</div>



					<!--看了又看-->



					<div class="huoreyuyue">



						<h3>看了又看</h3>



					</div>



					<div class="dangeshopxingqing">



						<ul class="shopdange">



							<li>



								<a href="/static/item/##"><img src="/static/item/img/59e55e01N369f98f2.jpg" /></a>



								<p>



									<a target="_blank" title="华为（HUAWEI） 华为 Mate10 4G手机  双卡双待 亮黑色 全网通(6GB RAM+128GB ROM)" href="/static/item///item.jd.com/17931625443.html">华为（HUAWEI） 华为 Mate10 4G手机 双卡双待 亮黑色 全网通(6GB RAM+128GB ROM)</a>



									<p><strong class="J-p-17931625443">￥4766.00</strong></p>



							</li>



							<li>



								<a href="/static/item/##"><img src="/static/item/img/584fcc3eNdb0ab94c.jpg" /></a>



								<p>



									<a target="_blank" title="华为 Mate 9 Pro 6GB+128GB版 琥珀金 移动联通电信4G手机 双卡双待" href="/static/item///item.jd.com/3749093.html">华为 Mate 9 Pro 6GB+128GB版 琥珀金 移动联通电信4G手机 双卡双待</a>



								</p>



								<p><strong class="J-p-3749093">￥4899.00</strong></p>



							</li>



							<li>



								<!--shopjieshao-->



								<a href="/static/item/##"><img src="/static/item/img/59eb0df9Nd66d7585.jpg" /></a>



								<p>



									<a target="_blank" title="华为（HUAWEI） 华为 Mate10 手机 亮黑色 全网通(4+64G)标准版" href="/static/item///item.jd.com/12306211773.html">华为（HUAWEI） 华为 Mate10 手机 亮黑色 全网通(4+64G)标准版</a>



								</p>



								<p><strong class="J-p-12306211773">￥4088.00</strong></p>



							</li>



							<li>



								<a href="/static/item/##"><img src="/static/item/img/5a002ba3N126c2f73.jpg" /></a>



								<p>



									<a target="_blank" title="斐纳（TOMEFON） 扫地机器人德国智能导航规划全自动超薄扫地机器人吸尘器TF-D60 香槟金" href="/static/item///item.jd.com/12187770381.html">斐纳（TOMEFON） 扫地机器人德国智能导航规划全自动超薄扫地机器人吸尘器TF-D60 香槟金</a>



								</p>



								<p><strong class="J-p-12187770381">￥2599.00</strong></p>



							</li>



						</ul>



						<img src="/static/item/img/5a084a1aNa1aa0a71.jpg" />



					</div>



				</div>



				<!--商品介绍-->



				<div class="allquanbushop">



					<ul class="shopjieshao">



						<li class="jieshoa" style="background: #e4393c;">



							<a href="/static/item/##" style="color: white;">商品介绍</a>



						</li>



						<li class="baozhuang">



							<a href="/static/item/##">规格与包装</a>



						</li>



						<li class="baozhang">



							<a href="/static/item/##">售后保障</a>



						</li>



						<li class="pingjia">



							<a href="/static/item/##">商品评价(4万+)</a>



						</li>



						<li class="shuoming">



							<a href="/static/item/##">预约说明</a>



						</li>



 



					</ul>



					<button class="Lijiyuyuessss">



							立即预约



						</button>



					<ul class="shopjieshaos posi" style="display: none;">



						<li class="jieshoa" style="background: #e4393c;">



							<a  style="color: white;">商品介绍</a>



						</li>



						<li class="baozhuang">



							<a >规格与包装</a>



						</li>



						<li class="baozhang">



							<a href="/static/item/#li3">售后保障</a>



						</li>



						<li class="pingjia">



							<a href="/static/item/#li4">商品评价(4万+)</a>



						</li>



						<li class="shuoming">



							<a href="/static/item/#li5">预约说明</a>



						</li>



					</ul>



 



					<!--商品详情-->



					<div class="huawei">



						<ul class="xuanxiangka">



							<li class="jieshoa actives" id="li1">



								<div class="shanpinsssss">



<!--									<p>-->



<!--										<a href="/static/item/#">品牌:华为（HUAWEI）</a>-->



<!--									</p>-->



<!--									<table>-->



<!--										<tr>-->



<!--											<td>-->



<!--												<a href="/static/item/##">商品名称：华为Mate 10</a>-->



<!--											</td>-->



<!--											<td>-->



<!--												<a href="/static/item/##">商品毛重：0.58kg</a>-->



<!--											</td>-->



<!--											<td>-->



<!--												<a href="/static/item/##">商品编号：5544038</a>-->



<!--											</td>-->



<!--											<td>-->



<!--												<a href="/static/item/##">商品产地：中国大陆</a>-->



<!--											</td>-->



<!--										</tr>-->



<!--										<tr>-->



<!--											<td>-->



<!--												<a href="/static/item/##">系统：安卓（Android）</a>-->



<!--											</td>-->



<!--											<td>-->



<!--												<a href="/static/item/##">前置摄像头像素：800万-1599万</a>-->



<!--											</td>-->



<!--											<td>-->



<!--												<a href="/static/item/##">后置摄像头像素：2000万及以上，1200万-1999万</a>-->



<!--											</td>-->



<!--											<td>-->



<!--												<a href="/static/item/##">机身内存：128GB</a>-->



<!--											</td>-->



<!--										</tr>-->



<!--										<tr>-->



<!--											<td colspan="4">-->



<!--												<a href="/static/item/##">全面屏，双卡双待，指纹识别，Type-C，VoLTE，2K屏，拍照神器，支持NFC，商务手机，安全手机，分辨率10</a>-->



<!--											</td>-->



<!--										</tr>-->



<!--									</table>-->



									<img class="xiaoguo" th:src="${descp}" th:each="descp:${#strings.listSplit(item.desp.decript,',')}"/>



									<div class="guiGebox guiGebox1">



										<div class="guiGe" th:each="guige:${item.groupAttrs}">



											<h3 th:text="${guige.groupName}">主体</h3>



											<dl>



												<dt>品牌</dt>



												<dd>华为(HUAWEI)</dd>



												<dt>型号</dt>



												<dd class="Ptable-tips">



													<a href="/static/item/#"><i>？</i></a>



												</dd>



												<dd>ALP-AL00</dd>



												<dt>入网型号</dt>



												<dd class="Ptable-tips">



													<a href="/static/item/#"><i>？</i></a>



												</dd>



												<dd>ALP-AL00</dd>



												<dt>上市年份</dt>



												<dd>2017年</dd>



												<dt>上市时间</dt>



												<dd>10月</dd>



											</dl>



										</div>



										<div class="package-list">



											<h3>包装清单</h3>



											<p>手机（含内置电池） X 1、5A大电流华为SuperCharge充电器X 1、5A USB数据线 X 1、半入耳式线控耳机 X 1、快速指南X 1、三包凭证 X 1、取卡针 X 1、保护壳 X 1</p>



										</div>



									</div>



								</div>



							</li>



							<li class="baozhuang actives" id="li2">



								<div class="guiGebox">



									<div class="guiGe" th:each="group:${item.groupAttrs}">



										<h3 th:text="${group.groupName}">主体</h3>



										<dl>



											<div th:each="attr:${group.attrValues}">



											<dt th:text="${attr.attrName}">品牌</dt>



											<dd th:text="${attr.attrValue}">华为(HUAWEI)</dd>



											</div>



										</dl>



									</div>



									<div class="package-list">



										<h3>包装清单</h3>



										<p>手机（含内置电池） X 1、5A大电流华为SuperCharge充电器X 1、5A USB数据线 X 1、半入耳式线控耳机 X 1、快速指南X 1、三包凭证 X 1、取卡针 X 1、保护壳 X 1</p>



									</div>



								</div>



							</li>



							<!--包装-->



							<li class="baozhang actives" id="li3">



								<div class="oBox">



		<div class="shuoHou">



			<div class="baoZhang">



				<h2>售后保障</h2>



			</div>



		</div>



		<!--厂家服务-->



		<div class="changJia">



			<div class="lianBao">



				<span class="oImg">



					<img src="/static/item/img/2017.jpg" alt="" />



					<h3>厂家服务</h3>



				</span>



				<div class="wenZi">



					本产品全国联保，享受三包服务，质保期为：一年保<br />



					如因质量问题或故障，凭厂商维修中心或特约维修点的质量检测证明，享受7日内退货，15日内换货，15日以上在保质期内享受免费保修等安保服务！<br />



					(注：如厂家在商品介绍中有售后保障的说明，则此商品按照厂家说明执行售后保障服务。)您可以查询本品牌在各地售后服务中心的练习方式<a href="/static/item/#">请点击这儿查询...</a><br /><br />



				</div>



			</div>



			<div class="lianBao oCn">



				<span class="oImg">



					<img src="/static/item/img/2017.jpg" alt="" />



					<h3>京东承诺</h3>



				</span>



				<div class="wenZi">



					本产品全国联保，享受三包服务，质保期为：一年保<br />



					如因质量问题或故障，凭厂商维修中心或特约维修点的质量检测证明，享受7日内退货，15日内换货，15日以上在保质期内享受免费保修等安保服务！<br />



					(注：如厂家在商品介绍中有售后保障的说明，则此商品按照厂家说明执行售后保障服务。)您可以查询本品牌在各地售后服务中心的练习方式<a href="/static/item/#">请点击这儿查询...</a><br /><br /><br />



				</div>



			</div>



 



			<div class="lianBao ">



				<span class="oImg">



					<img src="/static/item/img/2017.jpg" alt="" />



					<h3>正品行货</h3>



				</span>



				<div class="wenZi hangHuo">



					京东商城向您保证所售商品均为正品行货，京东自营商品开具机打发票或电子发票。



				</div>



			</div>



			<div class="lianBao quanGuo">



				<span class="oImg">



					<img src="/static/item/img/2017-1.jpg" alt="" />



					<h3>全国联保</h3>



				</span>



				<div class="wenZi">



					凭质保证书及京东商城发票，可享受全国联保服务（奢侈品、钟表除外；奢侈品、钟表由京东联系保修，享受法定三包售后服务），与您亲临商场选购的商品享受相同的质量保证。京东商城还为您提供具有竞争力的商品价格和运费政策，请您放心购买！ <br />



 



注：因厂家会在没有任何提前通知的情况下更改产品包装、产地或者一些附件，本司不能确保客户收到的货物与商城图片、产地、附件说明完全一致。只能确保为原厂正货！并且保证与当时市场上同样主流新品一致。若本商城没有及时更新，请大家谅解！



				</div>



			</div>



				<!--权利声明-->



			<div class="quanLi">



				<h4>权利声明:</h4>



				<div class="jingDong">



					京东上的所有商品信息、客户评价、商品咨询、网友讨论等内容，是京东重要的经营资源，未经许可，禁止非法转载使用。<br />



	<span class="oZhu">注</span>：本站商品信息均来自于合作方，其真实性、准确性和合法性由信息拥有者（合作方）负责。本站不提供任何保证，并不承担任何法律责任。



				</div>



			</div>



			<div class="quanLi jiaGe">



				<h4>价格说明:</h4>



				<div class="jingDong">



					<span class="oZhu">京东价</span>：京东价为商品的销售价，是您最终决定是否购买商品的依据。<br />



					<span class="oZhu">划线价</span>：商品展示的划横线价格为参考价，该价格可能是品牌专柜标价、商品吊牌价或由品牌供应商提供的正品零售价（如厂商指导价、建议零售价等）或该商品在京东平台上曾经展示过的销售价；由于地区、时间的差异性和市场行情波动，品牌专柜标价、商品吊牌价等可能会与您购物时展示的不一致，该价格仅供您参考。<br />



					<span class="oZhu">折扣</span>：如无特殊说明，折扣指销售商在原价、或划线价（如品牌专柜标价、商品吊牌价、厂商指导价、厂商建议零售价）等某一价格基础上计算出的优惠比例或优惠金额；如有疑问，您可在购买前联系销售商进行咨询。<br />



					<span class="oZhu">异常问题</span>：商品促销信息以商品详情页“促销”栏中的信息为准；商品的具体售价以订单结算页价格为准；如您发现活动商品售价或促销信息有异常，建议购买前先联系销售商咨询。



				</div>



			</div>



		</div>



 



 



	</div>



							</li>



							<!--评价-->



							<li class="PINgjia actives" id="li4">



								<div class="h3">



									<h3>商品评价</h3>



								</div>



								<div class="nav">



									<div class="left">



										<p class="haoping">好评度</p>



										<p><span>100%</span></p>



									</div>



									<div class="right">



										<ul>



											<li>



												<a href="/static/item/##">就是快（424）</a>



											</li>



											<li>



												<a href="/static/item/##">物流很快（254） </a>



											</li>



											<li>



												<a href="/static/item/##">货真价实（168）</a>



											</li>



											<li>



												<a href="/static/item/##">有档次（158）</a>



											</li>



											<li>



												<a href="/static/item/##">国产品牌（133）</a>



											</li>



											<li>



												<a href="/static/item/##">外形美观（103）</a>



											</li>



											<li>



												<a href="/static/item/##">很给力（75）</a>



											</li>



											<li>



												<a href="/static/item/##">反应灵敏（68）</a>



											</li>



											<li>



												<a href="/static/item/##">性价比高（60）</a>



											</li>



											<li>



												<a href="/static/item/##">价格优惠（50）</a>



											</li>



											<li>



												<a href="/static/item/##">功能齐全（49）</a>



											</li>



											<li style="background: gainsboro;">



												<a href="/static/item/##">速度太慢（5）</a>



										</ul>



									</div>



								</div>



								<!--全部评价-->



								<div class="allpingjia">



									<ul>



										<li><a href="/static/item/##">全部评价（4.2万）</a></li>



										<li><a href="/static/item/##">晒图（500）</a></li>



										<li><a href="/static/item/##">追拼（200+）</a></li>



										<li><a href="/static/item/##">好评（4.1万）</a></li>



										<li><a href="/static/item/##">中评（100+）</a></li>



										<li><a href="/static/item/##">差评（100+）</a></li>



										<li><a href="/static/item/##"><input type="checkbox"/>只看当前商品价格</a></li>



										<li class="imga" style="float: right;"><a href="/static/item/##">推荐排序 <img src="/static/item/img/animaite.png"/> </a>



										</li>



									</ul>



								</div>



								</li>



								<li class="shuoming actives" id="li5"></li>



						</ul>



					</div>



				</div>



			</div>



		</div>



		<div class="headera">



			<div class="Logo-tu">



				<span><img src="/static/item/img/service_items_1.png"/></span>



				<span><img src="/static/item/img/service_items_2.png"/></span>



				<span><img src="/static/item/img/service_items_3.png"/></span>



				<span><img src="/static/item/img/service_items_4.png"/></span>



			</div>



			<div class="table">



				<dl>



					<dt><a href="/static/item/##">购物指南</a></dt>



					<dd>



						<a href="/static/item/##">购物流程</a>



					</dd>



					<dd>



						<a href="/static/item/##">会员介绍</a>



					</dd>



					<dd>



						<a href="/static/item/##">生活旅行/团购</a>



					</dd>



					<dd>



						<a href="/static/item/##">常见问题</a>



					</dd>



					<dd>



						<a href="/static/item/##">大家电</a>



					</dd>



					<dd>



						<a href="/static/item/##">练习客服</a>



					</dd>



				</dl>



				<dl>



					<dt><a href="/static/item/##">配送方式</a></dt>



					<dd>



						<a href="/static/item/##">上门自提</a>



					</dd>



					<dd>



						<a href="/static/item/##">211限时达</a>



					</dd>



					<dd>



						<a href="/static/item/##">配送服务查询</a>



					</dd>



					<dd>



						<a href="/static/item/##"></a>



					</dd>



					<dd>



						<a href="/static/item/##">海外配送</a>



					</dd>



					<dd></dd>



				</dl>



				<dl>



					<dt><a href="/static/item/##">支付方式</a></dt>



					<dd>



						<a href="/static/item/##">货到付款</a>



					</dd>



					<dd>



						<a href="/static/item/##">在线支付</a>



					</dd>



					<dd>



						<a href="/static/item/##">分期付款</a>



					</dd>



					<dd>



						<a href="/static/item/##">邮局汇款</a>



					</dd>



					<dd>



						<a href="/static/item/##">公司转账</a>



					</dd>



					<dd></dd>



				</dl>



				<dl>



					<dt><a href="/static/item/##">售后服务</a></dt>



					<dd>



						<a href="/static/item/##">售后政策</a>



					</dd>



					<dd>



						<a href="/static/item/##">价格保护</a>



					</dd>



					<dd>



						<a href="/static/item/##">退款说明</a>



					</dd>



					<dd>



						<a href="/static/item/##">返修/退换货</a>



					</dd>



					<dd>



						<a href="/static/item/##">取消订单</a>



					</dd>



					<dd></dd>



				</dl>



				<dl class="dls">



					<dt><a href="/static/item/##">特色服务</a></dt>



					<dd>



						<a href="/static/item/##">夺宝岛</a>



					</dd>



					<dd>



						<a href="/static/item/##">DIY装机</a>



					</dd>



					<dd>



						<a href="/static/item/##">延保服务</a>



					</dd>



					<dd>



						<a href="/static/item/##">京东E卡</a>



					</dd>



					<dd>



						<a href="/static/item/##">京东通信</a>



					</dd>



					<dd>



						<a href="/static/item/##">京东JD+</a>



					</dd>



				</dl>



			</div>



			<!--关于我们-->



			<div class="guanyuwomen">



				<ul>



					<li>



						<a href="/static/item/##">关于我们</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">联系我们</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">联系客服</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">合作招商</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">商家帮助</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">营销中心</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">手机京东</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">友情链接</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">销售联盟</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">京东社区</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">风险检测</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">隐私政策</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">京东公益</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">English Site</a>



					</li>



					<li>|</li>



					<li>



						<a href="/static/item/##">Mdeila $ IR</a>



					</li>



				</ul>



			</div>



			<!--jieshoa-->



			<p class="p1"><img src="/static/item/img/56a0a994Nf1b662dc.png" />



				<a href="/static/item/##"> 京公网安备 11000002000088号</a>|



				<a href="/static/item/##"> 京ICP证070359号</a>|



				<a href="/static/item/##"> 互联网药品信息服务资格证编号(京)-经营性-2014-0008 </a>|



				<a href="/static/item/##">新出发京零 字第大120007号</a>



			</p>



			<p class="p1">



				<a href="/static/item/##"> 互联网出版许可证编号新出网证(京)字150号</a>|



				<a href="/static/item/##"> 出版物经营许可证</a>|



				<a href="/static/item/##"> 网络文化经营许可证京网文 </a>|



				<a href="/static/item/##">[2014]2148-348号 </a>|



				<a href="/static/item/##"> 违法和不良信息举报电话 </a>|



				<a href="/static/item/##">：4006561155 </a>



			</p>



			<p class="p1">



				<a href="/static/item/##"> Copyright © 2004-2017 京东JD.com 版权所有</a>|



				<a href="/static/item/##"> 消费者维权热线：4006067733 经营证照</a>|



			</p>



			<p class="p1">



				<a href="/static/item/##"> 京东旗下网站：京东支付</a>|



				<a href="/static/item/##"> 京东云</a>



			</p>



			<p class="p3">



				<img src="/static/item/img/54b8871eNa9a7067e.png" />



				<img src="/static/item/img/54b8872dNe37a9860.png" />



				<img src="/static/item/img/54b8875fNad1e0c4c.png" />



				<img src="/static/item/img/5698dc03N23f2e3b8.jpg" />



				<img src="/static/item/img/5698dc16Nb2ab99df.jpg" />



				<img src="/static/item/img/56a89b8fNfbaade9a.jpg" />



			</p>



		</div>



		<div class="Fixedbian">



			<ul>



				<li class="li1"><a class="aaa" href="/static/item/##">顶部</a></li>



			</ul>



		</div>



		<div class="gouwuchexiaguo">



			<img src="/static/item/img/44.png" />



			<span>购物车还没有商品，赶紧选购吧！</span>



		</div>



	</body>



 



	<script src="/static/item/js/jquery1.9.js" type="text/javascript" charset="utf-8"></script>



	<script src="/static/item/js/js.js" type="text/javascript" charset="utf-8"></script>



<script>



	$(".sku_attr_value").click(function () {



 



		//1.点击的元素添加上自定义的属性，为了识别我们是刚才被点击的



		var skus = new Array();



		$(this).addClass("clicked");



		var curr = $(this).attr("skus").split(",");



		skus.push(curr);



		//去掉同一行的所有的checked



		$(this).parent().parent().find(".sku_attr_value").removeClass("checked");



 



		$("a[class='sku_attr_value checked']").each(function () {



             skus.push($(this).attr("skus").split(","));



		});



		console.log(skus)



 



		//2.取出他们的交集，得到skuId



		var filterEle = skus[0];



		console.log(filterEle);



		for(var i = 1;i<skus.length;i++){



			filterEle = $(filterEle).filter(skus[i]);



			//console.log(filterEle[0]);



		}



 



		console.log(filterEle[0]);



		location.href = "http://item.gulimall.com/"+ filterEle[0]+".html"



	});



	$(function () {



        $(".sku_attr_value").parent().css({"border":"solid 1px #CCC"});



        $("a[class='sku_attr_value checked']").parent().css({"border":"solid 1px red"});



	})



	</script>



 



</html>
```

## 谷粒商城认证服务(三十三)

### 211、商城业务-认证服务-环境搭建- 219、商城业务-认证服务-账号密码登录完成

感觉总体也比较简单，就是html太烦事了。

发送短信的代码

```java
public void sendSms(String phone,String code) {



        String method = "GET";



        Map<String, String> headers = new HashMap<String, String>();



        headers.put("Authorization", "APPCODE " + appcode);



        Map<String, String> querys = new HashMap<String, String>();



        querys.put("phone", phone);



        querys.put("sign", sign);



        querys.put("skin", skin);



        querys.put("param", code);



        try {



            HttpResponse response = HttpUtils.doGet(host, path, method, headers, querys);



            System.out.println(response);



        } catch (Exception e) {



            e.printStackTrace();



        }



 



    }
```

进行注册和登录的代码

```java
@PostMapping("/regist")



    public String regist(@Valid UserRegistVo vo, BindingResult result, RedirectAttributes redirectAttributes){



        if(result.hasErrors()){



            Map<String, String> errors = result.getFieldErrors().stream().collect(Collectors.toMap(FieldError::getField, FieldError::getDefaultMessage));



            redirectAttributes.addFlashAttribute("errors",errors);



            return "redirect:http://auth.gulimall.com/reg.html";



        }



 



        //1.校验验证码



       String code = vo.getCode();



        String s = redisTemplate.opsForValue().get(AuthServerConstant.SMS_CODE_CACHE_PREFIX + vo.getPhone());



        if(StringUtils.isNotBlank(s)){



            if(code.equals(s.split("_")[0])){



                redisTemplate.delete(AuthServerConstant.SMS_CODE_CACHE_PREFIX + vo.getPhone());



                R r = memberFeignService.regist(vo);



                if(r.getCode() == 0){



                    return "redirect:http://auth.gulimall.com/login.html";



                }else{



                    HashMap<String, String> errors = new HashMap<>();



                    errors.put("msg",r.getData("msg",new TypeReference<String>(){}));



                    System.out.println(errors);



                    redirectAttributes.addFlashAttribute("errors",errors);



                    return "redirect:http://auth.gulimall.com/reg.html";



                }



            }else{



                HashMap<String, String> errors = new HashMap<>();



                errors.put("code","验证码错误");



                redirectAttributes.addFlashAttribute("errors",errors);



                return "redirect:http://auth.gulimall.com/reg.html";



            }



        }else{



            HashMap<String, String> errors = new HashMap<>();



            errors.put("code","验证码错误");



            redirectAttributes.addFlashAttribute("errors",errors);



            return "redirect:http://auth.gulimall.com/reg.html";



        }



    }



 



    @PostMapping("/login")



    public String login(UserLoginVo vo,RedirectAttributes redirectAttributes){



        R login = memberFeignService.login(vo);



        if(login.getCode()==0){



            return "redirect:http://gulimall.com";



        }else{



            HashMap<String, String> errors = new HashMap<>();



            errors.put("msg",login.getData("msg",new TypeReference<String>(){}));



            redirectAttributes.addFlashAttribute("errors",errors);



            return "redirect:http://auth.gulimall.com/login.html";



        }



    }
```

注：在视频中，认证服务和会员服务进行远程调用的时候，vo类名字不一样，视频直接说可以，我处进行测试的时候，会报错，

所以改成了一样的。

```java
/**



 * @author WGR



 * @create 2020/7/15 -- 21:16



 */



@FeignClient("gulimall-member")



public interface MemberFeignService {



 



    @PostMapping("/member/member/regist")



     R regist(@RequestBody UserRegistVo vo);



 



    @PostMapping ("/member/member/login")



     R login(@RequestBody UserLoginVo vo);



}
```

还有就是gulimall-common中有一个自定义异常了，视频中校验手机号和密码的时候，又定义了2个，感觉有点累赘，我就直接用一个了

```java
@PostMapping ("/regist")



    public R regist(@RequestBody UserRegistVo vo){



        try{



            memberService.regist(vo);



        }catch (RRException e){



            System.out.println(e.getMsg());



            return R.error(e.getCode(),e.getMsg());



        }



        return R.ok();



    }



 



    @PostMapping ("/login")



    public R login(@RequestBody UserLoginVo vo){



            MemberEntity entity = memberService.login(vo);



            if(entity !=null){



                return R.ok();



            }else{



                return R.error(BizCodeEnume.LOGINACCT_PASSWORD_INVAILD_EXCEPTION.getCode(),BizCodeEnume.LOGINACCT_PASSWORD_INVAILD_EXCEPTION.getMessage());



            }



    }
```

具体实现：

```java
@Override



    public void regist(UserRegistVo vo) {



        MemberDao memberDao = this.baseMapper;



        MemberEntity memberEntity = new MemberEntity();



        MemberLevelEntity levelEntity = memberLevelDao.selectOne(new QueryWrapper<MemberLevelEntity>().eq("default_Status", "1"));



        memberEntity.setLevelId(levelEntity.getId());



        memberEntity.setUsername(vo.getUserName());



        memberEntity.setMobile(vo.getPhone());



 



        BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder();



        String encode = passwordEncoder.encode(vo.getPassword());



        memberEntity.setPassword(encode);



        Integer count = memberDao.selectCount(new QueryWrapper<MemberEntity>().eq("mobile", vo.getPhone()));



        if(count > 0){



            throw new RRException(BizCodeEnume.PHONE_EXIST_EXCEPTION.getMessage(),BizCodeEnume.PHONE_EXIST_EXCEPTION.getCode());



        }



        Integer count2 = memberDao.selectCount(new QueryWrapper<MemberEntity>().eq("username", vo.getPhone()));



        if(count2 > 0){



            throw new RRException(BizCodeEnume.USER_EXIST_EXCEPTION.getMessage(),BizCodeEnume.USER_EXIST_EXCEPTION.getCode());



        }



 



        memberDao.insert(memberEntity);



 



    }



 



    @Override



    public MemberEntity login(UserLoginVo vo) {



        String loginacct = vo.getLoginacct();



        String password = vo.getPassword();



 



        MemberDao memberDao = this.baseMapper;



        MemberEntity entity = memberDao.selectOne(new QueryWrapper<MemberEntity>().eq("username", loginacct)



                .or().eq("mobile", loginacct));



        if(entity == null){



            return null;



        }else{



            String passwordDb = entity.getPassword();



            BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder();



            boolean matches = passwordEncoder.matches(password, passwordDb);



            if(matches){



                return entity;



            }else{



                return null;



            }



        }



 



    }
```

## 谷粒商城认证服务(三十四)

### 220、商城业务-认证服务-OAuth2.0简介-224、商城业务-认证服务-社交登录测试成功

之前博客也写过Oauth2的，不过没有和新浪qq等做整合，具体的也可以看https://www.cnblogs.com/dalianpai/p/12423982.html.

首先要跟着视频开通我的应用,然后看对应的API，反正也比较简单。是Oauth2的授权码模式，很完善。

具体的流程图：

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDcvMTgyOTc4NS0yMDIwMDcxNjIzMzMxNTIxOC00OTg2MzI0NTIucG5n)

下面就是简单的代码整合：

```html
<ul>



                <li>



                    <a href="https://api.weibo.com/oauth2/authorize?client_id=31031789&response_type=code&redirect_uri=http://auth.gulimall.com/oauth2.0/weibo/success">



                        <img style="width: 50px;height: 18px" src="/static/login/JD_img/weibo.png"/>



                    </a>



                </li>



                <li class="f4"> |</li>



                <li>



                    <a href="/static/login/">



                        <img src="/static/login/JD_img/weixin.png"/>



                        <span>微信</span>



                    </a>



                </li>



            </ul>
```

具体的业务逻辑代码

```java
@GetMapping("/oauth2.0/weibo/success")



    public String weibo(@RequestParam("code") String code) throws Exception {



        System.out.println(code);



        Map<String, String> map = new HashMap<>();



        map.put("client_id","31031789");



        map.put("client_secret","38c9571dd37d99d7f3d6aab02a77d14d");



        map.put("grant_type","authorization_code");



        map.put("redirect_uri","http://auth.gulimall.com/oauth2.0/weibo/success");



        map.put("code",code);



        HttpResponse response = HttpUtils.doPost("https://api.weibo.com", "/oauth2/access_token", "post", new HashMap<>(), new HashMap<>(), map);



        System.out.println(response);



        //2.处理



        if(response.getStatusLine().getStatusCode()==200){



            String json = EntityUtils.toString(response.getEntity());



            SocialUser socialUser = JSON.parseObject(json, SocialUser.class);



 



            R oauthLogin = memberFeignService.oauthLogin(socialUser);



            if(oauthLogin.getCode() == 0){



                MemberRespVo data = oauthLogin.getData("data", new TypeReference<MemberRespVo>() {



                });



                System.out.println("登录成功"+data);



                return "redirect:http://gulimall.com";



            }else{



                return "redirect:http://auth.gulimall.com/login.html";



            }



        }else{



            return "redirect:http://auth.gulimall.com/login.html";



        }



 



    }
```

具体的实现：

```java
@Override



    public MemberEntity login(SocialUser socialUser) throws Exception {



        String uid = socialUser.getUid();



        MemberDao memberDao = this.baseMapper;



        MemberEntity memberEntity = memberDao.selectOne(new QueryWrapper<MemberEntity>().eq("social_uid", uid));



        if(memberEntity != null){



            MemberEntity update = new MemberEntity();



            update.setId(memberEntity.getId());



            update.setAccessToken(socialUser.getAccess_token());



            update.setExpiresIn(socialUser.getExpires_in());



            memberDao.updateById(update);



 



            memberEntity.setAccessToken(socialUser.getAccess_token());



            memberEntity.setExpiresIn(socialUser.getExpires_in());



            return memberEntity;



        }else{



            MemberEntity regist = new MemberEntity();



            try {



                Map<String, String> query = new HashMap<>();



                query.put("access_token",socialUser.getAccess_token());



                query.put("uid",uid);



                HttpResponse response = HttpUtils.doGet("https://api.weibo.com", "/2/users/show.json", "get", new HashMap<String, String>(), query);



                if(response.getStatusLine().getStatusCode() == 200) {



                    String json = EntityUtils.toString(response.getEntity());



                    JSONObject jsonObject = JSON.parseObject(json);



                    String name = jsonObject.getString("name");



                    String gender = jsonObject.getString("gender");



                    regist.setNickname(name);



                    regist.setGender("m".equals(gender) ? 1 : 0);



                }



            }catch (Exception e){



            }



                regist.setSocialUid(socialUser.getUid());



                regist.setAccessToken(socialUser.getAccess_token());



                regist.setExpiresIn(socialUser.getExpires_in());



                memberDao.insert(regist);



                return regist;



        }



    }
```

结果：

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDcvMTgyOTc4NS0yMDIwMDcxNzAwMDQyODQ5OC0yNDA2NTAzNTcucG5n)

## 谷粒商城SpringSession(三十五)

225-230

在官网上截了2个片段，具体如下：

> # 5. HttpSession Integration
>
> Spring Session 使用`HttpSession`提供透明的 integration。这意味着开发人员可以使用 Spring Session 支持的 implementation 切换`HttpSession` implementation。
>
> ## 5.1 为什么 Spring Session＆HttpSession？
>
> 我们已经提到 Spring Session 为`HttpSession`提供了透明的 integration，但是我们从中得到了什么好处呢？
>
> - **集群会话** - Spring Session 使得支持群集会话变得微不足道，而不依赖于 application 容器特定的解决方案。
> - **RESTful API** - Spring Session 允许在 headers 中提供 session ID 以使用RESTful API
>
> ## 5.2 与 Redis 的 HttpSession
>
> 通过在使用`HttpSession`的任何内容之前添加 Servlet 过滤器来启用 Spring Session 和`HttpSession`。您可以选择使用以下任一方式启用此功能
>
> - 基于 Java 的 Configuration
> - 基于 XML 的 Configuration
>
> ### 5.2.1 Redis 基于 Java 的 Configuration
>
> 本节介绍如何使用 Redis 使用基于 Java 的 configuration 来支持`HttpSession`。
>
> > HttpSession Sample提供了一个关于如何使用 Java configuration 集成 Spring Session 和`HttpSession`的工作 sample。您可以在下面阅读 integration 的基本步骤，但是在与您自己的 application 集成时，我们鼓励您遵循详细的 HttpSession 指南。
>
> #### Spring Java Configuration
>
> 添加所需的依赖项后，我们可以创建 Spring configuration。 Spring configuration 负责 creating Servlet 过滤器，该过滤器用 Spring Session 支持的 implementation 替换`HttpSession` implementation。添加以下 Spring Configuration：
>
> ```java
> @EnableRedisHttpSession 
> 
> 
> 
> public class Config {
> 
> 
> 
>  
> 
> 
> 
> 	@Bean
> 
> 
> 
> 	public LettuceConnectionFactory connectionFactory() {
> 
> 
> 
> 		return new LettuceConnectionFactory(); 
> 
> 
> 
> 	}
> 
> 
> 
> }
> ```
>
> > `@EnableRedisHttpSession` annotation 创建一个 Spring Bean，其 name 为`springSessionRepositoryFilter`，用于实现 Filter。过滤器负责替换 Spring Session 支持的`HttpSession` implementation。在这个例子中，Spring Session 由 Redis 支持。
>
> > 我们创建一个将 Spring Session 连接到 Redis 服务器的`RedisConnectionFactory`。我们将连接配置为在默认 port 上连接到 localhost(6379)有关配置 Spring Data Redis 的更多信息，请参阅reference 文档。
>
> #### Java Servlet 容器初始化
>
> 我们的Spring Configuration创建了一个名为`springSessionRepositoryFilter`的 Spring Bean，它实现了`Filter`。 `springSessionRepositoryFilter` bean 负责使用 Spring Session 支持的自定义 implementation 替换`HttpSession`。
>
> 在我们的`Filter`做魔法的 order 中，Spring 需要加载我们的`Config` class。最后我们需要确保我们的 Servlet 容器(i.e .Tomcat)对每个请求使用`springSessionRepositoryFilter`。幸运的是，Spring Session 提供了一个名为`AbstractHttpSessionApplicationInitializer`的实用程序 class，这两个步骤都非常简单。你可以在下面找到一个 example：
>
> **src/main/java/sample/Initializer.java.**
>
> ```java
> public class Initializer extends AbstractHttpSessionApplicationInitializer { 
> 
> 
> 
>  
> 
> 
> 
> 	public Initializer() {
> 
> 
> 
> 		super(Config.class); 
> 
> 
> 
> 	}
> 
> 
> 
> }
> ```
>
> > 我们的 class(初始化程序)的 name 无关紧要。重要的是我们扩展`AbstractHttpSessionApplicationInitializer`。
>
> > 第一个 step 是扩展`AbstractHttpSessionApplicationInitializer`。这确保 name `springSessionRepositoryFilter`的 Spring Bean 在每个请求中都注册了我们的 Servlet 容器。
>
> > `AbstractHttpSessionApplicationInitializer`还提供了一种机制，可以轻松确保 Spring 加载`Config`。

> ### 9.7.2 EnableRedisHttpSession
>
> 在 web 环境中，创建新`RedisOperationsSessionRepository`的最简单方法是使用`@EnableRedisHttpSession`。可以在第 3 章，Samples 和 Guides(从这里开始)中找到完整的 example 用法。您可以使用以下属性来自定义 configuration：
>
> - **maxInactiveIntervalInSeconds** - session 之前 time 的数量将以秒为单位
> - **redisNamespace** - 允许为会话配置特定于 application 的命名空间。 Redis 密钥和 channel ID 将以`<redisNamespace>:`的前缀开头。
> - **redisFlushMode** - 允许指定何时将数据写入 Redis。默认值仅在`SessionRepository`上调用`save`时。 `RedisFlushMode.IMMEDIATE`的值将尽快写入 Redis。
>
> #### 自定义 RedisSerializer
>
> 您可以通过创建实现`RedisSerializer<Object>`的名为`springSessionDefaultRedisSerializer`的 Bean 来自定义序列化。

视频中也是去官网中看的，可以学到很多东西

具体的代码如下：

```java
/**



 * @author WGR



 * @create 2020/7/21 -- 10:51



 */



@Configuration



public class GulimallSessionConfig {



    @Bean



    public CookieSerializer cookieSerializer(){



        DefaultCookieSerializer cookieSerializer = new DefaultCookieSerializer();



 



        cookieSerializer.setDomainName("gulimall.com");



        cookieSerializer.setCookieName("GULISESSION");



        return cookieSerializer;



    }



 



    @Bean



    public RedisSerializer<Object> springSessionDefaultRedisSerializer(){



        return new GenericFastJsonRedisSerializer();



    }



}
/**



 * 核心原理



 * 1）@EnableRedisHttpSession导入RedisHttpSessionConfiguration配置



 *    1 给容器中添加了一个组件



 *      SessonReppository >>> RedisOperationSessionRepository,redis操作session的增删改查



 *    2 SessionRepositoryFilter >> Filter: session存储过滤器，每个请求过来都必须经过filter



 *      1.创建的时候，就自动从容器中获取到了SessionRepository;



 *      2.原始的request，response都被包装了。SessionRepositoryRequestWrapper,SessionRepositoryWrapper;



 *      3.以后获取session。request.getSession();



 *      4.wrapperRequest.getSession();===>SessionRepository中获取到的。



 */



@EnableRedisHttpSession



@EnableFeignClients



@EnableDiscoveryClient



@SpringBootApplication



public class GulimallAuthServerApplication {



 



    public static void main(String[] args) {



        SpringApplication.run(GulimallAuthServerApplication.class, args);



    }



 



}
```

下面是课件的图片

![image-20200721153622881](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE1MzYyMjg4MS5wbmc)

![image-20200721153637513](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE1MzYzNzUxMy5wbmc)

![image-20200721153650189](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE1MzY1MDE4OS5wbmc)

![image-20200721153704548](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE1MzcwNDU0OC5wbmc)

![image-20200721153713890](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE1MzcxMzg5MC5wbmc)

![image-20200721153726586](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE1MzcyNjU4Ni5wbmc)

![image-20200721153750251](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE1Mzc1MDI1MS5wbmc)

![image-20200721153803893](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE1MzgwMzg5My5wbmc)

## 谷粒商城XXL-SSO(三十六)

### 231-232

### 一、简介

### 1.1 概述

XXL-SSO 是一个分布式单点登录框架。只需要登录一次就可以访问所有相互信任的应用系统。
拥有"轻量级、分布式、跨域、Cookie+Token均支持、Web+APP均支持"等特性。现已开放源代码，开箱即用。

### 1.2 特性

- 1、简洁：API直观简洁，可快速上手
- 2、轻量级：环境依赖小，部署与接入成本较低
- 3、单点登录：只需要登录一次就可以访问所有相互信任的应用系统
- 4、分布式：接入SSO认证中心的应用，支持分布式部署
- 5、HA：Server端与Client端，均支持集群部署，提高系统可用性
- 6、跨域：支持跨域应用接入SSO认证中心
- 7、Cookie+Token均支持：支持基于Cookie和基于Token两种接入方式，并均提供Sample项目
- 8、Web+APP均支持：支持Web和APP接入
- 9、实时性：系统登陆、注销状态，全部Server与Client端实时共享
- 10、CS结构：基于CS结构，包括Server"认证中心"与Client"受保护应用"
- 11、记住密码：未记住密码时，关闭浏览器则登录态失效；记住密码时，支持登录态自动延期，在自定义延期时间的基础上，原则上可以无限延期
- 12、路径排除：支持自定义多个排除路径，支持Ant表达式,用于排除SSO客户端不需要过滤的路径

### 1.3 下载

#### 文档地址

- [中文文档](http://www.xuxueli.com/xxl-sso/)

#### 源码仓库地址

| 源码仓库地址                          | Release Download                                           |
| :------------------------------------ | :--------------------------------------------------------- |
| https://github.com/xuxueli/xxl-sso    | [Download](https://github.com/xuxueli/xxl-sso/releases)    |
| https://gitee.com/xuxueli0323/xxl-sso | [Download](https://gitee.com/xuxueli0323/xxl-sso/releases) |

#### 技术交流

- [社区交流](http://www.xuxueli.com/page/community.html)

### 1.4 环境

- JDK：1.7+
- Redis：4.0+

### 二、快速入门（基于Cookie）

> 基于Cookie，相关概念可参考 "章节 4.6"

### 2.1：源码编译

```
- xxl-sso-server：中央认证服务，支持集群



- xxl-sso-core：Client端依赖



- xxl-sso-samples：单点登陆Client端接入示例项目



    - xxl-sso-web-sample-springboot：基于Cookie接入方式，供用户浏览器访问，springboot版本



    - xxl-sso-token-sample-springboot：基于Token接入方式，常用于无法使用Cookie的场景使用，如APP、Cookie被禁用等，springboot版本
```

### 2.2 部署 "认证中心（SSO Server）"

```
项目名：xxl-sso-server
```

#### 配置说明

配置文件位置：application.properties

```
……



 



// redis 地址： 如 "{ip}"、"{ip}:{port}"、"{redis/rediss}://xxl-sso:{password}@{ip}:{port:6379}/{db}"；多地址逗号分隔



xxl.sso.redis.address=redis://127.0.0.1:6379







// 登录态有效期窗口，默认24H，当登录态有效期窗口过半时，自动顺延一个周期



xxl.sso.redis.expire.minite=1440
```

### 2.3 部署 "单点登陆Client端接入示例项目"

```
项目名：xxl-sso-web-sample-springboot
```

#### maven依赖

```
<dependency>



    <groupId>com.xuxueli</groupId>



    <artifactId>xxl-sso-core</artifactId>



    <version>${最新稳定版}</version>



</dependency>
```

#### 配置 XxlSsoFilter

参考代码：com.xxl.sso.sample.config.XxlSsoConfig

```
@Bean



public FilterRegistrationBean xxlSsoFilterRegistration() {



 



    // xxl-sso, redis init



    JedisUtil.init(xxlSsoRedisAddress);



 



    // xxl-sso, filter init



    FilterRegistrationBean registration = new FilterRegistrationBean();



 



    registration.setName("XxlSsoWebFilter");



    registration.setOrder(1);



    registration.addUrlPatterns("/*");



    registration.setFilter(new XxlSsoWebFilter());



    registration.addInitParameter(Conf.SSO_SERVER, xxlSsoServer);



    registration.addInitParameter(Conf.SSO_LOGOUT_PATH, xxlSsoLogoutPath);



 



    return registration;



}
```

#### 配置说明

配置文件位置：application.properties

```
……







### xxl-sso     (CLient端SSO配置)







##### SSO Server认证中心地址（推荐以域名方式配置认证中心，本机可参考章节"2.5"修改host文件配置域名指向）



xxl.sso.server=http://xxlssoserver.com:8080/xxl-sso-server







##### 注销登陆path，值为Client端应用的相对路径



xxl.sso.logout.path=/logout







##### 路径排除Path，允许设置多个，且支持Ant表达式。用于排除SSO客户端不需要过滤的路径



xxl-sso.excluded.paths=







### redis   // redis address, like "{ip}"、"{ip}:{port}"、"{redis/rediss}://xxl-sso:{password}@{ip}:{port:6379}/{db}"；Multiple "," separated



xxl.sso.redis.address=redis://xxl-sso:password@127.0.0.1:6379/0
```

### 2.4 验证

- 修改Host文件：域名方式访问认证中心，模拟跨域与线上真实环境

```
### 在host文件中添加以下内容0



127.0.0.1 xxlssoserver.com



127.0.0.1 xxlssoclient1.com



127.0.0.1 xxlssoclient2.com
```

- 分别运行 "xxl-sso-server" 与 "xxl-sso-web-sample-springboot"

  1、SSO认证中心地址：
  http://xxlssoserver.com:8080/xxl-sso-server

  2、Client01应用地址：
  http://xxlssoclient1.com:8081/xxl-sso-web-sample-springboot/

  3、Client02应用地址：
  http://xxlssoclient2.com:8081/xxl-sso-web-sample-springboot/

- SSO登录/注销流程验证

  正常情况下，登录流程如下：
  1、访问 "Client01应用地址" ，将会自动 redirect 到 "SSO认证中心地址" 登录界面
  2、成功登录后，将会自动 redirect 返回到 "Client01应用地址"，并切换为已登录状态
  3、此时，访问 "Client02应用地址"，不需登陆将会自动切换为已登录状态

  正常情况下，注销流程如下：
  1、访问 "Client01应用地址" 配置的 "注销登陆path"，将会自动 redirect 到 "SSO认证中心地址" 并自动注销登陆状态
  2、此时，访问 "Client02应用地址"，也将会自动注销登陆状态

### 三、快速入门（基于Token）

> 基于Token，相关概念可参考 "章节 4.7"；（在一些无法使用Cookie的场景下，可使用该方式，否则可以忽略本章节）

### 3.1 "认证中心（SSO Server）" 搭建

> 可参考 "章节二" 搭建

"认证中心" 搭建成功后，默认为Token方式登陆提供API接口如下：

- 1、登陆接口：/app/login
  - 参数：POST参数
    - username：账号
    - password：账号
  - 响应：JSON格式
    - code：200 表示成功、其他失败
    - msg：错误提示
    - data: 登陆用户的 sso sessionid
- 2、注销接口：/app/logout
  - 参数：POST参数
    - sessionId：登陆用户的 sso sessionid
  - 响应：JSON格式
    - code：200 表示成功、其他失败
    - msg：错误提示
- 3、登陆状态校验接口：/app/logincheck
  - 参数：POST参数
    - sessionId：登陆用户的 sso sessionid
  - 响应：JSON格式
    - code：200 表示成功、其他失败
    - msg：错误提示
    - data：登陆用户信息
      - userid：用户ID
      - username：用户名

### 3.2 部署 "单点登陆Client端接入示例项目" (Token方式)

```
项目名：xxl-sso-token-sample-springboot
```

> 可参考 "章节 2.4" 部署 "单点登陆Client端接入示例项目"，唯一不同点是：将web应用的 "XxlSsoFilter" 更换为app应用 "XxlSsoTokenFilter"

### 3.3 验证 (模拟请求 Token 方式接入SSO的接口)

- 修改Host文件：域名方式访问认证中心，模拟跨域与线上真实环境

```
### 在host文件中添加以下内容0



127.0.0.1 xxlssoserver.com



127.0.0.1 xxlssoclient1.com



127.0.0.1 xxlssoclient2.com
```

- 分别运行 "xxl-sso-server" 与 "xxl-sso-token-sample-springboot"

  1、SSO认证中心地址：
  http://xxlssoserver.com:8080/xxl-sso-server

  2、Client01应用地址：
  http://xxlssoclient1.com:8082/xxl-sso-token-sample-springboot/

  3、Client02应用地址：
  http://xxlssoclient2.com:8082/xxl-sso-token-sample-springboot/

- SSO登录/注销流程验证

> 可参考测试用例 ：com.xxl.app.sample.test.TokenClientTest

```
正常情况下，登录流程如下：



1、获取用户输入的账号密码后，请求SSO Server的登录接口，获取用户 sso sessionid ；（参考代码：TokenClientTest.loginTest）



2、登陆成功后，获取到 sso sessionid ，需要主动存储，后续请求时需要设置在 Header参数 中



3、此时，使用 sso sessionid 访问受保护的 "Client01应用" 和 "Client02应用" 提供的接口，接口均正常返回（参考代码：TokenClientTest.clientApiRequestTest）



 



正常情况下，注销流程如下：



1、请求SSO Server的注销接口，注销登陆凭证 sso sessionid ；（参考代码：TokenClientTest.logoutTest）



2、注销成功后，sso sessionid 将会全局失效



3、此时，使用 sso sessionid 访问受保护的 "Client01应用" 和 "Client02应用" 提供的接口，接口请求将会被拦截，提示未登录并返回状态码 501（参考代码：TokenClientTest.clientApiRequestTest）
```

### 四、总体设计

### 4.1 架构图

![image-20200721163102450](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE2MzEwMjQ1MC5wbmc)

### 4.2 功能定位

XXL-SSO 是一个分布式单点登录框架。只需要登录一次就可以访问所有相互信任的应用系统。

借助 XXL-SSO，可以快速实现分布式系统单点登录。

### 4.3 核心概念

| 概念          | 说明                                       |
| :------------ | :----------------------------------------- |
| SSO Server    | 中央认证服务，支持集群                     |
| SSO Client    | 接入SSO认证中心的Client应用                |
| SSO SessionId | 登录用户会话ID，SSO 登录成功为用户自动分配 |
| SSO User      | 登录用户信息，与 SSO SessionId 相对应      |

### 4.4 登录流程剖析

- 用户于Client端应用访问受限资源时，将会自动 redirect 到 SSO Server 进入统一登录界面
- 用户登录成功之后将会为用户分配 SSO SessionId 并 redirect 返回来源Client端应用，同时附带分配的 SSO SessionId
- 在Client端的SSO Filter里验证 SSO SessionId 无误，将 SSO SessionId 写入到用户浏览器Client端域名下 cookie 中
- SSO Filter验证 SSO SessionId 通过，受限资源请求放行

### 4.5 注销流程剖析

- 用户与Client端应用请求注销Path时，将会 redirect 到 SSO Server 自动销毁全局 SSO SessionId，实现全局销毁
- 然后，访问接入SSO保护的任意Client端应用时，SSO Filter 均会拦截请求并 redirect 到 SSO Server 的统一登录界面

### 4.6 基于Cookie，相关概念

- 登陆凭证存储：登陆成功后，用户登陆凭证被自动存储在浏览器Cookie中
- Client端校验登陆状态：通过校验请求Cookie中的是否包含用户登录凭证判断
- 系统角色模型：
  - SSO Server：认证中心，提供用户登陆、注销以及登陆状态校验等功能
  - Client应用：受SSO保护的Client端Web应用，为用户浏览器访问提供服务
  - 用户：发起请求的用户，使用浏览器访问

### 4.7 基于Token，相关概念

- 登陆凭证存储：登陆成功后，获取到登录凭证（xxl_sso_sessionid=xxx），需要主动存储，如存储在 localStorage、Sqlite 中
- Client端校验登陆状态：通过校验请求 Header参数 中的是否包含用户登录凭证（xxl_sso_sessionid=xxx）判断；因此，发送请求时需要在 Header参数 中设置登陆凭证
- 系统角色模型：
  - SSO Server：认证中心，提供用户登陆、注销以及登陆状态校验等功能
  - Client应用：受SSO保护的Client端Web应用，为用户请求提供接口服务
  - 用户：发起请求的用户，如使用Android、IOS、桌面客户端等请求访问

### 4.8 未登录状态请求处理

基于Cookie，未登录状态请求：

- 页面请求：redirect 到SSO Server登录界面
- JSON请求：返回未登录的JSON格式响应数据
  - 数据格式：
    - code：501 错误码
    - msg：sso not login.

基于Token，未登录状态请求：

- 返回未登录的JSON格式响应数据
  - 数据格式：
    - code：501 错误码
    - msg：sso not login.

### 4.9 登录态自动延期

支持自定义登录态有效期窗口，默认24H，当登录态有效期窗口过半时，自动顺延一个周期。

### 4.10 记住密码

未记住密码时，关闭浏览器则登录态失效；记住密码时，登录态自动延期，在自定义延期时间的基础上，原则上可以无限延期。

### 4.11 路径排除

自定义路径排除Path，允许设置多个，且支持Ant表达式。用于排除SSO客户端不需要过滤的路径。

测试：

打包

![image-20200721163124845](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE2MzEyNDg0NS5wbmc)

运行：

![image-20200721163202617](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE2MzIwMjYxNy5wbmc)

![image-20200721162248525](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE2MjI0ODUyNS5wbmc)

客户端1：

![image-20200721162642149](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE2MjY0MjE0OS5wbmc)

客户端2：

![image-20200721162724601](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyMTE2MjcyNDYwMS5wbmc)

## 谷粒商城购物车(三十八)

让人感兴趣的就是线程隔离和拦截器一起用，还有一个就是添加购物车后进行重定向。思路的话，就是临时用户和登录用户的那块逻辑不要忘了，实时增加删减购物车都要对redis进行操作。

ThreadLocal可以查看之前的博客：https://www.cnblogs.com/dalianpai/p/12623044.html

具体的代码如下：

```java
/**



 * @author WGR



 * @create 2020/7/22 -- 16:06



 */



public class CartInterceptor implements HandlerInterceptor {



 



    public static ThreadLocal<UserInfoVo> threadLocal = new ThreadLocal<>();



 



    @Override



    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {



        UserInfoVo userInfoVo = new UserInfoVo();



        HttpSession session = request.getSession();



        MemberRespVo memberRespVo = (MemberRespVo) session.getAttribute(AuthServerConstant.LOGIN_USER);



        if(memberRespVo !=null){



            userInfoVo.setUserId(memberRespVo.getId());



        }



 



        Cookie[] cookies = request.getCookies();



        if(cookies !=null && cookies.length>0){



            for (Cookie cookie:cookies){



                String name = cookie.getName();



                if(name.equals(CartConstant.TEMP_USER_COOKIE_NAME)){



                    userInfoVo.setUserKey(cookie.getValue());



                    userInfoVo.setTempUser(true);



                }



            }



        }



 



        if(StringUtils.isBlank(userInfoVo.getUserKey())){



            userInfoVo.setUserKey(UUID.randomUUID().toString());



        }



        threadLocal.set(userInfoVo);



        return true;



    }



 



 



    @Override



    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {



        UserInfoVo userInfoVo = threadLocal.get();



        if(!userInfoVo.isTempUser()){



            Cookie cookie = new Cookie(CartConstant.TEMP_USER_COOKIE_NAME, userInfoVo.getUserKey());



            cookie.setDomain("gulimall.com");



            cookie.setMaxAge(CartConstant.TEMP_USER_COOKIE_TIMEOUT);



            response.addCookie(cookie);



        }



 



    }



}
```

web层

```java
/**



 * @author WGR



 * @create 2020/7/22 -- 16:56



 */



@Controller



public class CartController {



 



    @Autowired



    CartService cartService;



 



    @GetMapping("/deleteItem")



    public String deleteItem(@RequestParam("skuId") Long skuId){



        cartService.deleteItem(skuId);



        return "redirect:http://cart.gulimall.com/cart.html";



    }



 



    @GetMapping("/checkCount")



    public String checkCount(@RequestParam("skuId") Long skuId,@RequestParam("num")Integer num){



        cartService.checkCount(skuId,num);



        return "redirect:http://cart.gulimall.com/cart.html";



    }



 



    @GetMapping("/checkItem")



    public String checkItem(@RequestParam("skuId") Long skuId,@RequestParam("check")Integer check){



        cartService.checkItem(skuId,check);



        return "redirect:http://cart.gulimall.com/cart.html";



    }



 



    @GetMapping("/cart.html")



    public String cartListPage(Model model) throws ExecutionException, InterruptedException {



        UserInfoVo userInfoVo = CartInterceptor.threadLocal.get();



        Cart cart =  cartService.getCart();



        model.addAttribute("cart",cart);



        return "cartList";



    }



 



    @GetMapping("/addToCart")



    public  String addToCart(@RequestParam("skuId") Long skuId, @RequestParam("num") Integer num,



                             RedirectAttributes ra) throws ExecutionException, InterruptedException {



       cartService.addToCart(skuId,num);



        ra.addAttribute("skuId",skuId);



        return "redirect:http://cart.gulimall.com/addToCartSuccess.html";



    }



 



    @GetMapping("/addToCartSuccess.html")



    public String addToCartSuccess(@RequestParam("skuId") Long skuId,Model model){



      CartItem cartItem  = cartService.getCartItem(skuId);



      model.addAttribute("item",cartItem);



      return "success";



    }



 



}
```

service

```java
/**



 * @author WGR



 * @create 2020/7/22 -- 16:56



 */



@Controller



public class CartController {



 



    @Autowired



    CartService cartService;



 



    @GetMapping("/deleteItem")



    public String deleteItem(@RequestParam("skuId") Long skuId){



        cartService.deleteItem(skuId);



        return "redirect:http://cart.gulimall.com/cart.html";



    }



 



    @GetMapping("/checkCount")



    public String checkCount(@RequestParam("skuId") Long skuId,@RequestParam("num")Integer num){



        cartService.checkCount(skuId,num);



        return "redirect:http://cart.gulimall.com/cart.html";



    }



 



    @GetMapping("/checkItem")



    public String checkItem(@RequestParam("skuId") Long skuId,@RequestParam("check")Integer check){



        cartService.checkItem(skuId,check);



        return "redirect:http://cart.gulimall.com/cart.html";



    }



 



    @GetMapping("/cart.html")



    public String cartListPage(Model model) throws ExecutionException, InterruptedException {



        UserInfoVo userInfoVo = CartInterceptor.threadLocal.get();



        Cart cart =  cartService.getCart();



        model.addAttribute("cart",cart);



        return "cartList";



    }



 



    @GetMapping("/addToCart")



    public  String addToCart(@RequestParam("skuId") Long skuId, @RequestParam("num") Integer num,



                             RedirectAttributes ra) throws ExecutionException, InterruptedException {



       cartService.addToCart(skuId,num);



        ra.addAttribute("skuId",skuId);



        return "redirect:http://cart.gulimall.com/addToCartSuccess.html";



    }



 



    @GetMapping("/addToCartSuccess.html")



    public String addToCartSuccess(@RequestParam("skuId") Long skuId,Model model){



      CartItem cartItem  = cartService.getCartItem(skuId);



      model.addAttribute("item",cartItem);



      return "success";



    }



 



}
```

效果图如下：

![image-20200724111800600](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDcyNDExMTgwMDYwMC5wbmc)

## 谷粒商城消息队列(三十九)

### 248-260 消息队列

代码提交到:https://gitee.com/dalianpai/gulimall

其实只要看过尚硅谷的springboot视频，就会发现和里面讲解的都是一模一样。

也简单学过别的机构的rabbitmq视频：https://www.cnblogs.com/dalianpai/category/1795311.html

测试代码如下：

```java
@Slf4j



@SpringBootTest



@RunWith(SpringRunner.class)



class GulimallOrderApplicationTests {



 



    @Autowired



    AmqpAdmin amqpAdmin;



 



    @Autowired



    RabbitTemplate rabbitTemplate;



 



    @Test



    public void sendMessageTest(){



        OrderReturnApplyEntity orderReturnApplyEntity = new OrderReturnApplyEntity();



        orderReturnApplyEntity.setId(1L);



        orderReturnApplyEntity.setCreateTime(new Date());



        orderReturnApplyEntity.setSkuName("wgr");



        rabbitTemplate.convertAndSend("hello-java-exchange","hello-java",orderReturnApplyEntity);



    }



 



 



    @Test



    public void createExchange(){



        DirectExchange directExchange = new DirectExchange("hello-java-exchange", true, false);



        amqpAdmin.declareExchange(directExchange);



        log.info("交换机创建成功");



 



    }



 



    @Test



    public void createQueue(){



        Queue queue = new Queue("hello-java-queue", true, false, false);



        amqpAdmin.declareQueue(queue);



        log.info("队列创建成功");



    }



 



    @Test



    public void createBing(){



        Binding binding = new Binding("hello-java-queue", Binding.DestinationType.QUEUE, "hello-java-exchange"



                , "hello-java", null);



        amqpAdmin.declareBinding(binding);



    }



 



}
```

接受类：

```java
@RabbitListener(queues={"hello-java-queue"})



@Service("orderItemService")



public class OrderItemServiceImpl extends ServiceImpl<OrderItemDao, OrderItemEntity> implements OrderItemService {



 



    @Override



    public PageUtils queryPage(Map<String, Object> params) {



        IPage<OrderItemEntity> page = this.page(



                new Query<OrderItemEntity>().getPage(params),



                new QueryWrapper<OrderItemEntity>()



        );



 



        return new PageUtils(page);



    }



 



    @RabbitHandler



    public void recieveMessage(Message message,



                               OrderReturnApplyEntity content,



                               Channel channel){



        System.out.println("接受的消息。。"+content);



        System.out.println(content.getSkuName());



        //channel内按顺序自增的



        long deliveryTag = message.getMessageProperties().getDeliveryTag();



        System.out.println("deliveryTag==>"+deliveryTag);



        //签收



        try {



            channel.basicAck(deliveryTag,false);



        } catch (IOException e) {



            e.printStackTrace();



        }



 



    }



 



}
```

配置类:

```java
/**



 * @author WGR



 * @create 2020/7/27 -- 13:15



 */



@Slf4j



@Configuration



public class MyRabbitConfig {



    @Autowired



    RabbitTemplate rabbitTemplate;



 



    @Bean



    public MessageConverter messageConverter(){



        return new Jackson2JsonMessageConverter();



    }



 



    /**



     *定制RabbitTemplate



     * 1.服务收到消息就回调



     *    1）spring.rabbitmq.publisher-confirms=true



     *    2)设置确认回调confirmCallback



     * 2.消息正确抵达队列进行回调



     *    1）spring.rabbitmq.publisher-returns=true



     *    2) spring.rabbitmq.template.mandatory=true



     *    设置确认回调ReturnCallback



     * 3.消费端确认（保证每个消费被正确消费，此时才可以broker删除这个消息）



     *    1）默认是自动确认的，只要消息接收到，客户端会自动确认，服务端就会移除这个消息



     *       问题：



     *           我们收到很多消息，自动回复服务器ack，只有一个消息处理成功，宕机了，就会发生消息丢失。



     *           消费者手动确认模式，只要我们没有明确告诉MQ，货物被签收，没有ACK



     *           消息就一直是unacked状态，即使Consumer宕机。消息不会丢失，会重新变成ready



     *   2)如何签收：



     *      channel.basicAck(deliveryTag,false);签收获取



     *      channel.basicNack(deliveryTag,false,true);拒签



     *



     */



 



    @PostConstruct   //再配置类对象创建完成以后，执行这个方法



    public void initRabbitTemplate(){



        RabbitTemplate.ConfirmCallback confirmCallback = new RabbitTemplate.ConfirmCallback() {



            @Override



            public void confirm(CorrelationData correlationData, boolean ack, String cause) {



                if (ack){



                    System.out.println("发送成功");



                }else {



                    System.out.println("发送失败");



                }



            }



        };



        rabbitTemplate.setConfirmCallback(confirmCallback);



 



        rabbitTemplate.setReturnCallback(new RabbitTemplate.ReturnCallback() {



            @Override



            public void returnedMessage(Message message, int replyCode, String replyText, String exchange, String routingKey) {



                System.out.println(message);



                System.out.println(replyCode);



                System.out.println(replyText);



            }



        });



    }



 



 



}
```

发送消息:

```java
/**



 * @author WGR



 * @create 2020/7/27 -- 14:47



 */



@RestController



public class RabbitController {



 



    @Autowired



    RabbitTemplate rabbitTemplate;



 



    @RequestMapping("sendMq")



    public String sendMq(){



        OrderReturnApplyEntity orderReturnApplyEntity = new OrderReturnApplyEntity();



        orderReturnApplyEntity.setId(1L);



        orderReturnApplyEntity.setCreateTime(new Date());



        orderReturnApplyEntity.setSkuName("wgr");



        rabbitTemplate.convertAndSend("hello-java-exchange","hello-java",orderReturnApplyEntity);



        return  "ok";



    }



 



}
```

### 课件的几个图

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDgvMTgyOTc4NS0yMDIwMDgwMzE3NDk0MTA1OS0xNDI5MjQ0OTYucG5n)
![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDgvMTgyOTc4NS0yMDIwMDgwMzE3NTIxNzU1OS04NDIyNDA4MjcucG5n)
![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDgvMTgyOTc4NS0yMDIwMDgwMzE3NTIzMTY1Mi02OTk0NjU4MTYucG5n)
![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDgvMTgyOTc4NS0yMDIwMDgwMzE3NTI0Mjk3MC0xMDE3MTA4ODYucG5n)

## 谷粒商城订单服务(四十)

261-284 订单服务

代码提交到码云：https://gitee.com/dalianpai/gulimall

感觉订单服务业务逻辑还是比较复杂的，改html改的头皮发麻。

上个星期写的，没有时间简单的记录一下，让人感觉有点意思的也就Feign的请求头丢失的问题。

ThreadLocal可以查看之前的博客：https://www.cnblogs.com/dalianpai/p/12623044.html

```java
/**



 * @author WGR



 * @create 2020/7/27 -- 21:52



 */



@Component



public class LoginUserInterceptor implements HandlerInterceptor {



 



    public static ThreadLocal<MemberRespVo> loginUser = new ThreadLocal<>();



 



    @Override



    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {



        MemberRespVo attribute = (MemberRespVo)request.getSession().getAttribute(AuthServerConstant.LOGIN_USER);



        if(attribute !=null){



            loginUser.set(attribute);



            return true;



        }else{



            request.getSession().setAttribute("msg","请先进行登录");



            response.sendRedirect("http://auth.gulimall.com/login.html");



            return false;



        }



    }



}
```

Feign的请求头丢失的问题:https://www.cnblogs.com/dalianpai/p/12426425.html

```java
/**



 * @author WGR



 * @create 2020/7/28 -- 16:01



 */



@Configuration



public class GuliFeignConfig {



 



    @Bean("requestInterceptor")



    public RequestInterceptor requestInterceptor(){



        return new RequestInterceptor() {



            @Override



            public void apply(RequestTemplate requestTemplate) {



                ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();



                if(attributes !=null){



                    HttpServletRequest request = attributes.getRequest();



                    if(request !=null){



                        requestTemplate.header("Cookie", request.getHeader("Cookie"));



                    }



 



                }



            }



        };



    }



}
```

业务逻辑：

```java
/**



 * @author WGR



 * @create 2020/7/27 -- 22:05



 */



@Controller



public class OrderWenController {



 



    @Autowired



    OrderService orderService;



 



    @GetMapping("/toTrade")



    public String toTrade(Model model) throws ExecutionException, InterruptedException {



 



        OrderConfirmVo confirmVo =  orderService.confirmOrder();



 



        model.addAttribute("orderConfirmData",confirmVo);



        return "confirm";



    }



 



    @PostMapping("/submitOrder")



    public String submitOrder(OrderSubmitVo vo, Model model, RedirectAttributes redirectAttributes){



     System.out.println("订单提交的数据。。。"+vo);



     SubmitOrderResponseVo responseVo = orderService.submitOrder(vo);



     if(responseVo.getCode() ==0){



         System.out.println(responseVo);



         model.addAttribute("submitOrderResp",responseVo);



         return "pay";



     }else{



         String msg="下单失败：";



         switch (responseVo.getCode()){



             case 1: msg += "订单信息过期，请刷新再次提交";break;



             case 2: msg += "订单商品价格发生变化，请确认后再次提交";break;



             case 3: msg += "库存锁定失败，商品库存不足";break;



         }



         redirectAttributes.addFlashAttribute("msg",msg);



         return "redirect:http://order.gulimall.com/toTrade";



     }



    }



}
@Service("orderService")



public class OrderServiceImpl extends ServiceImpl<OrderDao, OrderEntity> implements OrderService {



 



    private ThreadLocal<OrderSubmitVo> confirmVoThreadLocal = new ThreadLocal<>();



    @Autowired



    MemberFeignService memberFeignService;



 



    @Autowired



    OrderItemService orderItemService;



 



    @Autowired(required = false)



    OrderDao orderDao;



 



    @Autowired(required = false)



    OrderItemDao orderItemDao;



 



    @Autowired



    CartFeignService cartFeignService;



 



    @Autowired



    WmsFeignService wmsFeignService;



 



    @Autowired



    StringRedisTemplate redisTemplate;



 



    @Autowired



    ThreadPoolExecutor executor;



 



    @Autowired



    ProductFeignService productFeignService;



 



    @Override



    public PageUtils queryPage(Map<String, Object> params) {



        IPage<OrderEntity> page = this.page(



                new Query<OrderEntity>().getPage(params),



                new QueryWrapper<OrderEntity>()



        );



 



        return new PageUtils(page);



    }



 



    @Override



    public OrderConfirmVo confirmOrder() throws ExecutionException, InterruptedException {



        OrderConfirmVo orderConfirmVo = new OrderConfirmVo();



        MemberRespVo memberRespVo = LoginUserInterceptor.loginUser.get();



        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();



        //1.远程查询所有的收货地址列表



        CompletableFuture<Void> getCompletableFuture = CompletableFuture.runAsync(() -> {



            RequestContextHolder.setRequestAttributes(requestAttributes);



            List<MemberReceiveAddressEntity> address = memberFeignService.getAddress(memberRespVo.getId());



            System.out.println(address);



            orderConfirmVo.setAddress(address);



        }, executor);



 



        //2.远程查询购物车所有选中的购物项



        CompletableFuture<Void> completableFuture = CompletableFuture.runAsync(() -> {



            RequestContextHolder.setRequestAttributes(requestAttributes);



            List<CartItem> items = cartFeignService.getCurrentUserCartItems();



            orderConfirmVo.setItems(items);



        }, executor).thenRunAsync( () ->{



            List<CartItem> items = orderConfirmVo.getItems();



            List<Long> collect = items.stream().map(item -> item.getSkuId()).collect(Collectors.toList());



 



            R hasStock = wmsFeignService.getSkusHasStock(collect);



            List<SkuHasStockVo> data = hasStock.getData(new TypeReference<List<SkuHasStockVo>>() {



            });



            if(data !=null){



                Map<Long, Boolean> map = data.stream().collect(Collectors.toMap(SkuHasStockVo::getSkuId, SkuHasStockVo::getHasStock));



                orderConfirmVo.setStocks(map);



            }



        },executor);



 



        //3.查询用户积分



        Integer integration = memberRespVo.getIntegration();



        orderConfirmVo.setIntegration(integration);



 



        //5 防重令牌



        String token = UUID.randomUUID().toString().replace("-", "");



        System.out.println(OrderConstant.USER_ORDER_TOKEN_PREFIX+memberRespVo.getId());



        redisTemplate.opsForValue().set(OrderConstant.USER_ORDER_TOKEN_PREFIX+memberRespVo.getId(),token,30, TimeUnit.MINUTES);



        orderConfirmVo.setOrderToken(token);



        CompletableFuture.allOf(completableFuture,getCompletableFuture).get();



        return orderConfirmVo;



    }



 



    @GlobalTransactional



    @Transactional



    @Override



    public SubmitOrderResponseVo submitOrder(OrderSubmitVo vo) {



        confirmVoThreadLocal.set(vo);



 



        SubmitOrderResponseVo responseVo = new SubmitOrderResponseVo();



        responseVo.setCode(0);



        MemberRespVo memberRespVo = LoginUserInterceptor.loginUser.get();



        String script = "if redis.call('get',KEYS[1]) == ARGV[1] then return redis.call('del',KEYS[1]) else return 0 end";



        String orderToken = vo.getOrderToken();



        Long result = redisTemplate.execute(new DefaultRedisScript<Long>(script,Long.class), Arrays.asList(OrderConstant.USER_ORDER_TOKEN_PREFIX+memberRespVo.getId() ),orderToken);



        if(result ==0L){



            responseVo.setCode(1);



           return responseVo;



        }else{



            //令牌验证成功



            //下单： 去创建订单，验证令牌，验价格，锁库存



            OrderCreateTo order = createOrder();



            //2. 验价



            BigDecimal payAmount = order.getOrder().getPayAmount();



            BigDecimal payPrice = vo.getPayPrice();



            if(Math.abs(payAmount.subtract(payPrice).doubleValue())<0.01){



                //3 保存订单



                saveOrder(order);



                //4 库存锁定



                WareSkuLockVo lockVo = new WareSkuLockVo();



                lockVo.setOrderSn(order.getOrder().getOrderSn());



                List<CartItem> locks = order.getOrderItems().stream().map(item -> {



                    CartItem itemVo = new CartItem();



                    itemVo.setSkuId(item.getSkuId());



                    itemVo.setCount(item.getSkuQuantity());



                    itemVo.setTitle(item.getSkuName());



                    return itemVo;



                }).collect(Collectors.toList());



                lockVo.setLocks(locks);



                R r = wmsFeignService.orderLockStock(lockVo);



                if(r.getCode() == 0){



                    //锁定成功



                    responseVo.setOrder(order.getOrder());



                 //  int i = 1/0;



                    return responseVo;



                }else{



                    //锁定失败



                    responseVo.setCode(3);



                    return responseVo;



                }



            }else{



                responseVo.setCode(2);



                return responseVo;



            }



        }



    }



 



    @Transactional



    private void saveOrder(OrderCreateTo order) {



        OrderEntity orderEntity = order.getOrder();



        orderEntity.setModifyTime(new Date());



        this.save(orderEntity);



 



        List<OrderItemEntity> orderItems = order.getOrderItems();



        orderItems.forEach(l ->{



            orderItemService.save(l);



        });



     //   orderItemService.saveBatch(orderItems);



    }



 



    private OrderCreateTo createOrder(){



        OrderCreateTo ceateTo = new OrderCreateTo();



        //生成单号



        String orderSn = IdWorker.getTimeId();



        //创建订单号



        OrderEntity entity = buildOrder(orderSn);



        //2 获取到所有的订单项



        List<OrderItemEntity> itemEntities = buildOrderItems();



        //3.计算价格相关



        computePrice(entity,itemEntities);



 



        ceateTo.setOrder(entity);



        ceateTo.setOrderItems(itemEntities);



        return ceateTo;



 



    }



 



    private void computePrice(OrderEntity orderEntity, List<OrderItemEntity> itemEntities) {



        BigDecimal total = new BigDecimal("0.0");



 



        BigDecimal coupon = new BigDecimal("0.0");



        BigDecimal integration = new BigDecimal("0.0");



        BigDecimal promotion = new BigDecimal("0.0");



 



        BigDecimal gift = new BigDecimal("0.0");



        BigDecimal growth = new BigDecimal("0.0");



        for(OrderItemEntity entity:itemEntities){



            coupon = coupon.add(entity.getCouponAmount());



            integration = integration.add(entity.getIntegrationAmount());



            promotion = promotion.add(entity.getPromotionAmount());



            total = total.add(entity.getRealAmount());



            gift = gift.add(new BigDecimal(entity.getGiftIntegration().toString()));



            growth = growth.add(new BigDecimal(entity.getGiftGrowth().toString()));



        }



        orderEntity.setTotalAmount(total);



        orderEntity.setPayAmount(total.add(orderEntity.getFreightAmount()));



        orderEntity.setIntegrationAmount(integration);



        orderEntity.setCouponAmount(coupon);



 



        //设置积分等信息



        orderEntity.setIntegration(gift.intValue());



        orderEntity.setGrowth(growth.intValue());



        orderEntity.setDeleteStatus(0);



    }



 



    private OrderEntity buildOrder(String orderSn) {



        MemberRespVo respVo = LoginUserInterceptor.loginUser.get();



        OrderEntity entity = new OrderEntity();



        entity.setOrderSn(orderSn);



        entity.setMemberId(respVo.getId());



 



        OrderSubmitVo submitVo = confirmVoThreadLocal.get();



        //获取地址的收货信息



        R fare = wmsFeignService.getFare(submitVo.getAddrId());



        FareVo fareResp = fare.getData(new TypeReference<FareVo>() {



        });



        entity.setFreightAmount(fareResp.getFare());



        entity.setReceiverCity(fareResp.getAddress().getCity());



        entity.setReceiverDetailAddress(fareResp.getAddress().getDetailAddress());



        entity.setReceiverName(fareResp.getAddress().getName());



        entity.setReceiverPhone(fareResp.getAddress().getPhone());



        entity.setReceiverPostCode(fareResp.getAddress().getPostCode());



        entity.setReceiverProvince(fareResp.getAddress().getProvince());



        entity.setReceiverRegion(fareResp.getAddress().getRegion());



 



        //设置订单的相关状态信息



        entity.setStatus(1);



        entity.setAutoConfirmDay(7);



        return entity;



    }



 



    /**



     * 构建所有订单项数据



     */



    private List<OrderItemEntity> buildOrderItems(){



        List<CartItem> currentUserCartItems = cartFeignService.getCurrentUserCartItems();



        if(currentUserCartItems !=null && currentUserCartItems.size()>0){



            List<OrderItemEntity> itemEntities = currentUserCartItems.stream().map(cartItem ->{



                OrderItemEntity itemEntity =buildOrderItem(cartItem);



                return itemEntity;



            }).collect(Collectors.toList());



            return itemEntities;



        }



        return null ;



    }



 



    private OrderItemEntity buildOrderItem(CartItem cartItem) {



        OrderItemEntity itemEntity = new OrderItemEntity();



        Long skuId = cartItem.getSkuId();



 



        R r = productFeignService.getSpuInfoBySkuId(skuId);



        SpuInfoVo data = r.getData(new TypeReference<SpuInfoVo>() {



        });



        itemEntity.setSpuId(data.getId());



        itemEntity.setSpuBrand(data.getBrandId().toString());



        itemEntity.setSpuName(data.getSpuName());



        itemEntity.setCategoryId(data.getCatalogId());



        //3.商品的sku信息



        itemEntity.setSkuId(cartItem.getSkuId());



        itemEntity.setSkuName(cartItem.getTitle());



        itemEntity.setSkuPic(cartItem.getImages());



        itemEntity.setSkuPrice(cartItem.getPrice());



        String skuAttr = StringUtils.collectionToDelimitedString(cartItem.getSkuAttr(), ";");



        itemEntity.setSkuAttrsVals(skuAttr);



        itemEntity.setSkuQuantity(cartItem.getCount());



 



        //5.积分信息



        itemEntity.setGiftGrowth(cartItem.getPrice().multiply(new BigDecimal(cartItem.getCount().toString())).intValue());



        itemEntity.setGiftIntegration(cartItem.getPrice().multiply(new BigDecimal(cartItem.getCount().toString())).intValue());



 



        //6.订单项的价格信息



        itemEntity.setPromotionAmount(new BigDecimal("0"));



        itemEntity.setCouponAmount(new BigDecimal("0"));



        itemEntity.setIntegrationAmount(new BigDecimal("0"));



        //当前订单项的实际金额。总额-各种优惠



        BigDecimal orign = itemEntity.getSkuPrice().multiply(new BigDecimal(itemEntity.getSkuQuantity().toString()));



        BigDecimal subtract = orign.subtract(itemEntity.getCouponAmount())



                .subtract(itemEntity.getPromotionAmount())



                .subtract(itemEntity.getIntegrationAmount());



        itemEntity.setRealAmount(subtract);



        return itemEntity;



    }



 



}
```

锁库存的服务：

```java
@Override



    public List<SkuHasStockVo> getSkusHasStock(List<Long> skuIds) {



        List<SkuHasStockVo> hasStockVoList = skuIds.stream().map(id -> {



            SkuHasStockVo vo = new SkuHasStockVo();



            Long count = baseMapper.getSkuStock(id);



            vo.setSkuId(id);



            vo.setHasStock(count ==null ?false:count > 0);



            return vo;



        }).collect(Collectors.toList());



        return hasStockVoList;



    }



 



    @Transactional



    @Override



    public Boolean orderLockStock(WareSkuLockVo vo) {



        //1. 找到每个商品在哪个仓库都有库存



        List<CartItem> locks = vo.getLocks();



        List<SkuWareHasStock> collect = locks.stream().map(item -> {



            SkuWareHasStock stock = new SkuWareHasStock();



            Long skuId = item.getSkuId();



            stock.setSkuId(skuId);



            stock.setNum(item.getCount());



            //查询这个商品在哪里有库存



            List<Long> wareIds = wareSkuDao.listWareIdHasSkuStock(skuId);



            stock.setWareId(wareIds);



            return stock;



        }).collect(Collectors.toList());



 



        //2. 锁定库存



        for(SkuWareHasStock hasStock:collect){



            Boolean skuStocked = false;



            Long skuId = hasStock.getSkuId();



            List<Long> wareIds = hasStock.getWareId();



            if(wareIds == null || wareIds.size() ==0){



                throw new RRException(skuId+"不存在");



            }



            for (Long wareId : wareIds){



                //成功就是1，失败就是0



                Long count = wareSkuDao.lockSkuStock(skuId, wareId, hasStock.getNum());



                if(count == 1){



                    skuStocked = true;



                    break;



                }else{



                    //当前仓库锁失败，重试下一个仓库



                }



 



            }



 



            if(skuStocked == false){



                throw new RRException(skuId+"不存在");



            }



        }



 



        return true;



    }



 



    @Data



    class SkuWareHasStock{



        private Long skuId;



        private List<Long> wareId;



        private Integer num;



    }
```

注意演示的时候把feign的超时时间都改大点，不然老是报错，就很烦

```yaml
feign:



  client:



    config:



      gulimall-ware:



        readTimeout: 12000



        connectTimeout: 12000



        loggerLevel: FULL



      gulimall-member:



        readTimeout: 12000



        connectTimeout: 12000



        loggerLevel: FULL



      gulimall-product:



        readTimeout: 12000



        connectTimeout: 12000



        loggerLevel: FULL



      gulimall-cart:



        readTimeout: 12000



        connectTimeout: 12000



        loggerLevel: FULL
```

演示如下：

![img](img/aHR0cHM6Ly9pbWcyMDIwLmNuYmxvZ3MuY29tL2Jsb2cvMTgyOTc4NS8yMDIwMDgvMTgyOTc4NS0yMDIwMDgwNjEwMTkxODA1OS0xNTI1OTgyODg5LmdpZg)

## 谷粒商城模拟关单(四十一)

291-292

下面主要是视频中课件的截图，之前学rabbitmq的时候，这些还没有学，后面学了在做一个笔记

![image-20200806141059460](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNjE0MTA1OTQ2MC5wbmc) ![image-20200806141124251](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNjE0MTEyNDI1MS5wbmc) ![image-20200806140943209](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNjE0MDk0MzIwOS5wbmc) ![image-20200806141336950](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNjE0MTMzNjk1MC5wbmc) ![image-20200806141527764](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNjE0MTUyNzc2NC5wbmc) ![image-20200806141806878](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNjE0MTgwNjg3OC5wbmc) ![image-20200806142004207](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNjE0MjAwNDIwNy5wbmc)

代码：

```java
/**



 * @author WGR



 * @create 2020/8/6 -- 14:46



 */



@Configuration



public class MyMQConfig {



 



    @SneakyThrows



    @RabbitListener(queues = "order.release.order.queue")



    public void listener(OrderEntity entity, Channel channel,Message message){



        System.out.println("收到消息"+entity.getOrderSn());



        channel.basicAck(message.getMessageProperties().getDeliveryTag(),false);



    }



 



    //声明队列



    @Bean("orderDelayQueue")



    public Queue orderDelayQueue(){



        Map<String,Object> arguments = new HashMap<>();



        arguments.put("x-dead-letter-exchange","order-event-exchange");



        arguments.put("x-dead-letter-routing-key","order.release.order");



        arguments.put("x-message-ttl",60000);



 



        //谷粒视频中是new出来的，这个相当于封装了一下，用起来更方便



        return QueueBuilder.durable("order.delay.queue").withArguments(arguments).build();



    }



 



    @Bean("orderReleaseOrderQueue")



    public Queue orderReleaseOrderQueue(){



        return QueueBuilder.durable("order.release.order.queue").build();



    }



 



    @Bean("orderEventExchange")



    public Exchange orderEventExchange(){



        return ExchangeBuilder.topicExchange("order-event-exchange").durable(true).build();



    }



 



    //绑定队列和交换机



    @Bean



    public Binding bingOrderDelayQueue(@Qualifier("orderDelayQueue") Queue queue,



                                     @Qualifier("orderEventExchange") Exchange exchange){



        return BindingBuilder.bind(queue).to(exchange)



                .with("order.create.order").noargs();



    }



 



    //绑定队列和交换机



    @Bean



    public Binding bingOrderReleaseOrderQueue(@Qualifier("orderReleaseOrderQueue") Queue queue,



                                     @Qualifier("orderEventExchange") Exchange exchange){



        return BindingBuilder.bind(queue).to(exchange)



                .with("order.release.order").noargs();



    }



 



 



}



 



 



//测试方法



 



    @ResponseBody



    @GetMapping("/test/createOrder")



    public String createOrderTest(){



        OrderEntity entity = new OrderEntity();



        entity.setOrderSn(UUID.randomUUID().toString());



        entity.setModifyTime(new Date());



        rabbitTemplate.convertAndSend("order-event-exchange","order.create.order",entity);



        return "ok";



    }
```

演示的效果：

![image-20200806153746007](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNjE1Mzc0NjAwNy5wbmc) ![image-20200806153900644](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNjE1MzkwMDY0NC5wbmc)

## 谷粒商城Seata(四十二)

283-289

这章节主要讲的就是seata及一些分布式事务的概念。

之前的博客也有写过，可以查看：https://www.cnblogs.com/dalianpai/category/1591258.html

不过用的方式还是不太一样，其中就包括数据源的创建和一些配置文件，还有当和mybatisplus整合的时候，我本地是报错的。

主要的配置：

```java
/**



 * @author WGR



 * @create 2020/8/5 -- 21:48



 */



@Configuration



public class MySeataConfig {



 



    @Autowired



    DataSourceProperties dataSourceProperties;



 



    @Bean



    public DataSource dataSource(DataSourceProperties dataSourceProperties){



        HikariDataSource dataSource = dataSourceProperties.initializeDataSourceBuilder().type(HikariDataSource.class).build();



        if(StringUtils.hasText(dataSourceProperties.getName())){



            dataSource.setPoolName(dataSourceProperties.getName());



        }



        return new DataSourceProxy(dataSource);



    }



 



}
```

然后在配置文件都要放一份在项目中。

![image-20200805225343607](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNTIyNTM0MzYwNy5wbmc)

服务端的开启：

```bash
[root@database conf]# cd ../bin/



[root@database bin]# ll



total 8



-rw-r--r-- 1  502 games 3180 Jul 15  2019 seata-server.bat



-rwxr-xr-x 1  502 games 3709 Jul 15  2019 seata-server.sh



drwxr-xr-x 2 root root    23 Aug  5 09:16 sessionStore



[root@database bin]# nohup sh seata-server.sh &> /dev/null &



[1] 4646



[root@database bin]# netstat -nltp



Active Internet connections (only servers)



Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name



tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1049/sshd



tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1223/master



tcp6       0      0 :::6379                 :::*                    LISTEN      1722/docker-proxy



tcp6       0      0 :::22                   :::*                    LISTEN      1049/sshd



tcp6       0      0 ::1:25                  :::*                    LISTEN      1223/master



tcp6       0      0 :::8091                 :::*                    LISTEN      4646/java



tcp6       0      0 :::3306                 :::*                    LISTEN      1734/docker-proxy
```

当开始测试的时候，批量插入就直接报错，修改for循环就可以了。

![image-20200805225552809](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNTIyNTU1MjgwOS5wbmc)

![image-20200805232925770](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNTIzMjkyNTc3MC5wbmc)

发现他有一个判断，当在全局事务中，为批量插入的话，就有异常

![image-20200806002200019](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgwNjAwMjIwMDAxOS5wbmc)

## 谷粒商城订单服务二(四十三)

### 293-299

代码提交到码云：https://gitee.com/dalianpai/gulimall

个人感觉这几章有点东西，还是第一次系统的接触到rabbitmq的这些应用。之前学的rabbitmq专题视频，正好是这些概念，等有时间去学完，还有几节没有看完，同时也在等尚硅古的rabbitmq视频。

代码具体如下：

订单服务：

```java
/**



 * @author WGR



 * @create 2020/8/6 -- 14:46



 */



@Configuration



public class MyMQConfig {



 



//    @SneakyThrows



//    @RabbitListener(queues = "order.release.order.queue")



//    public void listener(OrderEntity entity, Channel channel,Message message){



//        System.out.println("收到消息"+entity.getOrderSn());



//        channel.basicAck(message.getMessageProperties().getDeliveryTag(),false);



//    }



 



    //声明队列



    @Bean("orderDelayQueue")



    public Queue orderDelayQueue(){



        Map<String,Object> arguments = new HashMap<>();



        arguments.put("x-dead-letter-exchange","order-event-exchange");



        arguments.put("x-dead-letter-routing-key","order.release.order");



        arguments.put("x-message-ttl",60000);



 



        //谷粒视频中是new出来的，这个相当于封装了一下，用起来更方便



        return QueueBuilder.durable("order.delay.queue").withArguments(arguments).build();



    }



 



    @Bean("orderReleaseOrderQueue")



    public Queue orderReleaseOrderQueue(){



        return QueueBuilder.durable("order.release.order.queue").build();



    }



 



    @Bean("orderEventExchange")



    public Exchange orderEventExchange(){



        return ExchangeBuilder.topicExchange("order-event-exchange").durable(true).build();



    }



 



    //绑定队列和交换机



    @Bean



    public Binding bingOrderDelayQueue(@Qualifier("orderDelayQueue") Queue queue,



                                     @Qualifier("orderEventExchange") Exchange exchange){



        return BindingBuilder.bind(queue).to(exchange)



                .with("order.create.order").noargs();



    }



 



    //绑定队列和交换机



    @Bean



    public Binding bingOrderReleaseOrderQueue(@Qualifier("orderReleaseOrderQueue") Queue queue,



                                              @Qualifier("orderEventExchange") Exchange exchange){



        return BindingBuilder.bind(queue).to(exchange)



                .with("order.release.order").noargs();



    }



 



    //绑定队列和交换机



    @Bean



    public Binding bingOrderReleaseOtherBinding(){



        return new Binding("stock.release.stock.queue",Binding.DestinationType.QUEUE,



                "order-event-exchange","order.release.other.#",null);



    }



}
```

监听服务：

```java
/**



 * @author WGR



 * @create 2020/8/10 -- 19:53



 */



@RabbitListener(queues = "order.release.order.queue")



@Service



public class OrderCloseListener {



 



    @Autowired



    OrderService orderService;



 



    @SneakyThrows



    @RabbitHandler



    public void listener(OrderEntity entity, Channel channel, Message message){



        System.out.println("收到消息,准备关单"+entity.getOrderSn());



 



        try {



            orderService.closeOrder(entity);



            channel.basicAck(message.getMessageProperties().getDeliveryTag(),false);



        } catch (IOException e) {



            channel.basicReject(message.getMessageProperties().getDeliveryTag(),true);



        }



    }



 



}
@Override



    public void closeOrder(OrderEntity entity) {



        OrderEntity orderEntity = this.getById(entity.getId());



        if(orderEntity.getStatus() == OrderStatusEnum.CREATE_NEW.getCode()){



            OrderEntity update = new  OrderEntity();



            update.setId(entity.getId());



            update.setStatus(OrderStatusEnum.CANCLED.getCode());



            this.updateById(update);



 



            OrderTo orderTo = new OrderTo();



            BeanUtils.copyProperties(orderEntity,orderTo);



            //立即发送消息



            rabbitTemplate.convertAndSend("order-event-exchange","order.release.other",orderTo);



        }



 



    }
```

![image-20200810231524479](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgxMDIzMTUyNDQ3OS5wbmc)

库存服务：

```java
/**



 * @author WGR



 * @create 2020/8/6 -- 15:49



 */



@Configuration



public class MyRabbitConfig {



 



 



    @Bean



    public MessageConverter messageConverter(){



        return new Jackson2JsonMessageConverter();



    }



 



    //声明队列



    @Bean("stockDelayQueue")



    public Queue stockDelayQueue(){



        Map<String,Object> arguments = new HashMap<>();



        arguments.put("x-dead-letter-exchange","stock-event-exchange");



        arguments.put("x-dead-letter-routing-key","stock.release");



        arguments.put("x-message-ttl",120000);



 



        //谷粒视频中是new出来的，这个相当于封装了一下，用起来更方便



        return QueueBuilder.durable("stock.delay.queue").withArguments(arguments).build();



    }



 



    @Bean("stockReleaseStockQueue")



    public Queue stockReleaseStockQueue(){



        return QueueBuilder.durable("stock.release.stock.queue").build();



    }



 



    @Bean("stockEventExchange")



    public Exchange stockEventExchange(){



        return ExchangeBuilder.topicExchange("stock-event-exchange").durable(true).build();



    }



 



    //绑定队列和交换机



    @Bean



    public Binding stockLockedBinding(@Qualifier("stockDelayQueue") Queue queue,



                                       @Qualifier("stockEventExchange") Exchange exchange){



        return BindingBuilder.bind(queue).to(exchange)



                .with("stock.locked").noargs();



    }



 



    //绑定队列和交换机



    @Bean



    public Binding stockReleaseBing(@Qualifier("stockReleaseStockQueue") Queue queue,



                                              @Qualifier("stockEventExchange") Exchange exchange){



        return BindingBuilder.bind(queue).to(exchange)



                .with("stock.release.#").noargs();



    }



}
```

监听类：

```java
/**



 * @author WGR



 * @create 2020/8/6 -- 20:54



 */



@Service



@RabbitListener(queues = "stock.release.stock.queue")



public class StockReleaseListener {



 



    @Autowired



    WareSkuService wareSkuService;



 



    @SneakyThrows



    @RabbitHandler



    public void handleStockLockedRelease(StockLockedTo to, Message message, Channel channel){



        System.out.println("收到解锁库存的消息");



        try{



            //当前消息是否被第二次及以后发送过来的



            message.getMessageProperties().getRedelivered()



 



            wareSkuService.unLockStock(to);



            channel.basicAck(message.getMessageProperties().getDeliveryTag(),false);



        }catch (Exception e){



            channel.basicReject(message.getMessageProperties().getDeliveryTag(),true);



        }



    }



 



    @SneakyThrows



    @RabbitHandler



    public void handleStockOrderRelease(OrderTo to, Message message, Channel channel){



        System.out.println("订单关闭准备解锁库存。。。。");



        try{



            wareSkuService.unLockStock(to);



            channel.basicAck(message.getMessageProperties().getDeliveryTag(),false);



        }catch (Exception e){



            channel.basicReject(message.getMessageProperties().getDeliveryTag(),true);



        }



    }



}
```

![image-20200810231817636](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgxMDIzMTgxNzYzNi5wbmc)

课件的截图：

![image-20200810214301117](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgxMDIxNDMwMTExNy5wbmc) ![image-20200810214330651](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgxMDIxNDMzMDY1MS5wbmc)

消息的常见问题：

![image-20200810222531358](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgxMDIyMjUzMTM1OC5wbmc) ![image-20200810224704296](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgxMDIyNDcwNDI5Ni5wbmc) ![image-20200810225210232](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgxMDIyNTIxMDIzMi5wbmc)

## 谷粒商城支付宝沙箱环境(四十四)

### 300-303 支付宝的沙箱环境

主要就是内网穿透，视频中买的代理，我用的阿里云+frp，主要手里阿里云太多，之前试过远程连接，没有试过端口的，博客也写过，可以看：

https://www.cnblogs.com/dalianpai/p/12846270.html

![image-20200811225707172](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgxMTIyNTcwNzE3Mi5wbmc)

客户端进行运行exe

![image-20200811225728576](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgxMTIyNTcyODU3Ni5wbmc)

![image-20200811225804643](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgxMTIyNTgwNDY0My5wbmc)

支付宝的沙箱环境和文档可以直接看官网，如下是公钥的生成。

#### 第一步：生成密钥并上传

支付宝开放平台开发助手提供了一键生成密钥功能，便于开发者生成一对 RSA 密钥（应用公钥、应用私钥）以及公钥证书申请 CSR 文件（在线申请应用公钥证书需要）。加密过程：使用公钥（public key）为系统进行加密，并将密文发送给解密者，解密者使用私钥（private key）解密将密文解码为明文。公钥证书模式中上传的文件，无论是 CSR 文件或者开发者自己申请的公钥证书文件，必须和用户本地代码中加密的应用私钥是匹配的，否则会导致支付宝开放平台验签失败。

支付宝开放平台支持使用 **普通公钥**、**公钥证书** 两种签名方式。下面分别向您介绍两种方式的工具操作步骤，包括如何使用密钥生成工具生成应用公钥（public key）、应用私钥（private key）和公钥证书申请 CSR 文件。

**说明：**

- 应用公钥（public key）需提供给支付宝账号管理者上传到支付宝开放平台。
- 应用私钥（private key）由开发者自己保存，需填写到代码中供签名时使用。
- 生成的私钥需妥善保管，避免遗失，不要泄露。
- 密钥和应用（APPID）一一对应，即开发者需要为名下的每个应用分别设置密钥，且不同应用的密钥不能混用。

##### 工具下载



- [WINDOWS](https://ideservice.alipay.com/ide/getPluginUrl.htm?clientType=assistant&platform=win&channelType=WEB)（windows 版本工具请不要安装在含有空格的目录路径下，否则会导致公私钥乱码的问题）
- [MAC_OSX](https://ideservice.alipay.com/ide/getPluginUrl.htm?clientType=assistant&platform=mac&channelType=WEB)

#### 普通公钥与公钥证书区别

- 企业开发者若涉及资金类支出接口接入，必须使用公钥证书模式。
- 个人开发者不涉及到资金类接口，建议使用公钥方式进行加签。
- 在报文签名场景下，报文接受方使用发送方的公钥进行报文验签，该功能两种签名方式都可以实现。
- 公钥证书签名方式引入了 CA 机构对公钥持有者进行身份识别，保证该证书所属实体的真实性，以实现报文的抗抵赖。
- 公钥证书签名方式下，开放平台支持通过上传 CSR 文件的方式给开发者在线签发应用公钥证书，新的开放平台 RSA 验签和签名工具支持生成 CSR 文件。

#### 前提条件

- 已完成开发者入驻以及实名认证。详情请参见 [个人支付宝账号实名认证指南](https://cshall.alipay.com/lab/cateQuestion.htm?cateId=237666&pcateId=237655)、[企业支付宝账号实名认证指南](https://cshall.alipay.com/enterprise/knowledgeDetail.htm?knowledgeId=201602062427)。
- 已下载密钥生成工具（支付宝开放平台开发助手）。详情请参见 [简介](https://opendocs.alipay.com/open/291/introduce)。

#### 普通公钥方式

下载相应环境工具并安装后即可使用，本步骤指引以 MAC_OSX 界面为例。

![生成.jpg](img/aHR0cHM6Ly9ndy5hbGlwYXlvYmplY3RzLmNvbS96b3Mvc2t5bGFyay10b29scy9wdWJsaWMvZmlsZXMvNWRkZDgxODY5NmFkZTAwYjdkMWVjY2NjNzQyZTVjYzUuanBlZz94LW9zcy1wcm9jZXNzPWltYWdlL3Jlc2l6ZSx3XzIwMDA)

1. 根据开发语言选择密钥格式和密钥长度。

   **说明：**

   - 新建应用请务必使用 RSA2 密钥长度 即 2048 位。详情请参见 [开放平台证书升级指南](https://opendocs.alipay.com/open/291/twngcd)。
   - 目前已使用 RSA 密钥长度即 1024 位密钥长度的应用仍然可以正常调用接口。
   - 接口中的 sign_type 参数应与上传密钥的加签方式一致。例如接口参数中 sign_type=RSA2，请求时就会使用此处设置的 RSA2(SHA256) 公钥验签。

2. 点击 **生成密钥** 后，工具会自动生成商户应用公钥（public key）和应用私钥（private key）。

   ![生成成功.jpg](img/aHR0cHM6Ly9ndy5hbGlwYXlvYmplY3RzLmNvbS96b3Mvc2t5bGFyay10b29scy9wdWJsaWMvZmlsZXMvNDhiNWUwNTM1ZTk0MTkzZjIzMDFkZjE3YTg5ZGQyMjIuanBlZw)

3. 点击工具界面下方的 **打开文件位置**，在 **支付宝开放平台开发助手** 文件夹下选择 **RSA 密钥**，即可找到生成的公私钥文件。

   ![img](img/aHR0cDovL2ltZzAxLnRhb2Jhb2Nkbi5jb20vdG9wL2kxL0xCMWVZWDhPVlhYWFhhaVhYWFhYWFhYWFhYWA)

4. 进入 [支付宝开放平台](https://mini.open.alipay.com/channel/miniIndex.htm) 并打开对应的应用，在应用的开发配置页面进行 **接口加签方式** 设置。点击 **设置** 后，输入手机验证码。 ![image](img/aHR0cDovL21kbi5hbGlwYXlvYmplY3RzLmNvbS9hZnRzL2ltZy9BKmJ1bzZRcXhmallVQUFBQUFBQUFBQUFCa0FhOHdBQS9vcmlnaW5hbD9iej1vcGVucHRfZG9jJnQ9N0QzcjdPTHlMVERPOVp0RlZoSm1KUUFBQUFCa01LOEFBQUFB)

5. 复制上一步生成的公钥，点击 **保存设置**，即可完成公钥的设置。

![image](img/aHR0cDovL21kbi5hbGlwYXlvYmplY3RzLmNvbS9hZnRzL2ltZy9BKlJyVEhRcEd5YzRNQUFBQUFBQUFBQUFCa0FhOHdBQS9vcmlnaW5hbD9iej1vcGVucHRfZG9jJnQ9Y2NMTEdMbHppbFNDNVRjVFlrOXJtd0FBQUFCa01LOEFBQUFB)

![image-20200811225358711](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgxMTIyNTM1ODcxMS5wbmc)

运行页面：

![image-20200811225644316](img/aHR0cHM6Ly90eXBvcmEtb3NzLm9zcy1jbi1iZWlqaW5nLmFsaXl1bmNzLmNvbS9pbWFnZS0yMDIwMDgxMTIyNTY0NDMxNi5wbmc)